<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Qu·∫£n l√Ω R·∫°p</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üé¨ Qu·∫£n l√Ω R·∫°p</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark">Quay l·∫°i</a>
        <button id="btnReload" class="btn btn-outline-secondary">
          T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">Th√™m r·∫°p</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="rapTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 80px">M√£</th>
            <th>T√™n r·∫°p</th>
            <th style="width: 220px">Th√†nh ph·ªë</th>
            <th>ƒê·ªãa ch·ªâ</th>
            <th style="width: 140px">Tr·∫°ng th√°i</th>
            <th style="width: 180px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Add/Edit -->
    <div
      class="modal fade"
      id="rapModal"
      tabindex="-1"
      aria-labelledby="rapModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="rapModalLabel" class="modal-title">Th√™m r·∫°p</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <form id="rapForm">
            <div class="modal-body">
              <input type="hidden" id="MaRap" />
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">T√™n r·∫°p</label>
                  <input
                    id="TenRap"
                    class="form-control"
                    required
                    placeholder="VD: CineMax Th·ªß ƒê·ª©c"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Th√†nh ph·ªë</label>
                  <input
                    id="ThanhPho"
                    class="form-control"
                    required
                    placeholder="Ch·ªçn t·ª´ danh s√°ch 63 t·ªânh/th√†nh"
                  />
                  <div class="form-text">
                    G√µ ƒë·ªÉ t√¨m nhanh. B·∫Øt bu·ªôc ch·ªçn ƒë√∫ng t√™n trong danh s√°ch.
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">ƒê·ªãa ch·ªâ</label>
                  <input
                    id="DiaChi"
                    class="form-control"
                    required
                    placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán"
                  />
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="HoatDong"
                      checked
                    />
                    <label class="form-check-label" for="HoatDong"
                      >ƒêang ho·∫°t ƒë·ªông</label
                    >
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ========= API ph√π h·ª£p controller ========= */
      const BASE_URL = "https://localhost:7058";
      const API = {
        list: `${BASE_URL}/api/rap/get-all`, // GET
        get: (id) => `${BASE_URL}/api/rap/get/${id}`, // GET id
        create: `${BASE_URL}/api/rap/create`, // POST
        update: (id) => `${BASE_URL}/api/rap/update/${id}`, // PUT
        remove: (id) => `${BASE_URL}/api/rap/delete/${id}`, // DELETE
      };
      const token = localStorage.getItem("token");
      const auth = token ? { Authorization: `Bearer ${token}` } : {};

      /* ========= Helpers ========= */
      const $id = (s) => document.getElementById(s);
      const mapRap = (x) => ({
        MaRap: x.MaRap ?? x.maRap,
        TenRap: x.TenRap ?? x.tenRap,
        DiaChi: x.DiaChi ?? x.diaChi,
        ThanhPho: x.ThanhPho ?? x.thanhPho,
        HoatDong: (x.HoatDong ?? x.hoatDong ?? true) === true,
      });

      // 63 t·ªânh/th√†nh + chu·∫©n h√≥a
      const TINH_THANH_VN = [
        "An Giang",
        "B√† R·ªãa - V≈©ng T√†u",
        "B·∫Øc Giang",
        "B·∫Øc K·∫°n",
        "B·∫°c Li√™u",
        "B·∫Øc Ninh",
        "B·∫øn Tre",
        "B√¨nh D∆∞∆°ng",
        "B√¨nh ƒê·ªãnh",
        "B√¨nh Ph∆∞·ªõc",
        "B√¨nh Thu·∫≠n",
        "C√† Mau",
        "C·∫ßn Th∆°",
        "Cao B·∫±ng",
        "ƒê√† N·∫µng",
        "ƒê·∫Øk L·∫Øk",
        "ƒê·∫Øk N√¥ng",
        "ƒêi·ªán Bi√™n",
        "ƒê·ªìng Nai",
        "ƒê·ªìng Th√°p",
        "Gia Lai",
        "H√† Giang",
        "H√† Nam",
        "H√† N·ªôi",
        "H√† Tƒ©nh",
        "H·∫£i D∆∞∆°ng",
        "H·∫£i Ph√≤ng",
        "H·∫≠u Giang",
        "H√≤a B√¨nh",
        "H∆∞ng Y√™n",
        "Ki√™n Giang",
        "Kon Tum",
        "Lai Ch√¢u",
        "L√¢m ƒê·ªìng",
        "L·∫°ng S∆°n",
        "L√†o Cai",
        "Long An",
        "Nam ƒê·ªãnh",
        "Ngh·ªá An",
        "Ninh B√¨nh",
        "Ninh Thu·∫≠n",
        "Ph√∫ Th·ªç",
        "Ph√∫ Y√™n",
        "Qu·∫£ng B√¨nh",
        "Qu·∫£ng Nam",
        "Qu·∫£ng Ng√£i",
        "Qu·∫£ng Ninh",
        "Qu·∫£ng Tr·ªã",
        "S√≥c TrƒÉng",
        "S∆°n La",
        "T√¢y Ninh",
        "Th√°i B√¨nh",
        "Th√°i Nguy√™n",
        "Thanh H√≥a",
        "Th·ª´a Thi√™n Hu·∫ø",
        "Ti·ªÅn Giang",
        "TP. H·ªì Ch√≠ Minh",
        "Tr√† Vinh",
        "Tuy√™n Quang",
        "Vƒ©nh Long",
        "Vƒ©nh Ph√∫c",
        "Y√™n B√°i",
        "Kh√°nh H√≤a",
      ];
      const vnNorm = (s) =>
        (s || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/ƒë/g, "d")
          .replace(/ƒê/g, "D")
          .trim()
          .toLowerCase();
      function canonicalCity(input) {
        const norm = vnNorm(input);
        const hit = TINH_THANH_VN.find((x) => vnNorm(x) === norm);
        if (hit) return hit;
        const starts = TINH_THANH_VN.filter((x) => vnNorm(x).startsWith(norm));
        return starts.length === 1 ? starts[0] : null;
      }
      function attachAutocomplete(input, items) {
        const wrap = document.createElement("div");
        wrap.className = "position-relative";
        input.parentElement.insertBefore(wrap, input);
        wrap.appendChild(input);
        const list = document.createElement("div");
        list.className = "list-group position-absolute w-100";
        list.style.cssText =
          "z-index:1056;max-height:260px;overflow:auto;display:none";
        wrap.appendChild(list);
        function render() {
          const q = vnNorm(input.value);
          const arr = !q
            ? items.slice(0, 10)
            : items.filter((x) => vnNorm(x).includes(q)).slice(0, 10);
          list.innerHTML = arr.length
            ? ""
            : '<div class="list-group-item disabled">Kh√¥ng c√≥ g·ª£i √Ω</div>';
          arr.forEach((name) => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "list-group-item list-group-item-action";
            b.textContent = name;
            b.addEventListener("mousedown", (e) => {
              e.preventDefault();
              input.value = name;
              input.setAttribute("data-selected", "1");
              list.style.display = "none";
            });
            list.appendChild(b);
          });
          list.style.display = "block";
        }
        input.addEventListener("input", () => {
          input.removeAttribute("data-selected");
          render();
        });
        input.addEventListener("focus", render);
        input.addEventListener("blur", () =>
          setTimeout(() => (list.style.display = "none"), 120)
        );
        input.addEventListener("change", () => {
          const c = canonicalCity(input.value);
          if (c) {
            input.value = c;
            input.setAttribute("data-selected", "1");
          }
        });
      }
      attachAutocomplete($id("ThanhPho"), TINH_THANH_VN);

      /* ========= DataTable ========= */
      let dt = null;
      async function loadTable() {
        try {
          const r = await fetch(API.list, { headers: { ...auth } });
          const j = await r.json();
          const list = Array.isArray(j?.data)
            ? j.data
            : Array.isArray(j)
            ? j
            : [];
          const rows = list.map(mapRap);

          if (dt) {
            dt.clear();
            dt.rows.add(rows).draw();
            return;
          }
          dt = $("#rapTable").DataTable({
            data: rows,
            columns: [
              { data: "MaRap" },
              { data: "TenRap" },
              { data: "ThanhPho" },
              { data: "DiaChi" },
              {
                data: "HoatDong",
                render: (v) =>
                  v
                    ? '<span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">ƒêang m·ªü</span>'
                    : '<span class="badge bg-danger-subtle text-danger-emphasis border border-danger-subtle">T·∫°m d·ª´ng</span>',
              },
              {
                data: null,
                orderable: false,
                searchable: false,
                render: (row) => `
              <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.MaRap}">S·ª≠a</button>
                <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${row.MaRap}">X√≥a</button>
              </div>`,
              },
            ],
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
            },
            pageLength: 10,
            responsive: true,
            autoWidth: false,
            order: [[0, "asc"]],
            dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          });
        } catch (e) {
          console.error(e);
          alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch r·∫°p.");
        }
      }

      /* ========= CRUD ========= */
      const bsModal = new bootstrap.Modal(document.getElementById("rapModal"), {
        backdrop: "static",
      });
      function resetForm() {
        $id("rapForm").reset();
        $id("MaRap").value = "";
        $id("HoatDong").checked = true;
        $id("ThanhPho").removeAttribute("data-selected");
      }

      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("rapModalLabel").textContent = "Th√™m r·∫°p";
        bsModal.show();
      });
      $id("btnReload").addEventListener("click", loadTable);

      // Edit / Delete
      $("#rapTable").on("click", "button[data-act]", async function () {
        const act = this.dataset.act;
        const id = this.dataset.id;

        if (act === "edit") {
          const rowData = dt.row($(this).closest("tr")).data();
          if (!rowData) {
            alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu r·∫°p.");
            return;
          }
          const rap = mapRap(rowData);
          $id("MaRap").value = rap.MaRap ?? "";
          $id("TenRap").value = rap.TenRap ?? "";
          $id("DiaChi").value = rap.DiaChi ?? "";
          $id("ThanhPho").value =
            canonicalCity(rap.ThanhPho) || (rap.ThanhPho ?? "");
          $id("HoatDong").checked = !!rap.HoatDong;
          $id("rapModalLabel").textContent = "C·∫≠p nh·∫≠t r·∫°p";
          bsModal.show();
        }

        if (act === "del") {
          if (!confirm(`X√≥a r·∫°p #${id}?`)) return;
          try {
            const res = await fetch(API.remove(id), {
              method: "DELETE",
              headers: { ...auth },
            });
            if (!res.ok) throw new Error("DELETE failed");
            alert("ƒê√£ x√≥a r·∫°p.");
            await loadTable();
          } catch (err) {
            console.error(err);
            alert("X√≥a kh√¥ng th√†nh c√¥ng.");
          }
        }
      });

      // Submit create/update
      $id("rapForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const canonCity = canonicalCity($id("ThanhPho").value);
        if (!canonCity) {
          alert("H√£y ch·ªçn th√†nh ph·ªë t·ª´ danh s√°ch 63 t·ªânh/th√†nh.");
          $id("ThanhPho").focus();
          return;
        }

        const id = $id("MaRap").value.trim();
        const payload = {
          tenRap: $id("TenRap").value.trim(),
          diaChi: $id("DiaChi").value.trim(),
          thanhPho: canonCity,
          hoatDong: $id("HoatDong").checked,
        };

        try {
          let res;
          if (id) {
            res = await fetch(API.update(id), {
              method: "PUT",
              headers: { "Content-Type": "application/json", ...auth },
              body: JSON.stringify({ maRap: Number(id), ...payload }),
            });
          } else {
            res = await fetch(API.create, {
              method: "POST",
              headers: { "Content-Type": "application/json", ...auth },
              body: JSON.stringify(payload),
            });
          }
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || "Request failed");
          }
          alert(id ? "ƒê√£ c·∫≠p nh·∫≠t r·∫°p." : "ƒê√£ t·∫°o r·∫°p m·ªõi.");
          bsModal.hide();
          await loadTable();
        } catch (err) {
          console.error(err);
          alert("L∆∞u kh√¥ng th√†nh c√¥ng.");
        }
      });

      // Boot
      document.addEventListener("DOMContentLoaded", loadTable);
    </script>
  </body>
</html>
