<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω B·∫Øp N∆∞·ªõc</title>

    <!-- Bootstrap + DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .table img.thumb {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }
      .dt-container .row {
        align-items: center;
      }
      .img-preview {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border: 1px solid #e9ecef;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>ü•§ Qu·∫£n l√Ω B·∫Øp N∆∞·ªõc</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="bnTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 80px">ID</th>
            <th>·∫¢nh</th>
            <th>T√™n</th>
            <th style="width: 160px">Gi√°</th>
            <th>M√¥ t·∫£</th>
            <th style="width: 180px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a -->
    <div
      class="modal fade"
      id="bnModal"
      tabindex="-1"
      aria-labelledby="bnModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="bnModalLabel" class="modal-title">Th√™m b·∫Øp n∆∞·ªõc</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>

          <form id="bnForm">
            <div class="modal-body">
              <input type="hidden" id="MaBn" />
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="TenBn" class="form-label">T√™n</label>
                  <input
                    type="text"
                    id="TenBn"
                    class="form-control"
                    required
                    placeholder="VD: Combo b·∫Øp + n∆∞·ªõc l·ªõn"
                  />
                </div>
                <div class="col-md-6">
                  <label for="Gia" class="form-label">Gi√°</label>
                  <input
                    type="number"
                    id="Gia"
                    class="form-control"
                    min="0"
                    step="1000"
                    required
                    placeholder="VD: 45000"
                  />
                </div>
                <div class="col-12">
                  <label for="MoTa" class="form-label">M√¥ t·∫£</label>
                  <input
                    type="text"
                    id="MoTa"
                    class="form-control"
                    placeholder="Ghi ch√∫ k√≠ch c·ª°, topping..."
                  />
                </div>

                <div class="col-md-8">
                  <label for="Anh" class="form-label">·∫¢nh (jpg/png)</label>
                  <input
                    type="file"
                    id="Anh"
                    class="form-control"
                    accept="image/*"
                  />
                  <div class="form-text">
                    G·ª≠i k√®m file v·ªõi key <code>image</code>. Khi c·∫≠p nh·∫≠t c√≥ th·ªÉ
                    ƒë·ªÉ tr·ªëng ƒë·ªÉ gi·ªØ ·∫£nh c≈©.
                  </div>
                </div>
                <div class="col-md-4 d-flex flex-column align-items-center">
                  <span class="small text-muted mb-1">Xem tr∆∞·ªõc</span>
                  <img id="Preview" class="img-preview" alt="preview" src="" />
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ============ Config API ============ */
      // Ch·ªçn http ho·∫∑c https tr√πng v·ªõi server c·ªßa b·∫°n
      const BASE_URL = "https://localhost:7058";
      const API_BASE = `${BASE_URL}/api/BapNuoc`;
      const token = localStorage.getItem("token");

      const API = {
        list: `${API_BASE}/get-all`, // GET
        create: `${API_BASE}/create`, // POST multipart (tenBn, gia, moTa, image)
        update: (id) => `${API_BASE}/update/${id}`, // PUT  multipart (maBn, tenBn, gia, moTa, image?)
        remove: (id) => `${API_BASE}/delete/${id}`, // DELETE
      };

      /* ============ Helpers & State ============ */
      const $id = (s) => document.getElementById(s);
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      // Chu·∫©n ho√° URL ·∫£nh tr·∫£ t·ª´ BE (HinhAnhUrl c√≥ th·ªÉ "Images/BapNuoc/xxx.jpg")
      function absUrl(u) {
        if (!u) return "";
        if (/^https?:\/\//i.test(u)) return u;
        const clean = String(u).replace(/^\/?wwwroot\//i, "");
        return `${BASE_URL.replace(/\/+$/, "")}/${clean.replace(/^\/+/, "")}`;
      }

      const mapBn = (x) => ({
        maBn: x.maBn ?? x.MaBn,
        tenBn: x.tenBn ?? x.TenBn,
        gia: x.gia ?? x.Gia,
        moTa: x.moTa ?? x.MoTa,
        hinhAnhUrl: x.hinhAnhUrl ?? x.HinhAnhUrl ?? x.anh ?? x.Anh ?? "",
      });

      let dt = null;

      /* ============ DataTable load ============ */
      async function loadTable() {
        try {
          const r = await fetch(API.list, { headers: { ...authHeader } });
          const json = await r.json();
          const rows = (Array.isArray(json?.data) ? json.data : []).map(mapBn);

          if (dt) {
            dt.clear();
            dt.rows.add(rows).draw();
            return;
          }

          dt = $("#bnTable").DataTable({
            data: rows,
            columns: [
              { data: "maBn" },
              {
                data: "hinhAnhUrl",
                orderable: false,
                searchable: false,
                render: (src) => {
                  const u =
                    absUrl(src) || "../../assets/images/default-poster.jpg";
                  return `<img class="thumb" src="${u}" alt="">`;
                },
              },
              { data: "tenBn" },
              {
                data: "gia",
                render: (v) =>
                  v != null ? Number(v).toLocaleString("vi-VN") : "",
              },
              { data: "moTa" },
              {
                data: null,
                orderable: false,
                searchable: false,
                render: (row) => `
                  <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.maBn}">S·ª≠a</button>
                    <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.maBn}">X√≥a</button>
                  </div>`,
              },
            ],
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
            },
            pageLength: 10,
            responsive: true,
            autoWidth: false,
            order: [[0, "asc"]],
            dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          });
        } catch (e) {
          console.error(e);
          alert("‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch b·∫Øp n∆∞·ªõc.");
        }
      }

      /* ============ Modal & Form ============ */
      const bsModal = new bootstrap.Modal(document.getElementById("bnModal"), {
        backdrop: "static",
      });

      function resetForm() {
        $id("bnForm").reset();
        $id("MaBn").value = "";
        $id("Preview").src = "";
      }

      // Preview ·∫£nh khi ch·ªçn
      $id("Anh").addEventListener("change", (e) => {
        const f = e.target.files[0];
        $id("Preview").src = f ? URL.createObjectURL(f) : "";
      });

      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("bnModalLabel").textContent = "Th√™m b·∫Øp n∆∞·ªõc";
        bsModal.show();
      });

      $id("btnReload").addEventListener("click", loadTable);

      // Submit create/update ‚Äî lu√¥n g·ª≠i multipart (ƒë√∫ng v·ªõi controller)
      $id("bnForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = $id("MaBn").value.trim();
        const ten = $id("TenBn").value.trim();
        const gia = Number($id("Gia").value);
        const moTa = $id("MoTa").value.trim();
        const file = $id("Anh").files[0];

        // T·∫°o FormData ƒë√∫ng key backend: tenBn, gia, moTa, image (+ maBn khi update)
        const form = new FormData();
        if (id) form.append("maBn", Number(id)); // Update c·∫ßn maBn trong [FromForm]
        form.append("tenBn", ten);
        form.append("gia", isFinite(gia) ? gia : 0);
        if (moTa) form.append("moTa", moTa);
        if (file) form.append("image", file); // KEY CHU·∫®N backend ƒëang ƒë·ªçc

        try {
          const res = await fetch(id ? API.update(id) : API.create, {
            method: id ? "PUT" : "POST",
            headers: { ...authHeader }, // KH√îNG t·ª± set Content-Type
            body: form,
          });
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || "Request failed");
          }
          alert(id ? "‚úÖ ƒê√£ c·∫≠p nh·∫≠t" : "‚úÖ ƒê√£ th√™m b·∫Øp n∆∞·ªõc");
          bsModal.hide();
          await loadTable();
        } catch (err) {
          console.error(err);
          alert("‚ùå L∆∞u kh√¥ng th√†nh c√¥ng");
        }
      });

      // Click actions: edit / delete
      $("#bnTable").on("click", "button[data-act]", async function () {
        const act = this.dataset.act;
        const id = this.dataset.id;

        if (act === "edit") {
          try {
            const rowData = dt.row($(this).closest("tr")).data();
            const bn = rowData ? mapBn(rowData) : null;
            if (!bn) return alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu.");

            $id("MaBn").value = bn.maBn ?? "";
            $id("TenBn").value = bn.tenBn ?? "";
            $id("Gia").value = bn.gia ?? 0;
            $id("MoTa").value = bn.moTa ?? "";
            $id("Anh").value = "";
            $id("Preview").src = absUrl(bn.hinhAnhUrl) || "";

            $id("bnModalLabel").textContent = "C·∫≠p nh·∫≠t b·∫Øp n∆∞·ªõc";
            bsModal.show();
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói l·∫•y d·ªØ li·ªáu.");
          }
        }

        if (act === "del") {
          if (!confirm(`X√≥a b·∫Øp n∆∞·ªõc #${id}?`)) return;
          try {
            const res = await fetch(API.remove(id), {
              method: "DELETE",
              headers: { ...authHeader },
            });
            if (!res.ok) throw new Error("DELETE failed");
            alert("‚úÖ ƒê√£ x√≥a");
            await loadTable();
          } catch (err) {
            console.error(err);
            alert("‚ùå X√≥a kh√¥ng th√†nh c√¥ng");
          }
        }
      });

      /* ============ Boot ============ */
      document.addEventListener("DOMContentLoaded", loadTable);
    </script>
  </body>
</html>
