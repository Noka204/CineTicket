<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω V√©</title>

    <!-- Bootstrap + DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
      .mono {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .toast-wrap {
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 1080;
      }
      .badge-st {
        font-weight: 600;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .badge-trong {
        background: #eef2ff;
        color: #3f51b5;
      }
      .badge-giu {
        background: #fff7ed;
        color: #b45309;
      }
      .badge-dadat {
        background: #f0fdf4;
        color: #16a34a;
      }
      .badge-huy {
        background: #fee2e2;
        color: #b91c1c;
      }
      .small-muted {
        font-size: 12px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üéüÔ∏è Qu·∫£n l√Ω V√©</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="veTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 80px">M√£ v√©</th>
            <th style="width: 100px">M√£ gh·∫ø</th>
            <th style="width: 110px">M√£ su·∫•t</th>
            <th style="width: 130px">Gi√° v√©</th>
            <th style="width: 120px">Tr·∫°ng th√°i</th>
            <th style="width: 320px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a V√© -->
    <div
      class="modal fade"
      id="veModal"
      tabindex="-1"
      aria-labelledby="veModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="veModalLabel" class="modal-title">Th√™m v√©</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>

          <form id="veForm">
            <div class="modal-body">
              <input type="hidden" id="MaVe" />

              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">M√£ gh·∫ø</label>
                  <input
                    id="MaGhe"
                    type="number"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">M√£ su·∫•t</label>
                  <input
                    id="MaSuat"
                    type="number"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-4">
                  <label
                    class="form-label d-flex justify-content-between align-items-center"
                  >
                    <span>Gi√° v√© (VND)</span>
                    <button
                      type="button"
                      id="btnAutoPrice"
                      class="btn btn-sm btn-outline-primary"
                    >
                      üîé T√≠nh gi√°
                    </button>
                  </label>
                  <input
                    id="GiaVe"
                    type="number"
                    step="1000"
                    min="0"
                    class="form-control"
                  />
                  <div class="form-text small-muted">
                    D·ª±a theo lo·∫°i gh·∫ø, gi·ªù chi·∫øu, cu·ªëi tu·∫ßn‚Ä¶
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Tr·∫°ng th√°i</label>
                  <select id="TrangThai" class="form-select">
                    <option value="Trong">Trong</option>
                    <option value="TamGiu">TamGiu</option>
                    <option value="DaDat">DaDat</option>
                    <option value="Huy">Huy</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Gi·ªØ ƒë·∫øn (datetime)</label>
                  <input
                    id="ThoiGianTamGiu"
                    type="datetime-local"
                    class="form-control"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Ng∆∞·ªùi gi·ªØ (UserId)</label>
                  <input id="NguoiGiuId" class="form-control" />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Ng√†y ƒë·∫∑t (datetime)</label>
                  <input
                    id="NgayDat"
                    type="datetime-local"
                    class="form-control"
                  />
                </div>

                <div class="col-md-6">
                  <div id="AutoPriceNote" class="small-muted mt-4"></div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-wrap">
      <div
        id="toast"
        class="toast align-items-center border-0 text-white bg-success"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div id="toastBody" class="toast-body"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ============== Config ============== */
      const BASE_URL = "https://localhost:7058";
      const API = {
        list: `${BASE_URL}/api/Ve/get-all`, // GET
        create: `${BASE_URL}/api/Ve/create`, // POST (JSON)
        update: (id) => `${BASE_URL}/api/Ve/update/${id}`, // PUT (JSON)
        remove: (id) => `${BASE_URL}/api/Ve/delete/${id}`, // DELETE
        hold: `${BASE_URL}/api/Ve/hold`, // POST {maGhe,maSuat}
        release: `${BASE_URL}/api/Ve/release`, // POST {maGhe,maSuat}
        price: (maGhe, maSuat) =>
          `${BASE_URL}/api/Ve/tinh-gia-ve?maGhe=${maGhe}&maSuat=${maSuat}`, // GET
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};
      const $id = (s) => document.getElementById(s);

      const VND = new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
      });

      /* ============== Helpers ============== */
      function showToast(msg, kind = "success") {
        const el = $id("toast"),
          body = $id("toastBody");
        el.className =
          "toast align-items-center border-0 text-white " +
          (kind === "success" ? "bg-success" : "bg-danger");
        body.textContent = msg;
        new bootstrap.Toast(el, { delay: 2200 }).show();
      }
      function toLocalInputValue(v) {
        if (!v) return "";
        const d = new Date(v);
        if (isNaN(d)) return "";
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function toISOStringOrNull(inputVal) {
        return inputVal ? new Date(inputVal).toISOString() : null;
      }

      function mapVe(x) {
        return {
          maVe: x?.maVe ?? x?.MaVe,
          maGhe: x?.maGhe ?? x?.MaGhe,
          maSuat: x?.maSuat ?? x?.MaSuat,
          giaVe: x?.giaVe ?? x?.GiaVe,
          trangThai: x?.trangThai ?? x?.TrangThai,
          ngayDat: x?.ngayDat ?? x?.NgayDat,
          thoiGianTamGiu: x?.thoiGianTamGiu ?? x?.ThoiGianTamGiu,
          nguoiGiuId: x?.nguoiGiuId ?? x?.NguoiGiuId ?? "",
        };
      }
      function badgeTrangThai(st) {
        const s = String(st || "").toLowerCase();
        if (s === "dadat")
          return `<span class="badge badge-st badge-dadat">ƒê√£ ƒë·∫∑t</span>`;
        if (s === "tamgiu")
          return `<span class="badge badge-st badge-giu">T·∫°m gi·ªØ</span>`;
        if (s === "huy")
          return `<span class="badge badge-st badge-huy">H·ªßy</span>`;
        return `<span class="badge badge-st badge-trong">Trong</span>`;
      }

      /* ============== State ============== */
      let veRows = [];
      let dt = null;

      /* ============== Loaders ============== */
      async function loadVes() {
        const r = await fetch(API.list, { headers: { ...authHeader } });
        const j = await r.json();
        veRows = (
          Array.isArray(j?.data) ? j.data : Array.isArray(j) ? j : []
        ).map(mapVe);
        renderTable();
      }

      /* ============== Table ============== */
      function renderTable() {
        const rows = veRows.map((v) => ({
          ...v,
          giaHtml: v.giaVe != null ? VND.format(Number(v.giaVe)) : "",
          stHtml: badgeTrangThai(v.trangThai),
        }));

        if (dt) {
          dt.clear();
          dt.rows.add(rows).draw();
          return;
        }

        dt = $("#veTable").DataTable({
          data: rows,
          columns: [
            { data: "maVe" },
            { data: "maGhe" },
            { data: "maSuat" },
            { data: "giaHtml", className: "mono" },
            { data: "stHtml", orderable: false, searchable: false },
            {
              data: null,
              orderable: false,
              searchable: false,
              render: (row) => `
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                  <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.maVe}">S·ª≠a</button>
                  <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.maVe}">X√≥a</button>
                  <button class="btn btn-sm btn-warning"         data-act="hold" data-ghe="${row.maGhe}" data-suat="${row.maSuat}">Gi·ªØ 3'</button>
                  <button class="btn btn-sm btn-secondary"       data-act="release" data-ghe="${row.maGhe}" data-suat="${row.maSuat}">Tr·∫£</button>
                </div>`,
            },
          ],
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
          },
          pageLength: 10,
          responsive: true,
          autoWidth: false,
          order: [[0, "desc"]],
          dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        });
      }

      /* ============== Modal & CRUD ============== */
      const bsModal = new bootstrap.Modal($id("veModal"), {
        backdrop: "static",
      });

      function resetForm() {
        $id("veForm").reset();
        $id("MaVe").value = "";
        $id("TrangThai").value = "Trong";
        $id("AutoPriceNote").textContent = "";
      }

      // Add
      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("veModalLabel").textContent = "Th√™m v√©";
        bsModal.show();
      });

      // Reload
      $id("btnReload").addEventListener("click", async () => {
        await loadVes();
        showToast("ƒê√£ t·∫£i l·∫°i d·ªØ li·ªáu!", "success");
      });

      // Auto price
      $id("btnAutoPrice").addEventListener("click", async () => {
        const maGhe = Number($id("MaGhe").value);
        const maSuat = Number($id("MaSuat").value);
        if (
          !Number.isInteger(maGhe) ||
          !Number.isInteger(maSuat) ||
          maGhe <= 0 ||
          maSuat <= 0
        ) {
          return showToast("Nh·∫≠p M√£ gh·∫ø & M√£ su·∫•t h·ª£p l·ªá tr∆∞·ªõc.", "error");
        }
        try {
          const res = await fetch(API.price(maGhe, maSuat), {
            headers: { ...authHeader },
          });
          const j = await res.json();
          if (!res.ok || !j?.status)
            throw new Error(j?.message || "Kh√¥ng t√≠nh ƒë∆∞·ª£c gi√°.");
          const data = j.data || {};
          if (data?.giaCuoiCung != null) {
            $id("GiaVe").value = Number(data.giaCuoiCung);
            $id("AutoPriceNote").textContent =
              `Gi√° c∆° b·∫£n: ${Number(data.giaCoBan || 0).toLocaleString(
                "vi-VN"
              )} ‚Äî ` +
              `VIP: ${data.laVip ? "C√≥" : "Kh√¥ng"}, ƒê√™m: ${
                data.laBanDem ? "C√≥" : "Kh√¥ng"
              }, Cu·ªëi tu·∫ßn: ${data.laCuoiTuan ? "C√≥" : "Kh√¥ng"}`;
            showToast("ƒê√£ t√≠nh gi√°.");
          } else {
            showToast("Thi·∫øu d·ªØ li·ªáu gi√°.", "error");
          }
        } catch (err) {
          console.error(err);
          showToast(err.message || "L·ªói t√≠nh gi√°.", "error");
        }
      });

      // Submit (Create/Update)
      $id("veForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = $id("MaVe").value.trim();
        const maGhe = Number($id("MaGhe").value);
        const maSuat = Number($id("MaSuat").value);
        const giaVe = $id("GiaVe").value ? Number($id("GiaVe").value) : null;
        const trangThai = $id("TrangThai").value.trim();
        const tgHold = $id("ThoiGianTamGiu").value;
        const nguoiGiuId = $id("NguoiGiuId").value.trim() || null;
        const ngayDat = $id("NgayDat").value;

        if (
          !Number.isInteger(maGhe) ||
          !Number.isInteger(maSuat) ||
          maGhe <= 0 ||
          maSuat <= 0
        ) {
          return showToast("M√£ gh·∫ø / M√£ su·∫•t kh√¥ng h·ª£p l·ªá.", "error");
        }

        const payload = {
          maGhe,
          maSuat,
          giaVe,
          trangThai: trangThai || "Trong",
          thoiGianTamGiu: toISOStringOrNull(tgHold),
          nguoiGiuId,
          ngayDat: toISOStringOrNull(ngayDat),
        };

        try {
          let res;
          if (id) {
            payload.maVe = Number(id);
            res = await fetch(API.update(id), {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                ...authHeader,
              },
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              let msg = "";
              try {
                msg = (await res.json())?.message || "";
              } catch {}
              throw new Error(msg || "C·∫≠p nh·∫≠t th·∫•t b·∫°i.");
            }
          } else {
            res = await fetch(API.create, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                ...authHeader,
              },
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              let msg = "";
              try {
                msg = (await res.json())?.message || "";
              } catch {}
              throw new Error(msg || "T·∫°o v√© th·∫•t b·∫°i.");
            }
          }
          showToast(id ? "ƒê√£ c·∫≠p nh·∫≠t v√©." : "ƒê√£ t·∫°o v√©.", "success");
          bsModal.hide();
          await loadVes();
        } catch (err) {
          console.error(err);
          showToast(err.message || "L∆∞u kh√¥ng th√†nh c√¥ng.", "error");
        }
      });

      // H√†nh ƒë·ªông d√≤ng
      $("#veTable").on("click", "button[data-act]", function () {
        const act = this.dataset.act;
        const id = Number(this.dataset.id);
        const rowData = dt.row($(this).closest("tr")).data();

        if (act === "edit") {
          const v = veRows.find((x) => x.maVe === rowData.maVe);
          if (!v) return showToast("Kh√¥ng t√¨m th·∫•y v√©.", "error");
          $id("veModalLabel").textContent = "C·∫≠p nh·∫≠t v√©";
          $id("veForm").reset();
          $id("MaVe").value = v.maVe;
          $id("MaGhe").value = v.maGhe || "";
          $id("MaSuat").value = v.maSuat || "";
          $id("GiaVe").value = v.giaVe != null ? Number(v.giaVe) : "";
          $id("TrangThai").value = v.trangThai || "Trong";
          $id("ThoiGianTamGiu").value = toLocalInputValue(v.thoiGianTamGiu);
          $id("NguoiGiuId").value = v.nguoiGiuId || "";
          $id("NgayDat").value = toLocalInputValue(v.ngayDat);
          bsModal.show();
        }

        if (act === "del") {
          if (!confirm(`X√≥a v√© #${id}?`)) return;
          (async () => {
            try {
              const res = await fetch(API.remove(id), {
                method: "DELETE",
                headers: { ...authHeader },
              });
              if (!res.ok) throw new Error("DELETE failed");
              showToast("ƒê√£ x√≥a v√©.", "success");
              await loadVes();
            } catch (e) {
              console.error(e);
              showToast("X√≥a kh√¥ng th√†nh c√¥ng.", "error");
            }
          })();
        }

        if (act === "hold") {
          const ghe = Number(this.dataset.ghe);
          const suat = Number(this.dataset.suat);
          if (!ghe || !suat) return showToast("Thi·∫øu MaGhe/MaSuat.", "error");
          (async () => {
            try {
              const res = await fetch(API.hold, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                  ...authHeader,
                },
                body: JSON.stringify({ maGhe: ghe, maSuat: suat }),
              });
              const j = await res.json();
              if (!res.ok || !j?.status)
                throw new Error(j?.message || "Hold th·∫•t b·∫°i.");
              showToast("ƒê√£ gi·ªØ gh·∫ø 3 ph√∫t.", "success");
              await loadVes();
            } catch (e) {
              console.error(e);
              showToast(e.message || "Hold th·∫•t b·∫°i.", "error");
            }
          })();
        }

        if (act === "release") {
          const ghe = Number(this.dataset.ghe);
          const suat = Number(this.dataset.suat);
          if (!ghe || !suat) return showToast("Thi·∫øu MaGhe/MaSuat.", "error");
          (async () => {
            try {
              const res = await fetch(API.release, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                  ...authHeader,
                },
                body: JSON.stringify({ maGhe: ghe, maSuat: suat }),
              });
              const j = await res.json();
              if (!res.ok || !j?.status)
                throw new Error(j?.message || "Release th·∫•t b·∫°i.");
              showToast("ƒê√£ tr·∫£ gh·∫ø.", "success");
              await loadVes();
            } catch (e) {
              console.error(e);
              showToast(e.message || "Release th·∫•t b·∫°i.", "error");
            }
          })();
        }
      });

      /* ============== Boot ============== */
      (async function boot() {
        await loadVes();
      })();
    </script>
  </body>
</html>
