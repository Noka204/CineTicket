<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Su·∫•t Chi·∫øu</title>

    <!-- Bootstrap + DataTables (Bootstrap 5 theme) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
      .mono {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üé¨ Qu·∫£n l√Ω Su·∫•t Chi·∫øu</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="suatTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 90px">ID</th>
            <th>Phim</th>
            <th>Ph√≤ng</th>
            <th class="mono" style="width: 180px">B·∫Øt ƒë·∫ßu</th>
            <th class="mono" style="width: 180px">K·∫øt th√∫c</th>
            <th class="mono" style="width: 130px">Ng√†y chi·∫øu</th>
            <th class="mono" style="width: 110px">Gi·ªù chi·∫øu</th>
            <th style="width: 220px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a -->
    <div
      class="modal fade"
      id="suatModal"
      tabindex="-1"
      aria-labelledby="suatModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="suatModalLabel" class="modal-title">Th√™m su·∫•t chi·∫øu</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <form id="suatForm">
            <div class="modal-body">
              <input type="hidden" id="MaSuat" />
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="MaPhim" class="form-label">Phim</label>
                  <select id="MaPhim" class="form-select" required>
                    <option value="">-- Ch·ªçn phim --</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="MaPhong" class="form-label">Ph√≤ng</label>
                  <select id="MaPhong" class="form-select" required>
                    <option value="">-- Ch·ªçn ph√≤ng --</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="BatDau" class="form-label">B·∫Øt ƒë·∫ßu</label>
                  <input
                    type="datetime-local"
                    id="BatDau"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="KetThuc" class="form-label">K·∫øt th√∫c</label>
                  <input
                    type="datetime-local"
                    id="KetThuc"
                    class="form-control"
                    required
                  />
                </div>
                <div class="col-12">
                  <div class="form-text">
                    <strong>Ghi ch√∫:</strong> <code>ng√†yChi·∫øu</code> v√†
                    <code>gi·ªùChi·∫øu</code> s·∫Ω t·ª± t√≠nh t·ª´ <em>B·∫Øt ƒë·∫ßu</em>.
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ================= Config API ================= */
      const BASE = "https://localhost:7058";
      const API = {
        list: `${BASE}/api/SuatChieu/get-all`, // GET
        create: `${BASE}/api/SuatChieu/create`, // POST (JSON)
        update: (id) => `${BASE}/api/SuatChieu/update/${id}`, // PUT (JSON)
        remove: (id) => `${BASE}/api/SuatChieu/delete/${id}`, // DELETE
        phim: `${BASE}/api/Phim/get-all`, // GET
        phong: `${BASE}/api/Phongchieu/get-all`, // GET (ch√∫ √Ω ch·ªØ th∆∞·ªùng/hoa theo backend)
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      /* ================= Helpers ================= */
      const $id = (s) => document.getElementById(s);
      const mapPhim = (x) => ({
        maPhim: x.maPhim ?? x.MaPhim,
        tenPhim: x.tenPhim ?? x.TenPhim,
      });
      const mapPhong = (x) => ({
        maPhong: x.maPhong ?? x.MaPhong,
        tenPhong: x.tenPhong ?? x.TenPhong ?? `Ph√≤ng ${x.maPhong ?? x.MaPhong}`,
      });
      const mapSuat = (x) => ({
        maSuat: x.maSuat ?? x.MaSuat,
        maPhim: x.maPhim ?? x.MaPhim,
        maPhong: x.maPhong ?? x.MaPhong,
        thoiGianBatDau: x.thoiGianBatDau ?? x.ThoiGianBatDau,
        thoiGianKetThuc: x.thoiGianKetThuc ?? x.ThoiGianKetThuc,
      });

      function toDate(d) {
        try {
          return new Date(d);
        } catch {
          return null;
        }
      }
      function pad2(n) {
        return String(n).padStart(2, "0");
      }
      function fmtDateTimeLabel(d) {
        const dt = toDate(d);
        if (!dt || isNaN(dt)) return "";
        return `${pad2(dt.getDate())}/${pad2(
          dt.getMonth() + 1
        )}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
      }
      function fmtDateOnly(d) {
        const dt = toDate(d);
        if (!dt || isNaN(dt)) return "";
        return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(
          dt.getDate()
        )}`;
      }
      function fmtTimeOnly(d) {
        const dt = toDate(d);
        if (!dt || isNaN(dt)) return "";
        return `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
      }

      /* ================= State ================= */
      let dt = null;
      let phimOptions = [];
      let phongOptions = [];
      let rows = [];

      /* ================= Load Options ================= */
      async function loadOptions() {
        const [rPhim, rPhong] = await Promise.all([
          fetch(API.phim, { headers: { ...authHeader } }),
          fetch(API.phong, { headers: { ...authHeader } }),
        ]);
        const j1 = await rPhim.json();
        const j2 = await rPhong.json();
        phimOptions = (
          Array.isArray(j1?.data) ? j1.data : Array.isArray(j1) ? j1 : []
        ).map(mapPhim);
        phongOptions = (
          Array.isArray(j2?.data) ? j2.data : Array.isArray(j2) ? j2 : []
        ).map(mapPhong);

        // fill selects in modal
        const phimSel = $id("MaPhim");
        const phongSel = $id("MaPhong");
        phimSel.innerHTML = '<option value="">-- Ch·ªçn phim --</option>';
        phongSel.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
        phimOptions.forEach((p) => {
          const o = document.createElement("option");
          o.value = p.maPhim;
          o.textContent = p.tenPhim;
          phimSel.appendChild(o);
        });
        phongOptions.forEach((p) => {
          const o = document.createElement("option");
          o.value = p.maPhong;
          o.textContent = p.tenPhong;
          phongSel.appendChild(o);
        });
      }

      /* ================= Load Table ================= */
      async function loadTable() {
        try {
          const r = await fetch(API.list, { headers: { ...authHeader } });
          const j = await r.json();
          rows = (
            Array.isArray(j?.data) ? j.data : Array.isArray(j) ? j : []
          ).map(mapSuat);

          const tableData = rows.map((r) => {
            const phimName =
              phimOptions.find((p) => p.maPhim === r.maPhim)?.tenPhim ||
              `#${r.maPhim}`;
            const phongName =
              phongOptions.find((p) => p.maPhong === r.maPhong)?.tenPhong ||
              `Ph√≤ng ${r.maPhong}`;
            return {
              ...r,
              phimName,
              phongName,
              batDauLabel: fmtDateTimeLabel(r.thoiGianBatDau),
              ketThucLabel: fmtDateTimeLabel(r.thoiGianKetThuc),
              ngayChieuLabel: fmtDateOnly(r.thoiGianBatDau),
              gioChieuLabel: fmtTimeOnly(r.thoiGianBatDau),
            };
          });

          if (dt) {
            dt.clear();
            dt.rows.add(tableData).draw();
            return;
          }

          dt = $("#suatTable").DataTable({
            data: tableData,
            columns: [
              { data: "maSuat" },
              { data: "phimName" },
              { data: "phongName" },
              { data: "batDauLabel", className: "mono" },
              { data: "ketThucLabel", className: "mono" },
              { data: "ngayChieuLabel", className: "mono" },
              { data: "gioChieuLabel", className: "mono" },
              {
                data: null,
                orderable: false,
                searchable: false,
                render: (row) =>
                  `<div class="d-flex flex-wrap gap-2 justify-content-center">
                   <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.maSuat}">S·ª≠a</button>
                   <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.maSuat}">X√≥a</button>
                 </div>`,
              },
            ],
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
            },
            pageLength: 10,
            responsive: true,
            autoWidth: false,
            order: [[0, "asc"]],
            dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          });
        } catch (e) {
          console.error(e);
          alert("‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch su·∫•t chi·∫øu.");
        }
      }

      /* ================= Modal & CRUD ================= */
      const bsModal = new bootstrap.Modal(
        document.getElementById("suatModal"),
        { backdrop: "static" }
      );

      function resetForm() {
        $id("suatForm").reset();
        $id("MaSuat").value = "";
      }

      // Th√™m m·ªõi
      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("suatModalLabel").textContent = "Th√™m su·∫•t chi·∫øu";
        bsModal.show();
      });

      // T·∫£i l·∫°i
      $id("btnReload").addEventListener("click", async () => {
        await loadOptions();
        await loadTable();
      });

      // Submit (Create/Update)
      $id("suatForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = $id("MaSuat").value.trim();
        const maPhim = Number($id("MaPhim").value);
        const maPhong = Number($id("MaPhong").value);
        const batDau = $id("BatDau").value;
        const ketThuc = $id("KetThuc").value;

        if (!maPhim || !maPhong || !batDau || !ketThuc)
          return alert("‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin.");
        if (new Date(ketThuc) <= new Date(batDau))
          return alert("‚ùå Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu.");

        const body = {
          maSuat: id ? Number(id) : undefined,
          maPhim,
          maPhong,
          thoiGianBatDau: batDau,
          thoiGianKetThuc: ketThuc,
          ngayChieu: fmtDateOnly(batDau),
          gioChieu: fmtTimeOnly(batDau),
        };

        try {
          let res;
          if (id) {
            res = await fetch(API.update(id), {
              method: "PUT",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(body),
            });
          } else {
            const createPayload = { ...body };
            delete createPayload.maSuat;
            res = await fetch(API.create, {
              method: "POST",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(createPayload),
            });
          }

          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || "Request failed");
          }

          alert(id ? "‚úÖ ƒê√£ c·∫≠p nh·∫≠t su·∫•t chi·∫øu" : "‚úÖ ƒê√£ th√™m su·∫•t chi·∫øu");
          bsModal.hide();
          await loadTable();
        } catch (err) {
          console.error(err);
          alert("‚ùå L∆∞u kh√¥ng th√†nh c√¥ng");
        }
      });

      // H√†nh ƒë·ªông trong b·∫£ng: edit / delete
      $("#suatTable").on("click", "button[data-act]", async function () {
        const act = this.dataset.act;
        const id = this.dataset.id;

        if (act === "edit") {
          try {
            const rowData = dt.row($(this).closest("tr")).data();
            const s = rowData
              ? rows.find((x) => x.maSuat === rowData.maSuat)
              : null;
            if (!s) return alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu su·∫•t.");

            $id("MaSuat").value = s.maSuat ?? "";
            $id("MaPhim").value = s.maPhim ?? "";
            $id("MaPhong").value = s.maPhong ?? "";

            // set datetime-local (YYYY-MM-DDTHH:mm)
            const bd = new Date(s.thoiGianBatDau);
            const kt = new Date(s.thoiGianKetThuc);
            const toLocalInput = (d) => {
              if (!d || isNaN(d)) return "";
              const y = d.getFullYear(),
                m = String(d.getMonth() + 1).padStart(2, "0"),
                day = String(d.getDate()).padStart(2, "0");
              const h = String(d.getHours()).padStart(2, "0"),
                mi = String(d.getMinutes()).padStart(2, "0");
              return `${y}-${m}-${day}T${h}:${mi}`;
            };
            $id("BatDau").value = toLocalInput(bd);
            $id("KetThuc").value = toLocalInput(kt);

            $id("suatModalLabel").textContent = "C·∫≠p nh·∫≠t su·∫•t chi·∫øu";
            bsModal.show();
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói l·∫•y d·ªØ li·ªáu su·∫•t.");
          }
        }

        if (act === "del") {
          if (!confirm(`X√≥a su·∫•t chi·∫øu #${id}?`)) return;
          try {
            const res = await fetch(API.remove(id), {
              method: "DELETE",
              headers: { ...authHeader },
            });
            if (!res.ok) throw new Error("DELETE failed");
            alert("‚úÖ ƒê√£ x√≥a su·∫•t chi·∫øu");
            await loadTable();
          } catch (err) {
            console.error(err);
            alert("‚ùå X√≥a kh√¥ng th√†nh c√¥ng");
          }
        }
      });

      /* ================= Boot ================= */
      (async function boot() {
        await loadOptions();
        await loadTable();
      })();
    </script>
  </body>
</html>
