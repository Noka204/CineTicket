<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Su·∫•t Chi·∫øu</title>

    <!-- Bootstrap + DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
      .mono {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .timebox {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .timebox select {
        min-width: 80px;
      }
      .small-hint {
        font-size: 0.9rem;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üé¨ Qu·∫£n l√Ω Su·∫•t Chi·∫øu</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="suatTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 90px">ID</th>
            <th>Phim</th>
            <th>Ph√≤ng</th>
            <th class="mono" style="width: 180px">B·∫Øt ƒë·∫ßu</th>
            <th class="mono" style="width: 180px">K·∫øt th√∫c</th>
            <th class="mono" style="width: 130px">Ng√†y chi·∫øu</th>
            <th class="mono" style="width: 110px">Gi·ªù chi·∫øu</th>
            <th style="width: 220px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a -->
    <div
      class="modal fade"
      id="suatModal"
      tabindex="-1"
      aria-labelledby="suatModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="suatModalLabel" class="modal-title">Th√™m su·∫•t chi·∫øu</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>

          <form id="suatForm">
            <div class="modal-body">
              <input type="hidden" id="MaSuat" />

              <div class="row g-3">
                <div class="col-md-6">
                  <label for="MaPhim" class="form-label">Phim</label>
                  <select id="MaPhim" class="form-select" required>
                    <option value="">-- Ch·ªçn phim --</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label for="MaPhong" class="form-label">Ph√≤ng</label>
                  <select id="MaPhong" class="form-select" required>
                    <option value="">-- Ch·ªçn ph√≤ng --</option>
                  </select>
                </div>

                <div class="col-12">
                  <label for="Ngay" class="form-label">Ng√†y</label>
                  <input id="Ngay" type="date" class="form-control" required />
                </div>

                <div class="col-md-6">
                  <label class="form-label">Gi·ªù b·∫Øt ƒë·∫ßu (24h)</label>
                  <div class="timebox">
                    <select id="BDHour" class="form-select" required></select>
                    <select id="BDMin" class="form-select" required></select>
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Gi·ªù k·∫øt th√∫c (24h)</label>
                  <div class="timebox">
                    <select id="KTHour" class="form-select" required></select>
                    <select id="KTMin" class="form-select" required></select>
                  </div>
                </div>

                <div class="col-12 small-hint">
                  <strong>Ghi ch√∫:</strong> <code>ng√†y chi·∫øu</code> v√†
                  <code>gi·ªù chi·∫øu</code> s·∫Ω t·ª± t√≠nh t·ª´
                  <em>Ng√†y + Gi·ªù b·∫Øt ƒë·∫ßu</em>.
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ================= Config API ================= */
      const BASE = "https://localhost:7058";
      const API = {
        list: `${BASE}/api/SuatChieu/get-all`,
        create: `${BASE}/api/SuatChieu/create`,
        update: (id) => `${BASE}/api/SuatChieu/update/${id}`,
        remove: (id) => `${BASE}/api/SuatChieu/delete/${id}`,
        phim: `${BASE}/api/Phim/get-all`,
        phong: `${BASE}/api/PhongChieu/get-all`,
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      /* ================= Helpers ================= */
      const $id = (s) => document.getElementById(s);
      const pad2 = (n) => String(n).padStart(2, "0");

      // Parse "th√¥ng minh": c√≥ Z/offset -> Date(UTC), kh√¥ng c√≥ -> coi l√† local
      function toDateSmart(d) {
        if (d == null) return new Date(NaN);
        if (typeof d === "string") {
          if (/Z$|[+\-]\d{2}:\d{2}$/.test(d)) return new Date(d);
          const m = d.match(
            /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2}))?$/
          );
          if (m) {
            const y = +m[1],
              mo = +m[2],
              da = +m[3],
              h = +m[4],
              mi = +m[5],
              s = +(m[6] || 0);
            return new Date(y, mo - 1, da, h, mi, s);
          }
        }
        return new Date(d);
      }

      function fmtDateTimeLabel(d) {
        const dt = toDateSmart(d);
        if (isNaN(dt)) return "";
        return `${pad2(dt.getDate())}/${pad2(
          dt.getMonth() + 1
        )}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
      }
      function fmtDateOnly(d) {
        const dt = toDateSmart(d);
        if (isNaN(dt)) return "";
        return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(
          dt.getDate()
        )}`;
      }
      function fmtTimeOnly(d) {
        const dt = toDateSmart(d);
        if (isNaN(dt)) return "";
        return `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
      }

      const mapPhim = (x) => ({
        maPhim: x.maPhim ?? x.MaPhim,
        tenPhim: x.tenPhim ?? x.TenPhim,
      });
      const mapPhong = (x) => ({
        maPhong: x.maPhong ?? x.MaPhong,
        tenPhong: x.tenPhong ?? x.TenPhong ?? `Ph√≤ng ${x.maPhong ?? x.MaPhong}`,
        maRap: x.maRap ?? x.MaRap,
        tenRap: x.tenRap ?? x.TenRap ?? null,
      });
      const mapSuat = (x) => ({
        maSuat: x.maSuat ?? x.MaSuat,
        maPhim: x.maPhim ?? x.MaPhim,
        maPhong: x.maPhong ?? x.MaPhong,
        thoiGianBatDau: x.thoiGianBatDau ?? x.ThoiGianBatDau,
        thoiGianKetThuc: x.thoiGianKetThuc ?? x.ThoiGianKetThuc,
      });

      /* ======= Dropdown gi·ªù/ph√∫t ======= */
      const MINUTE_STEP = 1;

      function fillHourSelect(sel) {
        sel.innerHTML = "";
        for (let h = 0; h < 24; h++) {
          const opt = document.createElement("option");
          opt.value = pad2(h);
          opt.textContent = pad2(h);
          sel.appendChild(opt);
        }
      }
      function fillMinuteSelect(sel, step = MINUTE_STEP) {
        sel.innerHTML = "";
        for (let m = 0; m < 60; m += step) {
          const opt = document.createElement("option");
          opt.value = pad2(m);
          opt.textContent = pad2(m);
          sel.appendChild(opt);
        }
      }

      // GH√âP local string "YYYY-MM-DDTHH:mm:ss" (KH√îNG toISOString)
      function composeDateTime(yyyy_mm_dd, hSel, mSel) {
        if (!yyyy_mm_dd) return null;
        const hh = String(hSel.value || "00").padStart(2, "0");
        const mm = String(mSel.value || "00").padStart(2, "0");
        return `${yyyy_mm_dd}T${hh}:${mm}:00`;
      }

      // Set dropdown t·ª´ Date, l√†m tr√≤n ph√∫t b·∫±ng floor ƒë·ªÉ kh√¥ng nh·∫£y l√™n 60
      function setTimeSelects(dateLike, hourSel, minSel) {
        const dt = toDateSmart(dateLike);
        if (isNaN(dt)) return;
        hourSel.value = pad2(dt.getHours());
        const mm = dt.getMinutes();
        const snapped = Math.floor(mm / MINUTE_STEP) * MINUTE_STEP;
        minSel.value = pad2(snapped);
      }

      /* ================= State ================= */
      let dtTable = null;
      let phimOptions = [];
      let phongOptions = [];
      let rows = [];

      /* ================= Load Options ================= */
      async function loadOptions() {
        const [rPhim, rPhong] = await Promise.all([
          fetch(API.phim, { headers: { ...authHeader } }),
          fetch(API.phong, { headers: { ...authHeader } }),
        ]);
        const j1 = await rPhim.json();
        const j2 = await rPhong.json();
        phimOptions = (
          Array.isArray(j1?.data) ? j1.data : Array.isArray(j1) ? j1 : []
        ).map(mapPhim);
        phongOptions = (
          Array.isArray(j2?.data) ? j2.data : Array.isArray(j2) ? j2 : []
        ).map(mapPhong);

        const phimSel = $id("MaPhim"),
          phongSel = $id("MaPhong");
        phimSel.innerHTML = '<option value="">-- Ch·ªçn phim --</option>';
        phongSel.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
        phimOptions.forEach((p) => {
          const o = document.createElement("option");
          o.value = p.maPhim;
          o.textContent = p.tenPhim;
          phimSel.appendChild(o);
        });
        phongOptions.forEach((p) => {
          const o = document.createElement("option");
          o.value = p.maPhong;
          o.textContent = p.tenPhong;
          phongSel.appendChild(o);
        });
      }

      /* ================= Load Table ================= */
      async function loadTable() {
        try {
          const r = await fetch(API.list, { headers: { ...authHeader } });
          const j = await r.json();
          rows = (
            Array.isArray(j?.data) ? j.data : Array.isArray(j) ? j : []
          ).map(mapSuat);

          const tableData = rows.map((r) => {
            const phimName =
              phimOptions.find((p) => p.maPhim === r.maPhim)?.tenPhim ||
              `#${r.maPhim}`;
            const phongItem = phongOptions.find((p) => p.maPhong === r.maPhong);
            const phongName = phongItem?.tenPhong || `Ph√≤ng ${r.maPhong}`;
            return {
              ...r,
              phimName,
              phongName,
              batDauLabel: fmtDateTimeLabel(r.thoiGianBatDau),
              ketThucLabel: fmtDateTimeLabel(r.thoiGianKetThuc),
              ngayChieuLabel: fmtDateOnly(r.thoiGianBatDau),
              gioChieuLabel: fmtTimeOnly(r.thoiGianBatDau),
            };
          });

          if (dtTable) {
            dtTable.clear();
            dtTable.rows.add(tableData).draw();
            return;
          }

          dtTable = $("#suatTable").DataTable({
            data: tableData,
            columns: [
              { data: "maSuat" },
              { data: "phimName" },
              { data: "phongName" },
              { data: "batDauLabel", className: "mono" },
              { data: "ketThucLabel", className: "mono" },
              { data: "ngayChieuLabel", className: "mono" },
              { data: "gioChieuLabel", className: "mono" },
              {
                data: null,
                orderable: false,
                searchable: false,
                render: (row) => `
                  <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.maSuat}">S·ª≠a</button>
                    <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.maSuat}">X√≥a</button>
                  </div>`,
              },
            ],
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
            },
            pageLength: 10,
            responsive: true,
            autoWidth: false,
            order: [[0, "asc"]],
            dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          });
        } catch (e) {
          console.error(e);
          alert("‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch su·∫•t chi·∫øu.");
        }
      }

      /* ================= Modal & CRUD ================= */
      const bsModal = new bootstrap.Modal(
        document.getElementById("suatModal"),
        { backdrop: "static" }
      );

      function resetForm() {
        $id("suatForm").reset();
        $id("MaSuat").value = "";
        const now = new Date();
        $id("Ngay").value = `${now.getFullYear()}-${pad2(
          now.getMonth() + 1
        )}-${pad2(now.getDate())}`;
        $id("BDHour").value = "09";
        $id("BDMin").value = "00";
        $id("KTHour").value = "11";
        $id("KTMin").value = "00";
      }

      ["BDHour", "KTHour"].forEach((id) => fillHourSelect($id(id)));
      ["BDMin", "KTMin"].forEach((id) =>
        fillMinuteSelect($id(id), MINUTE_STEP)
      );

      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("suatModalLabel").textContent = "Th√™m su·∫•t chi·∫øu";
        bsModal.show();
      });

      $id("btnReload").addEventListener("click", async () => {
        await loadOptions();
        await loadTable();
      });

      // Submit (Create / Update)
      $id("suatForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = $id("MaSuat").value.trim();
        const maPhim = Number($id("MaPhim").value);
        const maPhong = Number($id("MaPhong").value);
        const ngay = $id("Ngay").value;

        const phong = phongOptions.find((p) => p.maPhong === maPhong);
        const maRap = phong?.maRap;

        if (!maPhim || !maPhong || !maRap || !ngay)
          return alert("‚ùå Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin.");

        const batDauLocal = composeDateTime(ngay, $id("BDHour"), $id("BDMin")); // "YYYY-MM-DDTHH:mm:ss" local
        const ketThucLocal = composeDateTime(ngay, $id("KTHour"), $id("KTMin"));

        if (!batDauLocal || !ketThucLocal) return alert("‚ùå Gi·ªù kh√¥ng h·ª£p l·ªá.");
        if (toDateSmart(ketThucLocal) <= toDateSmart(batDauLocal))
          return alert("‚ùå K·∫øt th√∫c ph·∫£i sau b·∫Øt ƒë·∫ßu.");

        const body = {
          maSuat: id ? Number(id) : undefined,
          maPhim,
          maPhong,
          maRap,
          thoiGianBatDau: batDauLocal, // gi·ªØ local string
          thoiGianKetThuc: ketThucLocal, // gi·ªØ local string
          ngayChieu: ngay,
          gioChieu: `${$id("BDHour").value}:${$id("BDMin").value}`,
        };

        try {
          let res;
          if (id) {
            res = await fetch(API.update(id), {
              method: "PUT",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(body),
            });
          } else {
            const payload = { ...body };
            delete payload.maSuat;
            res = await fetch(API.create, {
              method: "POST",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(payload),
            });
          }
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || "Request failed");
          }
          alert(id ? "‚úÖ ƒê√£ c·∫≠p nh·∫≠t su·∫•t chi·∫øu" : "‚úÖ ƒê√£ th√™m su·∫•t chi·∫øu");
          bsModal.hide();
          await loadTable();
        } catch (err) {
          console.error(err);
          alert("‚ùå L∆∞u kh√¥ng th√†nh c√¥ng");
        }
      });

      // Edit / Delete
      $("#suatTable").on("click", "button[data-act]", function () {
        const act = this.dataset.act;
        const id = this.dataset.id;
        if (act === "edit") {
          try {
            const rowData = dtTable.row($(this).closest("tr")).data();
            const s = rowData
              ? rows.find((x) => x.maSuat === rowData.maSuat)
              : null;
            if (!s) return alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu su·∫•t.");

            $id("suatModalLabel").textContent = "C·∫≠p nh·∫≠t su·∫•t chi·∫øu";
            $id("MaSuat").value = s.maSuat ?? "";
            $id("MaPhim").value = s.maPhim ?? "";
            $id("MaPhong").value = s.maPhong ?? "";

            const bd = toDateSmart(s.thoiGianBatDau);
            const kt = toDateSmart(s.thoiGianKetThuc);
            $id("Ngay").value = fmtDateOnly(bd);
            setTimeSelects(bd, $id("BDHour"), $id("BDMin"));
            setTimeSelects(kt, $id("KTHour"), $id("KTMin"));

            bsModal.show();
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói l·∫•y d·ªØ li·ªáu su·∫•t.");
          }
        }

        if (act === "del") {
          if (!confirm(`X√≥a su·∫•t chi·∫øu #${id}?`)) return;
          fetch(API.remove(id), {
            method: "DELETE",
            headers: { ...authHeader },
          })
            .then((r) => {
              if (!r.ok) throw new Error();
            })
            .then(async () => {
              alert("‚úÖ ƒê√£ x√≥a su·∫•t chi·∫øu");
              await loadTable();
            })
            .catch(() => alert("‚ùå X√≥a kh√¥ng th√†nh c√¥ng"));
        }
      });

      /* ================= Boot ================= */
      (async function boot() {
        await loadOptions();
        await loadTable();
      })();
    </script>
  </body>
</html>
