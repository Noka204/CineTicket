<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω t√†i kho·∫£n</title>

    <!-- Bootstrap + DataTables (Bootstrap 5 theme) + Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üë§ Qu·∫£n l√Ω t√†i kho·∫£n</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
      </div>
    </div>

    <!-- B·ªô l·ªçc -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <label for="roleFilter" class="form-label mb-1">L·ªçc theo quy·ªÅn</label>
        <select id="roleFilter" class="form-select">
          <option value="">-- T·∫•t c·∫£ quy·ªÅn --</option>
        </select>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="userTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 220px"><i class="fas fa-user"></i> H·ªç t√™n</th>
            <th><i class="fas fa-envelope"></i> Email</th>
            <th style="width: 200px">
              <i class="fas fa-id-badge"></i> T√†i kho·∫£n
            </th>
            <th style="width: 160px">
              <i class="fas fa-user-shield"></i> Quy·ªÅn
            </th>
            <th style="width: 220px"><i class="fas fa-cogs"></i> H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal ch·ªânh s·ª≠a quy·ªÅn -->
    <div
      class="modal fade"
      id="editRoleModal"
      tabindex="-1"
      aria-labelledby="editRoleLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="editRoleLabel" class="modal-title">Ch·ªânh s·ª≠a quy·ªÅn</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <div class="modal-body">
            <p id="modal-username" class="mb-2"></p>
            <select id="select-role" class="form-select"></select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
              H·ªßy
            </button>
            <button id="btnUpdateRole" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ================= API endpoints ================= */
      const API = {
        getUsers: "https://localhost:7058/api/account/get-all-users", // GET -> { status, data: { RoleA: [users], RoleB: [...] } }
        getRoles: "https://localhost:7058/api/account/get-all-roles", // GET -> { status, data: [ "Admin", "User", ... ] }
        updateRole: "https://localhost:7058/api/account/update-role", // PUT -> body: { userName, role }
        deleteUser: "https://localhost:7058/api/account/delete", // DELETE -> body: { userName }
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      /* ================= Helpers ================= */
      const $id = (s) => document.getElementById(s);
      const mapUser = (u) => ({
        fullName: u.fullName ?? u.FullName ?? "",
        email: u.email ?? u.Email ?? "",
        userName: u.userName ?? u.UserName ?? "",
        role: u.role ?? u.Role ?? "",
      });

      let dt = null;
      let flatUsers = []; // [{fullName,email,userName,role}]
      let allRoles = []; // ["Admin","User",...]

      let selectedUsername = ""; // for modal

      /* ================= Load roles & users ================= */
      async function loadRoles() {
        const res = await fetch(API.getRoles, { headers: { ...authHeader } });
        const json = await res.json();
        allRoles = Array.isArray(json?.data)
          ? json.data
          : Array.isArray(json)
          ? json
          : [];
        // fill role filter
        const rf = $id("roleFilter");
        rf.innerHTML = '<option value="">-- T·∫•t c·∫£ quy·ªÅn --</option>';
        allRoles.forEach((r) => {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          rf.appendChild(opt);
        });
      }

      async function loadUsers() {
        const res = await fetch(API.getUsers, { headers: { ...authHeader } });
        const result = await res.json();
        const container = [];
        // result.data l√† object: { roleName: [users] }
        const groups = result?.data || {};
        Object.keys(groups).forEach((role) => {
          const arr = groups[role] || [];
          arr.forEach((u) => container.push(mapUser({ ...u, role })));
        });
        flatUsers = container;
        renderTable();
      }

      /* ================= DataTable ================= */
      function renderTable() {
        const rows = flatUsers;

        if (dt) {
          dt.clear();
          dt.rows.add(rows).draw();
          return;
        }

        dt = $("#userTable").DataTable({
          data: rows,
          columns: [
            { data: "fullName" },
            { data: "email" },
            { data: "userName" },
            { data: "role" },
            {
              data: null,
              orderable: false,
              searchable: false,
              render: (row) => `
              <div class="d-flex flex-wrap gap-2 justify-content-center">
                <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.userName}">
                  <i class="fa fa-pen"></i> S·ª≠a quy·ªÅn
                </button>
                <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${row.userName}">
                  <i class="fa fa-trash"></i> X√≥a
                </button>
              </div>`,
            },
          ],
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
          },
          pageLength: 10,
          responsive: true,
          autoWidth: false,
          order: [[0, "asc"]],
          dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        });

        // L·ªçc theo quy·ªÅn
        $id("roleFilter").addEventListener("change", () => {
          const val = $id("roleFilter").value;
          // T√¨m theo c·ªôt 3 (0-based: 0-fullName,1-email,2-userName,3-role)
          dt.column(3)
            .search(val ? `^${escapeRegex(val)}$` : "", true, false)
            .draw();
        });
      }

      function escapeRegex(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      /* ================= Actions ================= */
      // Click edit/delete trong b·∫£ng
      $("#userTable").on("click", "button[data-act]", async function () {
        const act = this.dataset.act;
        const id = this.dataset.id; // userName

        if (act === "edit") {
          selectedUsername = id;
          $id("modal-username").textContent = `ƒê·ªïi quy·ªÅn cho t√†i kho·∫£n: ${id}`;

          // fill roles into modal select
          const sel = $id("select-role");
          sel.innerHTML = "";
          allRoles.forEach((r) => {
            const opt = document.createElement("option");
            opt.value = r;
            opt.textContent = r;
            // ch·ªçn role hi·ªán t·∫°i
            const cur = flatUsers.find((x) => x.userName === id)?.role || "";
            if (r.toLowerCase() === cur.toLowerCase()) opt.selected = true;
            sel.appendChild(opt);
          });

          new bootstrap.Modal($id("editRoleModal")).show();
        }

        if (act === "del") {
          if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n "${id}" kh√¥ng?`)) return;
          try {
            const res = await fetch(API.deleteUser, {
              method: "DELETE",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify({ userName: id }),
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err?.message || "Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n");
            }
            alert("‚úÖ ƒê√£ x√≥a t√†i kho·∫£n!");
            await loadUsers();
          } catch (e) {
            console.error(e);
            alert("‚ùå L·ªói khi x√≥a t√†i kho·∫£n: " + e.message);
          }
        }
      });

      // C·∫≠p nh·∫≠t quy·ªÅn (modal)
      $id("btnUpdateRole").addEventListener("click", async () => {
        const newRole = $id("select-role").value;
        try {
          const res = await fetch(API.updateRole, {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...authHeader },
            body: JSON.stringify({ userName: selectedUsername, role: newRole }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err?.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t quy·ªÅn");
          }
          alert("‚úÖ C·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!");
          bootstrap.Modal.getInstance($id("editRoleModal")).hide();
          await loadUsers();
        } catch (e) {
          console.error(e);
          alert("‚ùå L·ªói: " + e.message);
        }
      });

      /* ================= Boot ================= */
      (async function boot() {
        try {
          await loadRoles();
          await loadUsers();
        } catch (e) {
          console.error(e);
          alert("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng/quy·ªÅn.");
        }
      })();

      // Reload button
      $id("btnReload").addEventListener("click", async () => {
        await loadRoles();
        await loadUsers();
      });
    </script>
  </body>
</html>
