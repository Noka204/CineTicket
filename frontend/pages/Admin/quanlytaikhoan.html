<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω t√†i kho·∫£n</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 1000px;
      margin-top: 30px;
    }
    .table th, .table td {
      vertical-align: middle;
    }
    .table th {
      background-color: #343a40;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 fw-bold">Danh s√°ch ng∆∞·ªùi d√πng theo quy·ªÅn</h2>
    <a href="../Admin/index.html" class="btn btn-outline-dark">üîô Quay l·∫°i</a>

    <!-- Modal ch·ªânh s·ª≠a quy·ªÅn -->
    <div class="modal fade" id="editRoleModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Ch·ªânh s·ª≠a quy·ªÅn</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="modal-username"></p>
            <select id="select-role" class="form-select"></select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button class="btn btn-primary" onclick="updateRole()">C·∫≠p nh·∫≠t</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Khu v·ª±c hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi d√πng -->
    <div id="user-container"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let selectedUsername = "";

    document.addEventListener("DOMContentLoaded", () => {
      loadUsers();
    });

    async function loadUsers() {
      try {
        const token = localStorage.getItem("token");
        const response = await fetch("https://localhost:7058/api/account/get-all-users", {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const result = await response.json();
        const container = document.getElementById("user-container");
        container.innerHTML = '';

        if (!result.status || !result.data) {
          container.innerHTML = "<p class='text-danger'>Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi d√πng.</p>";
          return;
        }

        for (let role in result.data) {
          const users = result.data[role];
          let tableHTML = `
            <h4 class="text-primary">${role} (${users.length})</h4>
            <table class="table table-bordered table-hover">
              <thead>
                <tr>
                  <th><i class="fas fa-user"></i> T√™n ng∆∞·ªùi d√πng</th>
                  <th><i class="fas fa-envelope"></i> Email</th>
                  <th><i class="fas fa-id-badge"></i> T√™n t√†i kho·∫£n</th>
                  <th><i class="fas fa-user-shield"></i> Quy·ªÅn</th>
                  <th><i class="fas fa-cogs"></i> H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(u => `
                  <tr>
                    <td>${u.fullName}</td>
                    <td>${u.email}</td>
                    <td>${u.userName}</td>
                    <td>${u.role}</td>
                    <td>
                      <button class="btn btn-sm btn-info me-2" onclick="showRoleModal('${u.userName}', '${u.role}')">Ch·ªânh s·ª≠a quy·ªÅn</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.userName}')">X√≥a</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML += tableHTML;
        }

      } catch (err) {
        console.error(err);
        document.getElementById("user-container").innerHTML = "<p class='text-danger'>L·ªói khi t·∫£i d·ªØ li·ªáu.</p>";
      }
    }

    async function showRoleModal(userName, currentRole) {
      selectedUsername = userName;
      document.getElementById("modal-username").textContent = `ƒê·ªïi quy·ªÅn cho t√†i kho·∫£n: ${userName}`;

      const token = localStorage.getItem("token");
      const select = document.getElementById("select-role");
      select.innerHTML = ""; // X√≥a t·∫•t c·∫£ option c≈©

      try {
        const res = await fetch("https://localhost:7058/api/account/get-all-roles", {
          headers: { "Authorization": `Bearer ${token}` }
        });

        const result = await res.json();
        const roles = result.data;

        roles.forEach(role => {
          const option = document.createElement("option");
          option.value = role;
          option.textContent = role;
          if (role.toLowerCase() === currentRole.toLowerCase()) option.selected = true;
          select.appendChild(option);
        });

        new bootstrap.Modal(document.getElementById("editRoleModal")).show();

      } catch (err) {
        console.error("L·ªói khi l·∫•y danh s√°ch quy·ªÅn:", err);
        alert("Kh√¥ng th·ªÉ t·∫£i danh s√°ch quy·ªÅn!");
      }
    }

    async function updateRole() {
      const newRole = document.getElementById("select-role").value;
      const token = localStorage.getItem("token");

      const res = await fetch("https://localhost:7058/api/account/update-role", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          userName: selectedUsername,
          role: newRole
        })
      });

      if (res.ok) {
        alert("C·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!");
        bootstrap.Modal.getInstance(document.getElementById("editRoleModal")).hide();
        loadUsers(); // Reload danh s√°ch
      } else {
        const error = await res.json();
        alert("L·ªói: " + (error.message || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t quy·ªÅn"));
      }
    }

    async function deleteUser(userName) {
      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n "${userName}" kh√¥ng?`)) return;
      const token = localStorage.getItem("token");

      const res = await fetch("https://localhost:7058/api/account/delete", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ userName })
      });

      if (res.ok) {
        alert("ƒê√£ x√≥a t√†i kho·∫£n!");
        loadUsers();
      } else {
        const error = await res.json();
        alert("L·ªói khi x√≥a t√†i kho·∫£n: " + (error.message || "Kh√¥ng r√µ l·ªói."));
      }
    }
  </script>
</body>
</html>
