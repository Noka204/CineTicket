<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Gh·∫ø</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
      .badge-seat {
        font-weight: 600;
        border: 1px solid rgba(0, 0, 0, 0.075);
      }
      #alertBox {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>üí∫ Qu·∫£n l√Ω Gh·∫ø</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
      </div>
    </div>

    <div id="alertBox" class="alert" role="alert"></div>

    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <label for="searchText" class="form-label mb-1">T√¨m theo s·ªë gh·∫ø</label>
        <input
          type="text"
          id="searchText"
          class="form-control"
          placeholder="Nh·∫≠p s·ªë gh·∫ø..."
        />
      </div>
      <div class="col-12 col-md-4">
        <label for="searchPhong" class="form-label mb-1">Ph√≤ng chi·∫øu</label>
        <select id="searchPhong" class="form-select">
          <option value="">-- Ch·ªçn ph√≤ng --</option>
        </select>
      </div>
      <div class="col-12 col-md-4">
        <label for="pageSize" class="form-label mb-1">Hi·ªÉn th·ªã</label>
        <select id="pageSize" class="form-select">
          <option value="5">5 d√≤ng</option>
          <option value="10" selected>10 d√≤ng</option>
          <option value="20">20 d√≤ng</option>
          <option value="50">50 d√≤ng</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table
        id="gheTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 90px">ID</th>
            <th style="width: 140px">S·ªë gh·∫ø</th>
            <th style="width: 160px">Lo·∫°i gh·∫ø</th>
            <th>Ph√≤ng</th>
            <th style="width: 1px">MaPhong (·∫©n)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      const BASE_URL = "https://localhost:7058";
      const API_GHE_ALL = `${BASE_URL}/api/Ghe/get-all`;
      const API_GHE_BY_PHONG = (id) =>
        `${BASE_URL}/api/ghe/get-by-phong?maPhong=${encodeURIComponent(id)}`;
      const API_PHONG_GET_ALL = `${BASE_URL}/api/phongchieu/get-all`;

      const $id = (s) => document.getElementById(s);

      let dt = null;
      let phongOptions = [];
      let dataRows = [];

      function showAlert(type, msg) {
        const box = $id("alertBox");
        box.className = `alert alert-${type}`;
        box.textContent = msg;
        box.style.display = "block";
      }
      function hideAlert() {
        $id("alertBox").style.display = "none";
      }

      const mapPhong = (x) => ({
        maPhong: x.maPhong ?? x.MaPhong ?? x.id ?? x.ID,
        tenPhong:
          x.tenPhong ??
          x.TenPhong ??
          x.name ??
          x.Name ??
          `Ph√≤ng ${x.maPhong ?? x.MaPhong ?? x.id ?? x.ID}`,
      });

      const mapGhe = (x) => ({
        maGhe: x.maGhe ?? x.MaGhe ?? x.id ?? x.ID,
        soGhe: x.soGhe ?? x.SoGhe ?? "",
        loaiGhe: x.loaiGhe ?? x.LoaiGhe ?? "",
        maPhong:
          x.maPhong ??
          x.MaPhong ??
          x.maPhongId ??
          x.MaPhongId ??
          x.phongId ??
          x.PhongId,
        tenPhong: x.tenPhong ?? x.TenPhong ?? x.name ?? x.Name ?? null,
        isDisabled: x.isDisabled ?? x.IsDisabled ?? false,
      });

      function renderLoaiGheBadge(val) {
        const v = (val || "").toString().toLowerCase();
        if (!v) return '<span class="text-muted">‚Äî</span>';
        if (v.includes("vip"))
          return '<span class="badge bg-warning-subtle text-warning-emphasis badge-seat">VIP</span>';
        if (v.includes("sweet"))
          return '<span class="badge bg-danger-subtle text-danger-emphasis badge-seat">Sweetbox</span>';
        return '<span class="badge bg-success-subtle text-success-emphasis badge-seat">Th∆∞·ªùng</span>';
      }

      async function loadPhongOptions() {
        try {
          const r = await fetch(API_PHONG_GET_ALL, { credentials: "include" });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const json = await r.json();
          phongOptions = (
            Array.isArray(json?.data)
              ? json.data
              : Array.isArray(json)
              ? json
              : []
          ).map(mapPhong);

          const sel = $id("searchPhong");
          sel.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
          phongOptions.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = String(p.maPhong);
            opt.textContent = p.tenPhong;
            sel.appendChild(opt);
          });

          const qs = new URLSearchParams(location.search);
          const maPhongQS = (qs.get("maPhong") || "").toString().trim();
          if (maPhongQS && [...sel.options].some((o) => o.value === maPhongQS))
            sel.value = maPhongQS;
        } catch (err) {
          console.error("loadPhongOptions error:", err);
          showAlert(
            "danger",
            "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ph√≤ng. Ki·ªÉm tra API /api/phongchieu/get-all v√† CORS/HTTPS."
          );
          phongOptions = [];
        }
      }

      async function loadSeats() {
        try {
          const selectedMaPhong = ($id("searchPhong").value || "").trim();
          const url = selectedMaPhong
            ? API_GHE_BY_PHONG(selectedMaPhong)
            : API_GHE_ALL;

          const r = await fetch(url, { credentials: "include" });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const json = await r.json();
          const arr = Array.isArray(json?.data)
            ? json.data
            : Array.isArray(json)
            ? json
            : [];
          dataRows = arr.map(mapGhe);

          // ‚úÖ b·ªè alert info khi ch∆∞a ch·ªçn ph√≤ng
          if (!dataRows.length) {
            showAlert(
              "warning",
              selectedMaPhong
                ? "Kh√¥ng c√≥ gh·∫ø cho ph√≤ng ƒë√£ ch·ªçn."
                : "Kh√¥ng c√≥ d·ªØ li·ªáu gh·∫ø."
            );
          } else {
            hideAlert();
          }
        } catch (err) {
          console.error("loadSeats error:", err);
          showAlert(
            "danger",
            "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch gh·∫ø. Ki·ªÉm tra API gh·∫ø v√† CORS/HTTPS."
          );
          dataRows = [];
        }
      }

      function toTableRows(rows) {
        return rows.map((r) => {
          const tenPhong =
            r.tenPhong ??
            phongOptions.find((p) => String(p.maPhong) === String(r.maPhong))
              ?.tenPhong ??
            `Ph√≤ng ${r.maPhong}`;
          return [
            r.maGhe,
            r.soGhe || "",
            renderLoaiGheBadge(r.loaiGhe),
            tenPhong,
            String(r.maPhong),
          ];
        });
      }

      function initTable() {
        if (dt) {
          dt.clear();
          dt.rows.add(toTableRows(dataRows)).draw();
          return;
        }
        $.fn.dataTable.ext.search.push((settings, rowData) => {
          if (settings.nTable !== $id("gheTable")) return true;
          const searchSeat = ($id("searchText").value || "")
            .toLowerCase()
            .trim();
          const soGhe = (rowData[1] ?? "").toString().toLowerCase();
          return !searchSeat || soGhe.includes(searchSeat);
        });

        dt = $("#gheTable").DataTable({
          data: toTableRows(dataRows),
          columns: [
            { title: "ID" },
            { title: "S·ªë gh·∫ø" },
            { title: "Lo·∫°i gh·∫ø" },
            { title: "Ph√≤ng" },
            { title: "MaPhong", visible: false, searchable: false },
          ],
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
          },
          pageLength: parseInt($id("pageSize").value) || 10,
          responsive: true,
          autoWidth: false,
          order: [[0, "asc"]],
          dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        });
      }

      $id("btnReload").addEventListener("click", async () => {
        hideAlert();
        await loadPhongOptions();
        await loadSeats();
        if (dt) {
          dt.clear();
          dt.rows.add(toTableRows(dataRows)).draw();
        } else {
          initTable();
        }
        dt.draw();
      });

      $id("pageSize").addEventListener("change", () => {
        const len = parseInt($id("pageSize").value) || 10;
        dt.page.len(len).draw();
      });
      $id("searchText").addEventListener("input", () => dt && dt.draw());

      $id("searchPhong").addEventListener("change", async () => {
        await loadSeats();
        if (dt) {
          dt.clear();
          dt.rows.add(toTableRows(dataRows)).draw();
          dt.draw();
        }
      });

      (async function boot() {
        hideAlert();
        await loadPhongOptions();
        await loadSeats();
        initTable();
        dt.draw();
      })();
    </script>
  </body>
</html>
