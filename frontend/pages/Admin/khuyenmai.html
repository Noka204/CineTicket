<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Khuy·∫øn m√£i</title>

    <!-- Bootstrap + DataTables (Bootstrap 5 theme) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
      .badge-kind {
        font-weight: 600;
        border: 1px solid rgba(0, 0, 0, 0.05);
      }
      .badge-percent {
        background: #ecfeff;
        color: #0284c7;
      }
      .badge-amount {
        background: #f0fdf4;
        color: #16a34a;
      }
      .badge-active {
        background: #eef2ff;
        color: #3f51b5;
        font-weight: 600;
      }
      .mono {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .toast-wrap {
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 1080;
      }
      .form-switch .form-check-input {
        cursor: pointer;
      }
      .small-muted {
        font-size: 12px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üè∑Ô∏è Qu·∫£n l√Ω Khuy·∫øn m√£i</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng Khuy·∫øn m√£i -->
    <div class="table-responsive">
      <table
        id="kmTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 80px">ID</th>
            <th>T√™n</th>
            <th style="width: 120px">Lo·∫°i</th>
            <th style="width: 140px">M·ª©c gi·∫£m</th>
            <th style="width: 120px">Tr·∫°ng th√°i</th>
            <th style="width: 220px">B·∫Øt ƒë·∫ßu</th>
            <th style="width: 220px">K·∫øt th√∫c</th>
            <th style="width: 280px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a Khuy·∫øn m√£i -->
    <div
      class="modal fade"
      id="kmModal"
      tabindex="-1"
      aria-labelledby="kmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="kmModalLabel" class="modal-title">Th√™m khuy·∫øn m√£i</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <form id="kmForm">
            <div class="modal-body">
              <input type="hidden" id="KmId" />
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">T√™n khuy·∫øn m√£i</label>
                  <input id="Ten" class="form-control" required />
                </div>
                <div class="col-md-4">
                  <label class="form-label d-block">K√≠ch ho·∫°t</label>
                  <div class="form-check form-switch mt-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="IsActive"
                      checked
                    />
                    <label class="form-check-label" for="IsActive"
                      >ƒêang b·∫≠t</label
                    >
                  </div>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Lo·∫°i gi·∫£m</label>
                  <select id="LoaiGiam" class="form-select">
                    <option value="1">Percent (%)</option>
                    <option value="2">Amount (ƒë)</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">M·ª©c gi·∫£m</label>
                  <input
                    id="MucGiam"
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control"
                    required
                  />
                  <div class="form-text small-muted">
                    % khi Percent. S·ªë ti·ªÅn (VND) khi Amount.
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">B·∫Øt ƒë·∫ßu</label>
                  <input
                    id="BatDau"
                    type="datetime-local"
                    class="form-control"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">K·∫øt th√∫c</label>
                  <input
                    id="KetThuc"
                    type="datetime-local"
                    class="form-control"
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Qu·∫£n l√Ω M√£ c·ªßa 1 Khuy·∫øn m√£i -->
    <div
      class="modal fade"
      id="codeModal"
      tabindex="-1"
      aria-labelledby="codeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 id="codeModalLabel" class="modal-title">M√£ khuy·∫øn m√£i</h5>
              <div id="codeModalSub" class="small-muted"></div>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <div class="modal-body">
            <!-- Form t·∫°o m√£ l·∫ª -->
            <div class="border rounded p-3 mb-3">
              <h6 class="mb-3">T·∫°o m√£ c·ª• th·ªÉ</h6>
              <form id="codeSingleForm" class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Code</label>
                  <input
                    id="CodeSingle"
                    class="form-control"
                    placeholder="VD: CINE-HELLO2025"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">G√°n cho UserId (tu·ª≥ ch·ªçn)</label>
                  <input
                    id="AssignUserSingle"
                    class="form-control"
                    placeholder="user-id"
                  />
                </div>
                <div class="col-md-4 align-self-end">
                  <button class="btn btn-primary w-100" type="submit">
                    ‚ûï T·∫°o m√£
                  </button>
                </div>
              </form>
            </div>

            <!-- Form t·∫°o lo·∫°t m√£ -->
            <div class="border rounded p-3 mb-3">
              <h6 class="mb-3">T·∫°o lo·∫°t m√£</h6>
              <form id="codeBulkForm" class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">S·ªë l∆∞·ª£ng</label>
                  <input
                    id="BulkCount"
                    type="number"
                    min="1"
                    step="1"
                    class="form-control"
                    value="5"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Prefix</label>
                  <input
                    id="BulkPrefix"
                    class="form-control"
                    placeholder="VD: CINE"
                  />
                </div>
                <div class="col-md-4">
                  <label class="form-label">G√°n cho UserId (tu·ª≥ ch·ªçn)</label>
                  <input
                    id="AssignUserBulk"
                    class="form-control"
                    placeholder="user-id"
                  />
                </div>
                <div class="col-md-2 align-self-end">
                  <button class="btn btn-outline-primary w-100" type="submit">
                    ‚öôÔ∏è Generate
                  </button>
                </div>
              </form>
            </div>

            <!-- B·∫£ng m√£ -->
            <div class="table-responsive">
              <table
                id="codeTable"
                class="table table-bordered table-striped align-middle text-center w-100"
              >
                <thead class="table-light">
                  <tr>
                    <th style="width: 80px">ID</th>
                    <th style="width: 200px">Code</th>
                    <th style="width: 220px">G√°n User</th>
                    <th style="width: 220px">RedeemedAt</th>
                    <th style="width: 160px">H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-wrap">
      <div
        id="toast"
        class="toast align-items-center border-0 text-white bg-success"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div id="toastBody" class="toast-body"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ================= Config ================= */
      const BASE_URL = "https://localhost:7058";
      const API = {
        promo: {
          list: `${BASE_URL}/api/admin/khuyenmai`, // GET
          get: (id) => `${BASE_URL}/api/admin/khuyenmai/${id}`, // GET
          create: `${BASE_URL}/api/admin/khuyenmai`, // POST
          update: (id) => `${BASE_URL}/api/admin/khuyenmai/${id}`, // PUT
          remove: (id) => `${BASE_URL}/api/admin/khuyenmai/${id}`, // DELETE
        },
        code: {
          byKm: (kmId) => `${BASE_URL}/api/admin/khuyenmaicode/by-km/${kmId}`, // GET
          create: `${BASE_URL}/api/admin/khuyenmaicode`, // POST (single or bulk)
          remove: (id) => `${BASE_URL}/api/admin/khuyenmaicode/${id}`, // DELETE
        },
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      /* ================= Helpers ================= */
      const $id = (s) => document.getElementById(s);

      function showToast(msg, kind = "success") {
        const toastEl = $id("toast");
        const toastBody = $id("toastBody");
        toastEl.className =
          "toast align-items-center border-0 text-white " +
          (kind === "success" ? "bg-success" : "bg-danger");
        toastBody.textContent = msg;
        new bootstrap.Toast(toastEl, { delay: 2200 }).show();
      }

      function mapPromo(x) {
        return {
          id: x.id ?? x.Id,
          ten: x.ten ?? x.Ten,
          isActive: x.isActive ?? x.IsActive,
          loaiGiam: x.loaiGiam ?? x.LoaiGiam, // 1=Percent, 2=Amount
          mucGiam: x.mucGiam ?? x.MucGiam,
          batDau: x.batDau ?? x.BatDau,
          ketThuc: x.ketThuc ?? x.KetThuc,
        };
      }

      function toLocalDateTimeValue(v) {
        if (!v) return "";
        const d = new Date(v);
        if (isNaN(d)) return "";
        // yyyy-MM-ddTHH:mm
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(
          d.getDate()
        )}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function toDisplayDateTime(v) {
        if (!v) return "";
        const d = new Date(v);
        return isNaN(d) ? "" : d.toLocaleString("vi-VN");
      }

      const VND = new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
      });
      function formatMucGiam(loai, val) {
        if (!Number.isFinite(Number(val))) return "";
        if (Number(loai) === 1) return `${val}%`;
        return VND.format(val);
      }

      function badgeLoai(loai) {
        if (Number(loai) === 1)
          return `<span class="badge badge-kind badge-percent">Percent</span>`;
        return `<span class="badge badge-kind badge-amount">Amount</span>`;
      }

      /* ================= State ================= */
      let dtPromo = null;
      let promos = [];
      let dtCode = null;
      let currentKmId = null;
      let currentKmTen = "";

      /* ================= Loaders ================= */
      async function loadPromos() {
        const r = await fetch(API.promo.list, { headers: { ...authHeader } });
        const j = await r.json();
        promos = (
          Array.isArray(j?.data) ? j.data : Array.isArray(j) ? j : []
        ).map(mapPromo);
        renderPromoTable();
      }

      async function loadCodes(kmId) {
        const r = await fetch(API.code.byKm(kmId), {
          headers: { ...authHeader },
        });
        const j = await r.json();
        const list = Array.isArray(j?.data)
          ? j.data
          : Array.isArray(j)
          ? j
          : [];
        renderCodeTable(list);
      }

      /* ================= Tables ================= */
      function renderPromoTable() {
        const rows = promos.map((p) => ({
          ...p,
          loaiHtml: badgeLoai(p.loaiGiam),
          mucGiamHtml: formatMucGiam(p.loaiGiam, p.mucGiam),
          activeHtml: p.isActive
            ? `<span class="badge badge-active">ƒêang b·∫≠t</span>`
            : `<span class="badge text-bg-secondary">T·∫Øt</span>`,
          batDauHtml: toDisplayDateTime(p.batDau),
          ketThucHtml: toDisplayDateTime(p.ketThuc),
        }));

        if (dtPromo) {
          dtPromo.clear();
          dtPromo.rows.add(rows).draw();
          return;
        }

        dtPromo = $("#kmTable").DataTable({
          data: rows,
          columns: [
            { data: "id" },
            { data: "ten" },
            { data: "loaiHtml", orderable: false, searchable: false },
            { data: "mucGiamHtml", className: "mono" },
            { data: "activeHtml", orderable: false, searchable: false },
            { data: "batDauHtml", className: "mono" },
            { data: "ketThucHtml", className: "mono" },
            {
              data: null,
              orderable: false,
              searchable: false,
              render: (row) => `
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                  <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.id}">S·ª≠a</button>
                  <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.id}">X√≥a</button>
                  <button class="btn btn-sm btn-dark"            data-act="codes" data-id="${row.id}" data-ten="${row.ten}">M√£‚Ä¶</button>
                </div>
              `,
            },
          ],
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
          },
          pageLength: 10,
          responsive: true,
          autoWidth: false,
          order: [[0, "desc"]],
          dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        });
      }

      function renderCodeTable(list) {
        const rows = list.map((x) => ({
          id: x.id ?? x.Id,
          code: x.code ?? x.Code,
          assignedToUserId: x.assignedToUserId ?? x.AssignedToUserId,
          redeemedAt: x.redeemedAt ?? x.RedeemedAt,
          redeemedAtHtml: x.redeemedAt
            ? `<span class="text-success">${toDisplayDateTime(
                x.redeemedAt
              )}</span>`
            : `<span class="text-muted">Ch∆∞a</span>`,
        }));

        if (dtCode) {
          dtCode.clear();
          dtCode.rows.add(rows).draw();
          return;
        }

        dtCode = $("#codeTable").DataTable({
          data: rows,
          columns: [
            { data: "id" },
            { data: "code" },
            { data: "assignedToUserId" },
            { data: "redeemedAtHtml", orderable: false },
            {
              data: null,
              orderable: false,
              searchable: false,
              render: (row) => `
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                  <button class="btn btn-sm btn-outline-danger" data-act="del-code" data-id="${row.id}">X√≥a</button>
                </div>
              `,
            },
          ],
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
          },
          pageLength: 10,
          responsive: true,
          autoWidth: false,
          order: [[0, "desc"]],
          dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        });
      }

      /* ================= Modals ================= */
      const kmModal = new bootstrap.Modal($id("kmModal"), {
        backdrop: "static",
      });
      const codeModal = new bootstrap.Modal($id("codeModal"), {
        backdrop: "static",
      });

      function resetKmForm() {
        $id("kmForm").reset();
        $id("KmId").value = "";
        $id("IsActive").checked = true;
        // set default LoaiGiam = Percent
        $id("LoaiGiam").value = "1";
      }

      function openKmCreate() {
        resetKmForm();
        $id("kmModalLabel").textContent = "Th√™m khuy·∫øn m√£i";
        kmModal.show();
      }

      function openKmEdit(promo) {
        resetKmForm();
        $id("kmModalLabel").textContent = "C·∫≠p nh·∫≠t khuy·∫øn m√£i";
        $id("KmId").value = promo.id;
        $id("Ten").value = promo.ten || "";
        $id("IsActive").checked = !!promo.isActive;
        $id("LoaiGiam").value = String(promo.loaiGiam || 1);
        $id("MucGiam").value = promo.mucGiam ?? "";
        $id("BatDau").value = toLocalDateTimeValue(promo.batDau);
        $id("KetThuc").value = toLocalDateTimeValue(promo.ketThuc);
        kmModal.show();
      }

      function openCodes(kmId, kmTen) {
        currentKmId = Number(kmId);
        currentKmTen = kmTen || "";
        $id("codeModalLabel").textContent = `M√£ cho khuy·∫øn m√£i #${kmId}`;
        $id("codeModalSub").textContent = kmTen ? `‚Äú${kmTen}‚Äù` : "";
        // reset forms
        $id("codeSingleForm").reset();
        $id("codeBulkForm").reset();
        $id("BulkCount").value = 5;
        $id("BulkPrefix").value = "KM";
        // load
        loadCodes(currentKmId);
        codeModal.show();
      }

      /* ================= Events ================= */
      // Th√™m m·ªõi
      $id("btnAdd").addEventListener("click", openKmCreate);

      // T·∫£i l·∫°i
      $id("btnReload").addEventListener("click", async () => {
        await loadPromos();
        showToast("ƒê√£ t·∫£i l·∫°i d·ªØ li·ªáu!", "success");
      });

      // Submit (Create/Update)
      $id("kmForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = $id("KmId").value.trim();
        const ten = $id("Ten").value.trim();
        const isActive = $id("IsActive").checked;
        const loaiGiam = Number($id("LoaiGiam").value || 1);
        const mucGiam = Number($id("MucGiam").value);
        const batDauVal = $id("BatDau").value;
        const ketThucVal = $id("KetThuc").value;

        if (!ten || !Number.isFinite(mucGiam) || mucGiam < 0) {
          showToast("T√™n & m·ª©c gi·∫£m kh√¥ng h·ª£p l·ªá.", "error");
          return;
        }

        const payload = {
          ten,
          isActive,
          loaiGiam,
          mucGiam,
          batDau: batDauVal ? new Date(batDauVal).toISOString() : null,
          ketThuc: ketThucVal ? new Date(ketThucVal).toISOString() : null,
        };

        try {
          let res;
          if (id) {
            payload.id = Number(id);
            res = await fetch(API.promo.update(id), {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                ...authHeader,
              },
              body: JSON.stringify(payload),
            });
          } else {
            res = await fetch(API.promo.create, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                ...authHeader,
              },
              body: JSON.stringify(payload),
            });
          }
          if (!res.ok) {
            let msg = "";
            try {
              msg = (await res.json())?.message || "";
            } catch {}
            throw new Error(msg || "L∆∞u kh√¥ng th√†nh c√¥ng.");
          }

          showToast(
            id ? "ƒê√£ c·∫≠p nh·∫≠t khuy·∫øn m√£i." : "ƒê√£ t·∫°o khuy·∫øn m√£i.",
            "success"
          );
          kmModal.hide();
          await loadPromos();
        } catch (err) {
          console.error(err);
          showToast(err.message || "L∆∞u kh√¥ng th√†nh c√¥ng.", "error");
        }
      });

      // Click actions trong b·∫£ng khuy·∫øn m√£i
      $("#kmTable").on("click", "button[data-act]", function () {
        const act = this.dataset.act;
        const id = Number(this.dataset.id);
        const ten = this.dataset.ten;
        const p = promos.find((x) => x.id === id);

        if (act === "edit") {
          if (!p) return showToast("Kh√¥ng t√¨m th·∫•y khuy·∫øn m√£i.", "error");
          openKmEdit(p);
        }
        if (act === "del") {
          if (!confirm(`X√≥a khuy·∫øn m√£i #${id}?`)) return;
          (async () => {
            try {
              const res = await fetch(API.promo.remove(id), {
                method: "DELETE",
                headers: { ...authHeader },
              });
              if (!res.ok) throw new Error("DELETE failed");
              showToast("ƒê√£ x√≥a khuy·∫øn m√£i.", "success");
              await loadPromos();
            } catch (e) {
              console.error(e);
              showToast("X√≥a kh√¥ng th√†nh c√¥ng.", "error");
            }
          })();
        }
        if (act === "codes") {
          openCodes(id, ten || (p ? p.ten : ""));
        }
      });

      // Submit t·∫°o m√£ ƒë∆°n l·∫ª
      $id("codeSingleForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentKmId) return showToast("Thi·∫øu Khuy·∫øn m√£i Id.", "error");
        const code = $id("CodeSingle").value.trim();
        const assign = $id("AssignUserSingle").value.trim();
        if (!code) return showToast("Vui l√≤ng nh·∫≠p code.", "error");

        try {
          const res = await fetch(API.code.create, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              ...authHeader,
            },
            body: JSON.stringify({
              khuyenMaiId: currentKmId,
              code,
              assignedToUserId: assign || null,
            }),
          });
          if (!res.ok) {
            let msg = "";
            try {
              msg = (await res.json())?.message || "";
            } catch {}
            throw new Error(msg || "T·∫°o m√£ th·∫•t b·∫°i.");
          }
          showToast("ƒê√£ t·∫°o m√£.", "success");
          $id("codeSingleForm").reset();
          await loadCodes(currentKmId);
        } catch (err) {
          console.error(err);
          showToast(err.message || "L·ªói t·∫°o m√£.", "error");
        }
      });

      // Submit t·∫°o lo·∫°t m√£
      $id("codeBulkForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentKmId) return showToast("Thi·∫øu Khuy·∫øn m√£i Id.", "error");
        const count = Number($id("BulkCount").value);
        const prefix = $id("BulkPrefix").value.trim() || "KM";
        const assign = $id("AssignUserBulk").value.trim();

        if (!Number.isInteger(count) || count <= 0)
          return showToast("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.", "error");

        try {
          const res = await fetch(API.code.create, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              ...authHeader,
            },
            body: JSON.stringify({
              khuyenMaiId: currentKmId,
              count,
              prefix,
              assignedToUserId: assign || null,
            }),
          });
          if (!res.ok) {
            let msg = "";
            try {
              msg = (await res.json())?.message || "";
            } catch {}
            throw new Error(msg || "Generate th·∫•t b·∫°i.");
          }
          showToast("ƒê√£ t·∫°o lo·∫°t m√£.", "success");
          $id("codeBulkForm").reset();
          $id("BulkCount").value = 5;
          $id("BulkPrefix").value = "KM";
          await loadCodes(currentKmId);
        } catch (err) {
          console.error(err);
          showToast(err.message || "L·ªói generate.", "error");
        }
      });

      // Click actions trong b·∫£ng m√£
      $("#codeTable").on("click", "button[data-act]", function () {
        const act = this.dataset.act;
        const id = Number(this.dataset.id);
        if (act === "del-code") {
          if (!confirm(`X√≥a m√£ #${id}?`)) return;
          (async () => {
            try {
              const res = await fetch(API.code.remove(id), {
                method: "DELETE",
                headers: { ...authHeader },
              });
              if (!res.ok) throw new Error("DELETE failed");
              showToast("ƒê√£ x√≥a m√£.", "success");
              await loadCodes(currentKmId);
            } catch (e) {
              console.error(e);
              showToast("X√≥a kh√¥ng th√†nh c√¥ng.", "error");
            }
          })();
        }
      });

      /* ================= Boot ================= */
      (async function boot() {
        await loadPromos();
      })();
    </script>
  </body>
</html>
