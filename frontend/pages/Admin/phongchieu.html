<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Ph√≤ng Chi·∫øu</title>

    <!-- Bootstrap + DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üè¢ Qu·∫£n l√Ω Ph√≤ng Chi·∫øu</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="phongTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 90px">ID</th>
            <th>T√™n ph√≤ng</th>
            <th style="width: 120px">S·ªë gh·∫ø</th>
            <th style="width: 180px">R·∫°p</th>
            <th style="width: 160px">Chi ti·∫øt</th>
            <th style="width: 220px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a -->
    <div
      class="modal fade"
      id="phongModal"
      tabindex="-1"
      aria-labelledby="phongModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="phongModalLabel" class="modal-title">Th√™m ph√≤ng chi·∫øu</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <form id="phongForm">
            <div class="modal-body">
              <input type="hidden" id="MaPhong" />
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="TenPhong" class="form-label">T√™n ph√≤ng</label>
                  <input
                    type="text"
                    id="TenPhong"
                    class="form-control"
                    required
                    placeholder="VD: Ph√≤ng 1, Deluxe, VIP..."
                  />
                </div>
                <div class="col-md-3">
                  <label for="SoGhe" class="form-label">S·ªë gh·∫ø</label>
                  <input
                    type="number"
                    id="SoGhe"
                    class="form-control"
                    min="1"
                    step="1"
                    required
                    placeholder="VD: 120"
                  />
                </div>
                <div class="col-md-3">
                  <label for="MaRap" class="form-label">R·∫°p</label>
                  <select id="MaRap" class="form-select" required>
                    <option value="">-- Ch·ªçn r·∫°p --</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* =============== Config API =============== */
      const BASE_URL = "https://localhost:7058";
      const API = {
        list: `${BASE_URL}/api/PhongChieu/get-all`, // GET
        create: `${BASE_URL}/api/PhongChieu/create`, // POST JSON(CreatePhongChieuRequest)
        update: (id) => `${BASE_URL}/api/PhongChieu/update/${id}`, // PUT  JSON (c√≥ MaPhong)
        remove: (id) => `${BASE_URL}/api/PhongChieu/delete/${id}`, // DELETE
        raps: `${BASE_URL}/api/Rap/get-all`, // GET danh s√°ch r·∫°p
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      /* =============== Helpers & Mapping =============== */
      const $id = (s) => document.getElementById(s);

      // Map ph√≤ng: ch·∫•p nh·∫≠n camelCase/PascalCase
      const mapPhong = (x) => ({
        maPhong: x.maPhong ?? x.MaPhong,
        tenPhong: x.tenPhong ?? x.TenPhong,
        soGhe: x.soGhe ?? x.SoGhe,
        maRap: x.maRap ?? x.MaRap,
        tenRap: x.tenRap ?? x.TenRap,
      });

      // Map r·∫°p
      const mapRap = (x) => ({
        maRap: x.maRap ?? x.MaRap,
        tenRap:
          x.tenRap ??
          x.TenRap ??
          x.ten ??
          x.Ten ??
          `R·∫°p #${x.maRap ?? x.MaRap}`,
      });

      let dt = null;
      let rapOptions = []; // [{maRap, tenRap}]

      /* =============== Loaders =============== */
      async function loadRaps() {
        const r = await fetch(API.raps, { headers: { ...authHeader } });
        const json = await r.json();
        rapOptions = (
          Array.isArray(json?.data)
            ? json.data
            : Array.isArray(json)
            ? json
            : []
        ).map(mapRap);

        const sel = $id("MaRap");
        sel.innerHTML = '<option value="">-- Ch·ªçn r·∫°p --</option>';
        rapOptions.forEach((rap) => {
          const opt = document.createElement("option");
          opt.value = rap.maRap;
          opt.textContent = rap.tenRap;
          sel.appendChild(opt);
        });
      }

      async function loadTable() {
        try {
          const r = await fetch(API.list, { headers: { ...authHeader } });
          const json = await r.json();
          const rows = (
            Array.isArray(json?.data)
              ? json.data
              : Array.isArray(json)
              ? json
              : []
          ).map(mapPhong);

          if (dt) {
            dt.clear();
            dt.rows.add(rows).draw();
            return;
          }

          dt = $("#phongTable").DataTable({
            data: rows,
            columns: [
              { data: "maPhong" },
              { data: "tenPhong" },
              {
                data: "soGhe",
                render: (v) =>
                  v != null ? Number(v).toLocaleString("vi-VN") : "",
              },
              {
                data: null,
                render: (row) =>
                  row.tenRap ||
                  (rapOptions.find((r) => r.maRap === row.maRap)?.tenRap ??
                    `R·∫°p #${row.maRap}`),
              },
              {
                data: null,
                orderable: false,
                searchable: false,
                render: (row) =>
                  `<a class="btn btn-sm btn-info" href="ghe.html?maPhong=${encodeURIComponent(
                    row.maPhong
                  )}" title="Xem chi ti·∫øt gh·∫ø">ü™ë Gh·∫ø</a>`,
              },
              {
                data: null,
                orderable: false,
                searchable: false,
                render: (row) =>
                  `<div class="d-flex flex-wrap gap-2 justify-content-center">
                   <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.maPhong}">S·ª≠a</button>
                   <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.maPhong}">X√≥a</button>
                 </div>`,
              },
            ],
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
            },
            pageLength: 10,
            responsive: true,
            autoWidth: false,
            order: [[0, "asc"]],
            dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          });
        } catch (e) {
          console.error(e);
          alert("‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph√≤ng chi·∫øu.");
        }
      }

      /* =============== Modal & CRUD =============== */
      const bsModal = new bootstrap.Modal(
        document.getElementById("phongModal"),
        { backdrop: "static" }
      );

      function resetForm() {
        $id("phongForm").reset();
        $id("MaPhong").value = "";
        // gi·ªØ options r·∫°p; ch·ªâ reset l·ª±a ch·ªçn
        $id("MaRap").value = "";
      }

      // Th√™m m·ªõi
      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("phongModalLabel").textContent = "Th√™m ph√≤ng chi·∫øu";
        bsModal.show();
      });

      // T·∫£i l·∫°i
      $id("btnReload").addEventListener("click", async () => {
        await loadRaps();
        await loadTable();
      });

      // Submit (Create/Update)
      $id("phongForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = $id("MaPhong").value.trim();
        const tenPhong = $id("TenPhong").value.trim();
        const soGheVal = Number($id("SoGhe").value);
        const maRapVal = Number($id("MaRap").value);

        if (!tenPhong) return alert("‚ùå T√™n ph√≤ng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
        if (!Number.isFinite(soGheVal) || soGheVal <= 0)
          return alert("‚ùå S·ªë gh·∫ø ph·∫£i > 0");
        if (!Number.isFinite(maRapVal) || maRapVal <= 0)
          return alert("‚ùå Vui l√≤ng ch·ªçn r·∫°p");

        // theo DTO CreatePhongChieuRequest
        const body = { tenPhong, soGhe: soGheVal, maRap: maRapVal };

        try {
          let res;
          if (id) {
            // update: backend th∆∞·ªùng nh·∫≠n ƒë·ªß fields + MaPhong
            const updatePayload = { maPhong: Number(id), ...body };
            res = await fetch(API.update(id), {
              method: "PUT",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(updatePayload),
            });
          } else {
            res = await fetch(API.create, {
              method: "POST",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(body),
            });
          }

          if (!res.ok) throw new Error((await res.text()) || "Request failed");

          alert(id ? "‚úÖ ƒê√£ c·∫≠p nh·∫≠t ph√≤ng" : "‚úÖ ƒê√£ th√™m ph√≤ng");
          bsModal.hide();
          await loadTable();
        } catch (err) {
          console.error(err);
          alert("‚ùå L∆∞u kh√¥ng th√†nh c√¥ng");
        }
      });

      // H√†nh ƒë·ªông trong b·∫£ng: edit / delete
      $("#phongTable").on("click", "button[data-act]", async function () {
        const act = this.dataset.act;
        const id = this.dataset.id;

        if (act === "edit") {
          try {
            // l·∫•y t·ª´ DataTables
            const rowData = dt.row($(this).closest("tr")).data();
            const p = rowData ? mapPhong(rowData) : null;
            if (!p) return alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu ph√≤ng.");

            $id("MaPhong").value = p.maPhong ?? "";
            $id("TenPhong").value = p.tenPhong ?? "";
            $id("SoGhe").value = p.soGhe ?? 0;

            // ch·ªçn r·∫°p ƒë√∫ng
            if (p.maRap) $id("MaRap").value = String(p.maRap);

            $id("phongModalLabel").textContent = "C·∫≠p nh·∫≠t ph√≤ng chi·∫øu";
            bsModal.show();
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói l·∫•y d·ªØ li·ªáu ph√≤ng.");
          }
        }

        if (act === "del") {
          if (!confirm(`X√≥a ph√≤ng #${id}?`)) return;
          try {
            const res = await fetch(API.remove(id), {
              method: "DELETE",
              headers: { ...authHeader },
            });
            if (!res.ok) throw new Error("DELETE failed");
            alert("‚úÖ ƒê√£ x√≥a ph√≤ng");
            await loadTable();
          } catch (err) {
            console.error(err);
            alert("‚ùå X√≥a kh√¥ng th√†nh c√¥ng");
          }
        }
      });

      /* =============== Boot =============== */
      document.addEventListener("DOMContentLoaded", async () => {
        await loadRaps();
        await loadTable();
      });
    </script>
  </body>
</html>
