<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Lo·∫°i Phim</title>

    <!-- Bootstrap + DataTables (Bootstrap 5 theme) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üìÇ Qu·∫£n l√Ω Lo·∫°i Phim</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="loaiPhimTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 90px">ID</th>
            <th>T√™n lo·∫°i phim</th>
            <th style="width: 220px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a -->
    <div
      class="modal fade"
      id="lpModal"
      tabindex="-1"
      aria-labelledby="lpModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="lpModalLabel" class="modal-title">Th√™m lo·∫°i phim</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <form id="lpForm">
            <div class="modal-body">
              <input type="hidden" id="MaLoaiPhim" />
              <div class="mb-3">
                <label for="TenLoaiPhim" class="form-label"
                  >T√™n lo·∫°i phim</label
                >
                <input
                  type="text"
                  id="TenLoaiPhim"
                  class="form-control"
                  required
                  placeholder="VD: H√†nh ƒë·ªông, Kinh d·ªã, Ho·∫°t h√¨nh..."
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ============== Config API ============== */
      const API_BASE = "https://localhost:7058/api/loaiphim";
      const API = {
        list: `${API_BASE}/get-all`, // GET
        create: `${API_BASE}/create`, // POST
        update: (id) => `${API_BASE}/update/${id}`, // PUT
        remove: (id) => `${API_BASE}/delete/${id}`, // DELETE
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      /* ============== Helpers ============== */
      const $id = (s) => document.getElementById(s);
      const mapLoaiPhim = (x) => ({
        maLoaiPhim: x.maLoaiPhim ?? x.MaLoaiPhim,
        tenLoaiPhim: x.tenLoaiPhim ?? x.TenLoaiPhim,
      });

      let dt = null;

      /* ============== Load & Table ============== */
      async function loadTable() {
        try {
          const r = await fetch(API.list, { headers: { ...authHeader } });
          const json = await r.json();
          const rows = (
            Array.isArray(json?.data)
              ? json.data
              : Array.isArray(json)
              ? json
              : []
          ).map(mapLoaiPhim);

          if (dt) {
            dt.clear();
            dt.rows.add(rows).draw();
            return;
          }

          dt = $("#loaiPhimTable").DataTable({
            data: rows,
            columns: [
              { data: "maLoaiPhim" },
              { data: "tenLoaiPhim" },
              {
                data: null,
                orderable: false,
                searchable: false,
                render: (row) => `
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                  <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.maLoaiPhim}">S·ª≠a</button>
                  <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.maLoaiPhim}">X√≥a</button>
                </div>`,
              },
            ],
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
            },
            pageLength: 10,
            responsive: true,
            autoWidth: false,
            order: [[0, "asc"]],
            dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
          });
        } catch (e) {
          console.error(e);
          alert("‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch lo·∫°i phim.");
        }
      }

      /* ============== Modal & CRUD ============== */
      const bsModal = new bootstrap.Modal(document.getElementById("lpModal"), {
        backdrop: "static",
      });

      function resetForm() {
        $id("lpForm").reset();
        $id("MaLoaiPhim").value = "";
      }

      // Th√™m m·ªõi
      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("lpModalLabel").textContent = "Th√™m lo·∫°i phim";
        bsModal.show();
      });

      // T·∫£i l·∫°i
      $id("btnReload").addEventListener("click", loadTable);

      // Submit (Create/Update)
      $id("lpForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = $id("MaLoaiPhim").value.trim();
        const ten = $id("TenLoaiPhim").value.trim();
        if (!ten) return alert("‚ùå Vui l√≤ng nh·∫≠p t√™n lo·∫°i phim.");

        try {
          let res;
          if (id) {
            const body = { maLoaiPhim: Number(id), tenLoaiPhim: ten };
            res = await fetch(API.update(id), {
              method: "PUT",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(body),
            });
          } else {
            const createPayload = { tenLoaiPhim: ten };
            res = await fetch(API.create, {
              method: "POST",
              headers: { "Content-Type": "application/json", ...authHeader },
              body: JSON.stringify(createPayload),
            });
          }

          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || "Request failed");
          }

          alert(id ? "‚úÖ ƒê√£ c·∫≠p nh·∫≠t lo·∫°i phim" : "‚úÖ ƒê√£ th√™m lo·∫°i phim");
          bsModal.hide();
          await loadTable();
        } catch (err) {
          console.error(err);
          alert("‚ùå L∆∞u kh√¥ng th√†nh c√¥ng");
        }
      });

      // H√†nh ƒë·ªông trong b·∫£ng: edit / delete
      $("#loaiPhimTable").on("click", "button[data-act]", async function () {
        const act = this.dataset.act;
        const id = this.dataset.id;

        if (act === "edit") {
          try {
            // L·∫•y t·ª´ DataTables (ƒë√£ c√≥ d·ªØ li·ªáu)
            const rowData = dt.row($(this).closest("tr")).data();
            const lp = rowData ? mapLoaiPhim(rowData) : null;
            if (!lp) return alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu.");

            $id("MaLoaiPhim").value = lp.maLoaiPhim ?? "";
            $id("TenLoaiPhim").value = lp.tenLoaiPhim ?? "";

            $id("lpModalLabel").textContent = "C·∫≠p nh·∫≠t lo·∫°i phim";
            bsModal.show();
          } catch (err) {
            console.error(err);
            alert("‚ùå L·ªói l·∫•y d·ªØ li·ªáu.");
          }
        }

        if (act === "del") {
          if (!confirm(`X√≥a lo·∫°i phim #${id}?`)) return;
          try {
            const res = await fetch(API.remove(id), {
              method: "DELETE",
              headers: { ...authHeader },
            });
            if (!res.ok) throw new Error("DELETE failed");
            alert("‚úÖ ƒê√£ x√≥a lo·∫°i phim");
            await loadTable();
          } catch (err) {
            console.error(err);
            alert("‚ùå X√≥a kh√¥ng th√†nh c√¥ng");
          }
        }
      });

      /* ============== Boot ============== */
      document.addEventListener("DOMContentLoaded", loadTable);
    </script>
  </body>
</html>
