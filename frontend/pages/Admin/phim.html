<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω Phim</title>

    <!-- Bootstrap + DataTables (Bootstrap 5 theme) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px;
      }
      h2 {
        font-weight: 700;
      }
      .dt-container .row {
        align-items: center;
      }
      .poster-thumb {
        width: 56px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }
      .badge-genre {
        font-weight: 600;
        border: 1px solid rgba(0, 0, 0, 0.05);
        background: #eef2ff;
        color: #3f51b5;
      }
      .mono {
        font-variant-numeric: tabular-nums;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
      .toast-wrap {
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 1080;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>üé¨ Qu·∫£n l√Ω Phim</h2>
      <div class="d-flex gap-2">
        <a href="../Admin/index.html" class="btn btn-outline-dark"
          >üîô Quay l·∫°i</a
        >
        <button id="btnReload" class="btn btn-outline-secondary">
          ‚Üª T·∫£i l·∫°i
        </button>
        <button id="btnAdd" class="btn btn-primary">‚ûï Th√™m</button>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-responsive">
      <table
        id="phimTable"
        class="table table-bordered table-striped align-middle text-center w-100"
      >
        <thead class="table-light">
          <tr>
            <th style="width: 80px">ID</th>
            <th style="width: 70px">Poster</th>
            <th>T√™n phim</th>
            <th style="width: 110px">Th·ªùi l∆∞·ª£ng</th>
            <th>ƒê·∫°o di·ªÖn</th>
            <th>Ng√¥n ng·ªØ</th>
            <th>Di·ªÖn vi√™n</th>
            <th style="width: 140px">Kh·ªüi chi·∫øu</th>
            <th>Trailer</th>
            <th>Lo·∫°i</th>
            <th style="width: 200px">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a -->
    <div
      class="modal fade"
      id="phimModal"
      tabindex="-1"
      aria-labelledby="phimModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 id="phimModalLabel" class="modal-title">Th√™m phim</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <form id="phimForm" enctype="multipart/form-data">
            <div class="modal-body">
              <input type="hidden" id="MaPhim" />
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">T√™n phim</label>
                  <input id="TenPhim" class="form-control" required />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
                  <input
                    id="ThoiLuong"
                    type="number"
                    min="1"
                    step="1"
                    class="form-control"
                    required
                  />
                </div>

                <div class="col-md-6">
                  <label class="form-label">ƒê·∫°o di·ªÖn</label>
                  <input id="DaoDien" class="form-control" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Ng√¥n ng·ªØ</label>
                  <input id="NgonNgu" class="form-control" />
                </div>

                <div class="col-md-12">
                  <label class="form-label">Di·ªÖn vi√™n</label>
                  <input
                    id="DienVien"
                    class="form-control"
                    placeholder="NgƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y"
                  />
                </div>

                <div class="col-md-4">
                  <label class="form-label">Kh·ªüi chi·∫øu</label>
                  <input id="KhoiChieu" type="date" class="form-control" />
                </div>
                <div class="col-md-4">
                  <label class="form-label">Trailer (URL)</label>
                  <input id="Trailer" class="form-control" />
                </div>

                <!-- Upload lu√¥n hi·ªÉn th·ªã; v·ªõi Update s·∫Ω x·ª≠ l√Ω b·∫±ng endpoint ri√™ng -->
                <div class="col-md-6">
                  <label class="form-label">Poster (·∫£nh)</label>
                  <input
                    id="PosterFile"
                    type="file"
                    class="form-control"
                    accept="image/*"
                  />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Banner (·∫£nh)</label>
                  <input
                    id="BannerFile"
                    type="file"
                    class="form-control"
                    accept="image/*"
                  />
                </div>

                <div class="col-12">
                  <label class="form-label">M√¥ t·∫£</label>
                  <textarea id="MoTa" class="form-control" rows="3"></textarea>
                </div>

                <div class="col-12">
                  <label class="form-label">C√°c lo·∫°i phim</label>
                  <div id="LoaiPhimChecks" class="d-flex flex-wrap gap-3"></div>
                  <div class="form-text">
                    Qu·∫£n l√Ω danh m·ª•c lo·∫°i t·∫°i
                    <a href="../Admin/loaiphim.html">Lo·∫°i Phim</a>.
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-outline-secondary"
                data-bs-dismiss="modal"
              >
                H·ªßy
              </button>
              <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-wrap">
      <div
        id="toast"
        class="toast align-items-center border-0 text-white bg-success"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div id="toastBody" class="toast-body"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

    <script>
      /* ================= Config ================= */
      const BASE_URL = "https://localhost:7058";
      const API = {
        list: `${BASE_URL}/api/Phim/get-all`, // GET
        create: `${BASE_URL}/api/Phim/create`, // POST (multipart)
        update: (id) => `${BASE_URL}/api/Phim/update/${id}`, // PUT (JSON - d√πng DTO c≈©)
        updatePoster: (id) => `${BASE_URL}/api/Phim/update-poster/${id}`, // PUT (multipart)
        updateBanner: (id) => `${BASE_URL}/api/Phim/update-banner/${id}`, // PUT (multipart)
        remove: (id) => `${BASE_URL}/api/Phim/delete/${id}`, // DELETE
        loaiAll: `${BASE_URL}/api/LoaiPhim/get-all`, // GET
      };
      const token = localStorage.getItem("token");
      const authHeader = token ? { Authorization: `Bearer ${token}` } : {};

      function absUrl(u) {
        if (!u) return "";
        if (/^https?:\/\//i.test(u)) return u;
        const clean = String(u).replace(/^\/?wwwroot\//i, "");
        return `${BASE_URL.replace(/\/+$/, "")}/${clean.replace(/^\/+/, "")}`;
      }

      const $id = (s) => document.getElementById(s);

      // Helper: convert server date -> yyyy-MM-dd
      function toInputDate(v) {
        if (!v) return "";
        const d = new Date(v);
        if (!isNaN(d)) return d.toISOString().slice(0, 10);
        if (typeof v === "string") {
          const parts = v.split(/[\/\-\.]/);
          if (parts.length === 3) {
            const a = Number(parts[0]);
            const b = Number(parts[1]);
            const c = Number(parts[2]);
            if (c >= 1900 && a <= 31 && b <= 12) {
              const d2 = new Date(Date.UTC(c, b - 1, a));
              if (!isNaN(d2)) return d2.toISOString().slice(0, 10);
            }
          }
        }
        return "";
      }

      const mapLoai = (x) => ({
        maLoaiPhim: x.maLoaiPhim ?? x.MaLoaiPhim,
        tenLoaiPhim: x.tenLoaiPhim ?? x.TenLoaiPhim,
      });

      const mapPhim = (x) => ({
        maPhim: x.maPhim ?? x.MaPhim,
        tenPhim: x.tenPhim ?? x.TenPhim,
        thoiLuong: x.thoiLuong ?? x.ThoiLuong,
        daoDien: x.daoDien ?? x.DaoDien,
        ngonNgu: x.ngonNgu ?? x.NgonNgu,
        dienVien: x.dienVien ?? x.DienVien,
        khoiChieu: x.khoiChieu ?? x.KhoiChieu,
        moTa: x.moTa ?? x.MoTa,
        poster: x.poster ?? x.Poster,
        banner: x.banner ?? x.Banner,
        trailer: x.trailer ?? x.Trailer,
        loaiPhims: x.loaiPhims ?? x.LoaiPhims ?? [],
      });

      /* ================= State ================= */
      let dt = null;
      let loaiPhimList = [];
      let phimRows = [];
      const toastEl = $id("toast");
      const toastBody = $id("toastBody");
      const toast = new bootstrap.Toast(toastEl, { delay: 2200 });
      function showToast(msg, kind = "success") {
        toastEl.className =
          "toast align-items-center border-0 text-white " +
          (kind === "success" ? "bg-success" : "bg-danger");
        toastBody.textContent = msg;
        toast.show();
      }

      /* ================= Loaders ================= */
      async function loadLoaiPhim() {
        const r = await fetch(API.loaiAll, { headers: { ...authHeader } });
        const j = await r.json();
        loaiPhimList = (
          Array.isArray(j?.data) ? j.data : Array.isArray(j) ? j : []
        ).map(mapLoai);

        const box = $id("LoaiPhimChecks");
        box.innerHTML = "";
        loaiPhimList.forEach((lp) => {
          const id = `lp-${lp.maLoaiPhim}`;
          box.insertAdjacentHTML(
            "beforeend",
            `<div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="${id}" value="${lp.maLoaiPhim}">
              <label class="form-check-label" for="${id}">${lp.tenLoaiPhim}</label>
            </div>`
          );
        });
      }

      async function loadPhim() {
        const r = await fetch(API.list, { headers: { ...authHeader } });
        const j = await r.json();
        phimRows = (
          Array.isArray(j?.data) ? j.data : Array.isArray(j) ? j : []
        ).map(mapPhim);
        renderTable();
      }

      /* ================= Table ================= */
      function renderTable() {
        const rows = phimRows.map((p) => {
          const posterUrl = absUrl(p.poster);
          return {
            ...p,
            posterThumb: posterUrl
              ? `<img class="poster-thumb" src="${posterUrl}" alt="poster">`
              : "",
            trailerLink: p.trailer
              ? `<a href="${p.trailer}" target="_blank" rel="noopener">Xem</a>`
              : "",
            loaiHtml: (p.loaiPhims || [])
              .map(
                (lp) =>
                  `<span class="badge badge-genre me-1 mb-1">${
                    lp.tenLoaiPhim || ""
                  }</span>`
              )
              .join(" "),
          };
        });

        if (dt) {
          dt.clear();
          dt.rows.add(rows).draw();
          return;
        }

        dt = $("#phimTable").DataTable({
          data: rows,
          columns: [
            { data: "maPhim" },
            { data: "posterThumb", orderable: false, searchable: false },
            { data: "tenPhim" },
            { data: "thoiLuong", render: (v) => (v ? `${v}‚Äô` : "") },
            { data: "daoDien" },
            { data: "ngonNgu" },
            { data: "dienVien" },
            {
              data: "khoiChieu",
              className: "mono",
              render: (v) => (v ? new Date(v).toLocaleDateString("vi-VN") : ""),
            },
            { data: "trailerLink", orderable: false, searchable: false },
            { data: "loaiHtml", orderable: false, searchable: true },
            {
              data: null,
              orderable: false,
              searchable: false,
              render: (row) => `
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                  <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${row.maPhim}">S·ª≠a</button>
                  <button class="btn btn-sm btn-outline-danger"  data-act="del"  data-id="${row.maPhim}">X√≥a</button>
                </div>`,
            },
          ],
          columnDefs: [
            {
              targets: 1,
              createdCell: (td, _c, row) => (td.innerHTML = row.posterThumb),
            },
            {
              targets: 8,
              createdCell: (td, _c, row) => (td.innerHTML = row.trailerLink),
            },
            {
              targets: 9,
              createdCell: (td, _c, row) => (td.innerHTML = row.loaiHtml),
            },
          ],
          language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/vi.json",
          },
          pageLength: 10,
          responsive: true,
          autoWidth: false,
          order: [[0, "asc"]],
          dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        });
      }

      /* ================= Modal & CRUD ================= */
      const bsModal = new bootstrap.Modal(
        document.getElementById("phimModal"),
        { backdrop: "static" }
      );

      function resetForm() {
        $id("phimForm").reset();
        $id("MaPhim").value = "";
        document
          .querySelectorAll("#LoaiPhimChecks input[type='checkbox']")
          .forEach((cb) => (cb.checked = false));
      }

      // Th√™m
      $id("btnAdd").addEventListener("click", () => {
        resetForm();
        $id("phimModalLabel").textContent = "Th√™m phim";
        bsModal.show();
      });

      // T·∫£i l·∫°i
      $id("btnReload").addEventListener("click", async () => {
        await loadLoaiPhim();
        await loadPhim();
        showToast("ƒê√£ t·∫£i l·∫°i d·ªØ li·ªáu!", "success");
      });

      // Submit (Create / Update)
      $id("phimForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = $id("MaPhim").value.trim();
        const tenPhim = $id("TenPhim").value.trim();
        const thoiLuong = Number($id("ThoiLuong").value);
        if (!tenPhim || !Number.isFinite(thoiLuong) || thoiLuong <= 0) {
          showToast("Vui l√≤ng nh·∫≠p t√™n phim & th·ªùi l∆∞·ª£ng h·ª£p l·ªá.", "error");
          return;
        }

        const selectedLoaiIds = Array.from(
          document.querySelectorAll(
            "#LoaiPhimChecks input[type='checkbox']:checked"
          )
        ).map((cb) => Number(cb.value));

        const poster = $id("PosterFile").files[0];
        const banner = $id("BannerFile").files[0];

        try {
          let res;

          if (id) {
            // ===== UPDATE theo DTO c≈©: G·ª¨I JSON tr∆∞·ªõc =====
            const bodyJson = {
              maPhim: Number(id),
              tenPhim,
              thoiLuong,
              daoDien: $id("DaoDien").value.trim(),
              ngonNgu: $id("NgonNgu").value.trim(),
              dienVien: $id("DienVien").value.trim(),
              khoiChieu: $id("KhoiChieu").value || null,
              moTa: $id("MoTa").value.trim(),
              trailer: $id("Trailer").value.trim(),
              loaiPhims: selectedLoaiIds.map((x) => ({
                maLoaiPhim: x,
                tenLoaiPhim: "",
              })), // kh·ªõp LoaiPhimDTO
              // IsHot, Poster, Banner (string) kh√¥ng c·∫ßn g·ª≠i ·ªü ƒë√¢y
            };

            res = await fetch(API.update(id), {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                ...authHeader,
              },
              body: JSON.stringify(bodyJson),
            });

            if (!res.ok) {
              let msg = "";
              try {
                msg = (await res.json())?.message || "";
              } catch {}
              throw new Error(msg || "Update JSON failed");
            }

            // ===== N·∫øu c√≥ file, g·ªçi endpoint upload ri√™ng =====
            if (poster) {
              const f = new FormData();
              f.append("poster", poster);
              const up = await fetch(API.updatePoster(id), {
                method: "PUT",
                headers: { ...authHeader },
                body: f,
              });
              if (!up.ok) {
                let msg = "";
                try {
                  msg = (await up.json())?.message || "";
                } catch {}
                showToast("C·∫≠p nh·∫≠t poster l·ªói: " + msg, "error");
              }
            }
            if (banner) {
              const f = new FormData();
              f.append("banner", banner);
              const up = await fetch(API.updateBanner(id), {
                method: "PUT",
                headers: { ...authHeader },
                body: f,
              });
              if (!up.ok) {
                let msg = "";
                try {
                  msg = (await up.json())?.message || "";
                } catch {}
                showToast("C·∫≠p nh·∫≠t banner l·ªói: " + msg, "error");
              }
            }
          } else {
            // ===== CREATE: multipart nh∆∞ c≈© =====
            const form = new FormData();
            form.append("tenPhim", tenPhim);
            form.append("thoiLuong", thoiLuong);
            form.append("daoDien", $id("DaoDien").value.trim());
            form.append("ngonNgu", $id("NgonNgu").value.trim());
            form.append("dienVien", $id("DienVien").value.trim());
            form.append("khoiChieu", $id("KhoiChieu").value || "");
            form.append("moTa", $id("MoTa").value.trim());
            form.append("trailer", $id("Trailer").value.trim());
            if (poster) form.append("poster", poster);
            if (banner) form.append("banner", banner);
            selectedLoaiIds.forEach((lid) => form.append("maLoaiPhims", lid));

            res = await fetch(API.create, {
              method: "POST",
              headers: { ...authHeader },
              body: form,
            });
            if (!res.ok) {
              let msg = "";
              try {
                msg = (await res.json())?.message || "";
              } catch {}
              throw new Error(msg || "Create failed");
            }
          }

          showToast(id ? "ƒê√£ c·∫≠p nh·∫≠t phim." : "ƒê√£ th√™m phim.", "success");
          bsModal.hide();
          await loadPhim();
        } catch (err) {
          console.error(err);
          showToast("L∆∞u kh√¥ng th√†nh c√¥ng. " + err.message, "error");
        }
      });

      // Click actions trong b·∫£ng
      $("#phimTable").on("click", "button[data-act]", async function () {
        const act = this.dataset.act;
        const id = this.dataset.id;

        if (act === "edit") {
          const rowData = dt.row($(this).closest("tr")).data();
          const p = phimRows.find((x) => x.maPhim === rowData.maPhim);
          if (!p) return showToast("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu phim.", "error");

          resetForm();
          $id("MaPhim").value = p.maPhim;
          $id("TenPhim").value = p.tenPhim || "";
          $id("ThoiLuong").value = p.thoiLuong || "";
          $id("DaoDien").value = p.daoDien || "";
          $id("NgonNgu").value = p.ngonNgu || "";
          $id("DienVien").value = p.dienVien || "";
          $id("KhoiChieu").value = toInputDate(p.khoiChieu);
          $id("Trailer").value = p.trailer || "";
          $id("MoTa").value = p.moTa || "";

          const set = new Set((p.loaiPhims || []).map((lp) => lp.maLoaiPhim));
          document
            .querySelectorAll("#LoaiPhimChecks input[type='checkbox']")
            .forEach((cb) => (cb.checked = set.has(Number(cb.value))));

          $id("phimModalLabel").textContent = "C·∫≠p nh·∫≠t phim";
          bsModal.show();
        }

        if (act === "del") {
          if (!confirm(`X√≥a phim #${id}?`)) return;
          try {
            const res = await fetch(API.remove(id), {
              method: "DELETE",
              headers: { ...authHeader },
            });
            if (!res.ok) throw new Error("DELETE failed");
            showToast("ƒê√£ x√≥a phim.", "success");
            await loadPhim();
          } catch (e) {
            console.error(e);
            showToast("X√≥a kh√¥ng th√†nh c√¥ng.", "error");
          }
        }
      });

      /* ================= Boot ================= */
      (async function boot() {
        await loadLoaiPhim();
        await loadPhim();
      })();
    </script>
  </body>
</html>
