<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chi Ti·∫øt Phim</title>
  <link rel="stylesheet" href="../../assets/css/Phim.css" />
  <link rel="stylesheet" href="../../assets/css/details.css"> 
  <script src="../../assets/js/login.js"></script> 

</head>
<body>
  <div id="include-header"></div>

  <div class="movie-detail-container" id="movieDetail">
    <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c ch√®n v√†o b·∫±ng JavaScript -->
  </div>

  <div id="include-footer"></div>

  <script>
    function includeHTML(id, file) {
      fetch(file)
        .then(res => res.text())
        .then(data => {
          document.getElementById(id).innerHTML = data;
          if (id === "include-header") {
            setTimeout(updateAuthButtons, 100);
          }
        });
    }

    includeHTML("include-header", "../../part/header.html");
    includeHTML("include-footer", "../../part/footer.html");

    const params = new URLSearchParams(window.location.search);
    const phimId = params.get("id");

    if (!phimId) {
      document.getElementById("movieDetail").innerHTML = "<p style='color:red'>Kh√¥ng t√¨m th·∫•y phim.</p>";
    } else {
      fetch(`https://localhost:7058/api/phim/get/${phimId}`)
        .then(res => res.json())
        .then(data => {
          if (!data.status || !data.data) {
            document.getElementById("movieDetail").innerHTML = "<p style='color:red'>Kh√¥ng t√¨m th·∫•y th√¥ng tin phim.</p>";
            return;
          }

          const movie = data.data;

          const posterUrl = movie.poster 
            ? 'https://localhost:7058' + movie.poster 
            : '../../assets/images/default-poster.jpg';

          const theLoaiText = movie.loaiPhims && movie.loaiPhims.length > 0
            ? movie.loaiPhims.map(l => l.tenLoaiPhim).join(', ')
            : 'Ch∆∞a c·∫≠p nh·∫≠t';

          document.getElementById("movieDetail").innerHTML = `
            <div class="movie-poster-wrapper">
              <div class="movie-poster" style="background-image: url('${posterUrl}')"></div>
              <button class="btn-trailer" onclick="showTrailer()">‚ñ∂Ô∏è Xem trailer</button>
            </div>
            <div class="movie-info">
              <h1>${movie.tenPhim}</h1>
              <p><strong>Th·ªÉ lo·∫°i:</strong> ${theLoaiText}</p>
              <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${movie.thoiLuong} ph√∫t</p>
              <p><strong>ƒê·∫°o di·ªÖn:</strong> ${movie.daoDien}</p>
              <p><strong>Ng√¥n ng·ªØ:</strong> ${movie.ngonNgu || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
              <p><strong>Di·ªÖn vi√™n:</strong> ${movie.dienVien || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
              <p><strong>Kh·ªüi chi·∫øu:</strong> ${movie.khoiChieu || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
              <p><strong>M√¥ t·∫£:</strong> ${movie.moTa || 'Kh√¥ng c√≥ m√¥ t·∫£.'}</p>

              <a href="../../pages/booking/booking.html?phimId=${movie.maPhim}" class="btn-booking">üéü ƒê·∫∑t v√© ngay</a>

              <div id="trailerContainer" class="trailer-container" style="display:none;">
                <iframe id="trailerFrame" width="100%" height="400" frameborder="0" allowfullscreen></iframe>
              </div>
            </div>
          `;

          // g·∫Øn bi·∫øn to√†n c·ª•c
          window.movie = movie;
        })
        .catch(err => {
          console.error("L·ªói:", err);
          document.getElementById("movieDetail").innerHTML = "<p style='color:red'>L·ªói khi t·∫£i d·ªØ li·ªáu phim.</p>";
        });
    }

    function showTrailer() {
      const trailerUrl = window.movie.trailer;
      const youtubeId = extractYoutubeId(trailerUrl);
      const embedUrl = `https://www.youtube.com/embed/${youtubeId}`;

      document.getElementById("trailerFrame").src = embedUrl;
      document.getElementById("trailerContainer").style.display = 'block';
    }

    function extractYoutubeId(url) {
      const regex = /(?:youtube\.com\/.*v=|youtu\.be\/)([^&?/]+)/;
      const match = url.match(regex);
      return match ? match[1] : '';
    }
  </script>
</body>
</html>
