<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ƒê·∫∑t V√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../../assets/css/Phim.css" />
  <link rel="stylesheet" href="../../assets/css/Booking.css" />
  <style>
    /* Ch·ªâ th√™m nh·∫π ƒë·ªÉ canh l·ªÅ gi√° */
    .price-info small{display:block;font-size:.9rem;color:#ccc;margin-top:4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé¨ ƒê·∫∑t V√© Xem Phim</h1>
      <p>Tr·∫£i nghi·ªám ƒëi·ªán ·∫£nh tuy·ªát v·ªùi</p>
    </div>

    <div class="main-content">
      <div class="movie-section">
        <div class="movie-info" id="movieInfo">
          <div class="loading">ƒêang t·∫£i th√¥ng tin phim...</div>
        </div>
      </div>

      <div class="booking-section">
        <div class="form-group">
          <label for="suatChieu">üìÖ Ch·ªçn su·∫•t chi·∫øu:</label>
          <select id="suatChieu">
            <option value="">-- Ch·ªçn su·∫•t chi·∫øu --</option>
          </select>
        </div>

        <div class="seat-section">
          <label>ü™ë Ch·ªçn gh·∫ø ng·ªìi:</label>
          <div class="screen"></div>
          <div class="seat-grid" id="seatGrid">
            <div class="loading">Ch·ªçn su·∫•t ƒë·ªÉ hi·ªÉn th·ªã gh·∫ø...</div>
          </div>
          <div class="seat-legend">
            <div class="legend-item">
              <div class="legend-seat legend-available"></div>
              <span>Tr·ªëng</span>
            </div>
            <div class="legend-item">
              <div class="legend-seat legend-selected"></div>
              <span>ƒê√£ ch·ªçn</span>
            </div>
            <div class="legend-item">
              <div class="legend-seat legend-booked"></div>
              <span>ƒê√£ ƒë·∫∑t</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="bapNuoc">üçø Ch·ªçn b·∫Øp n∆∞·ªõc (kh√¥ng b·∫Øt bu·ªôc):</label>
          <select id="bapNuoc">
            <option value="">-- Kh√¥ng ch·ªçn --</option>
          </select>
        </div>

        <div class="price-info">
          <h3>üí∞ T·ªïng ti·ªÅn</h3>
          <div class="total-price" id="totalPrice">0ƒë</div>
          <small id="seatPriceInfo"></small>
        </div>

        <button class="btn-book">üéü Thanh to√°n ngay</button>
      </div>
    </div>
  </div>
<script>
/* =================== CONFIG =================== */
const BASE_URL = "https://localhost:7058";
const phimId   = new URLSearchParams(location.search).get("phimId");

/* =================== STATE ==================== */
const suatChieuMap    = {};        // maSuat(string) -> maPhong
let   selectedSeatIds = new Set(); // gh·∫ø user hi·ªán t·∫°i ƒëang gi·ªØ
let   seatPrices      = {};        // maGhe (number) -> gi√° v√© (number)
let   selectedVeIds   = {};        // maGhe -> maVe (t·ª´ /hold)
let   currentUserId   = null;
let   currentBapPrice = 0;

let   seatHub       = null;        // SignalR connection
let   currentSuatId = null;        // maSuat ƒëang xem (string)
let   seatEls       = new Map();   // cache maGhe (number) -> element
let   viewToken     = 0;           // ch·ªëng race khi ƒë·ªïi su·∫•t
let   httpAbort     = null;        // AbortController cho fallback HTTP
let   bookingInFlight = false;     // ch·∫∑n double-click/ƒë√∫p event

/* =================== BUTTON STATE =================== */
const BTN_TEXT = {
  idle: "üéü Thanh to√°n ngay",
  creatingInvoice: "‚è≥ ƒê·ª£i: ƒëang t·∫°o h√≥a ƒë∆°n‚Ä¶",
  creatingPayment: "‚è≥ ƒê·ª£i: ƒëang t·∫°o thanh to√°n MoMo‚Ä¶",
  redirecting: "‚è≥ ƒê·ª£i: ƒëang chuy·ªÉn ƒë·∫øn MoMo‚Ä¶",
  error: "‚ùå Th·ª≠ l·∫°i"
};
function setBtnState(state) {
  const btn = document.querySelector(".btn-book");
  if (!btn) return;
  btn.textContent = BTN_TEXT[state] ?? BTN_TEXT.idle;
  if (state === "idle" || state === "error") {
    btn.disabled = false;
    btn.classList.remove("is-loading");
  } else {
    btn.disabled = true;
    btn.classList.add("is-loading");
  }
}

/* =================== HELPERS =================== */
const token    = () => localStorage.getItem("token");
const numberVN = n => { try { return Number(n).toLocaleString("vi-VN"); } catch { return n; } };
const normalizeId = x => { const n = parseInt(x, 10); return isNaN(n) ? null : n; };
function uuid(){ try{ return crypto.randomUUID(); } catch { return `${Date.now()}-${Math.random().toString(36).slice(2)}`; } }

async function getJson(url, options = {}) {
  const res = await fetch(url, options);
  let data = null; try { data = await res.json(); } catch {}
  if (!res.ok || data?.status === false) throw new Error(data?.message || `HTTP ${res.status}`);
  return data;
}
async function postJson(url, body, options = {}) {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type":"application/json", ...(options.headers||{}) },
    body: body == null ? null : JSON.stringify(body),
    signal: options.signal
  });
  let data = null; try { data = await res.json(); } catch {}
  if (!res.ok || data?.status === false) throw new Error(data?.message || `HTTP ${res.status}`);
  return data ?? { status: true };
}
const authHeaders = () => token() ? { "Authorization": "Bearer " + token() } : {};

function getUserIdFromToken(tk){
  try{
    const parts=(tk||"").split('.'); if(parts.length<2) return null;
    const b=parts[1].replace(/-/g,'+').replace(/_/g,'/');
    const json=decodeURIComponent(atob(b).split('').map(c=>'%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    const p=JSON.parse(json);
    return p["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"] || p["UserId"] || null;
  }catch{ return null; }
}

/* =================== MOVIE INFO =================== */
getJson(`${BASE_URL}/api/phim/get/${phimId}`)
  .then(res=>{
    const container = document.getElementById("movieInfo");
    if(!res.status){ container.textContent="Kh√¥ng t√¨m th·∫•y phim"; return; }
    const p = res.data;
    const poster = p.poster? BASE_URL+p.poster: "../../assets/images/default-poster.jpg";
    container.innerHTML = `
      <h2></h2>
      <img alt="">
      <div class="movie-details">
        <p><strong>üé≠ Th·ªÉ lo·∫°i:</strong> <span class="genres"></span></p>
        <p><strong>‚è±Ô∏è Th·ªùi l∆∞·ª£ng:</strong> <span class="duration"></span></p>
      </div>`;
    container.querySelector("h2").textContent = p.tenPhim || "Phim";
    const img = container.querySelector("img");
    img.src = poster; img.alt = p.tenPhim || "Poster";
    container.querySelector(".genres").textContent = (p.loaiPhims?.map(l=>l.tenLoaiPhim).join(", ")) || "N/A";
    container.querySelector(".duration").textContent = `${p.thoiLuong||0} ph√∫t`;
  })
  .catch(err=>console.error("L·ªói t·∫£i th√¥ng tin phim:", err));

/* =================== SU·∫§T CHI·∫æU =================== */
getJson(`${BASE_URL}/api/suatchieu/get-by-phim/${phimId}`)
  .then(res=>{
    const sel = document.getElementById("suatChieu");
    if(!res.status||!res.data?.length){
      sel.innerHTML='<option>‚ùå Kh√¥ng c√≥ su·∫•t chi·∫øu</option>';
      return;
    }
    res.data.forEach(s=>{
      suatChieuMap[String(s.maSuat)] = s.maPhong;
      const opt = document.createElement("option");
      opt.value=s.maSuat;
      opt.textContent=`üìÖ ${s.ngayChieu} - ‚è∞ ${s.gioChieu}`;
      sel.append(opt);
    });
    sel.addEventListener("change", loadSeats, { once: false });
    sel.selectedIndex = 0;
    sel.dispatchEvent(new Event('change'));
  })
  .catch(err=>console.error("L·ªói t·∫£i su·∫•t chi·∫øu:", err));

/* =================== B·∫ÆP N∆Ø·ªöC =================== */
getJson(`${BASE_URL}/api/bapnuoc/get-all`)
  .then(res=>{
    const sel=document.getElementById("bapNuoc");
    if(res.status){
      res.data.forEach(b=>{
        const opt=document.createElement("option");
        opt.value=b.maBn;
        opt.dataset.price=b.gia;
        opt.textContent=`üçø ${b.tenBn} - ${numberVN(b.gia)}ƒë`;
        sel.append(opt);
      });
    }
    sel.addEventListener("change", updateTotalPrice);
  })
  .catch(err=>console.error("L·ªói t·∫£i b·∫Øp n∆∞·ªõc:", err));

/* ========== SEAT UI HELPERS ========== */
function markBooked(el){ el.classList.remove('selected'); el.classList.add('booked'); el.style.pointerEvents='none'; }
function markSelected(el){ el.classList.remove('booked'); el.classList.add('selected'); el.style.pointerEvents='auto'; }
function markFree(el){ el.classList.remove('booked','selected'); el.style.pointerEvents='auto'; }

/* ========== √ÅP D·ª§NG TR·∫†NG TH√ÅI GH·∫æ ========== */
function applySeatState({ maSuat, maGhe, trangThai, holderUserId }) {
  const selSuatEl = document.getElementById('suatChieu');
  const selSuat   = String(selSuatEl?.value || "");
  if (String(maSuat) !== String(currentSuatId || selSuat)) return;

  const id = normalizeId(maGhe);
  if (id == null) return;

  const el = seatEls.get(id);
  if (!el) return;

  el.classList.remove('booked', 'selected', 'pending');
  el.style.pointerEvents = 'auto';

  const t = (trangThai || '').trim();

  if (t === '' || t === 'Trong') {
    selectedSeatIds.delete(id);
    delete selectedVeIds[id];
    delete seatPrices[id];
    markFree(el);
    el.onclick = () => toggleSeat(el, id, normalizeId(maSuat));
    renderSeatSummary();
    return;
  }

  if (t === 'TamGiu') {
    if (holderUserId && currentUserId && holderUserId === currentUserId) {
      markSelected(el);
      selectedSeatIds.add(id);
      el.onclick = () => toggleSeat(el, id, normalizeId(maSuat));
      renderSeatSummary();
    } else {
      markBooked(el);
      el.onclick = null;
    }
    return;
  }

  if (t === 'DaDat') {
    markBooked(el);
    el.onclick = null;
    selectedSeatIds.delete(id);
    delete selectedVeIds[id];
    delete seatPrices[id];
    renderSeatSummary();
  }
}

/* =================== RENDER 1 GH·∫æ =================== */
function renderSeat(grid, ghe, suatId){
  const div = document.createElement('div');
  div.className   = 'seat';
  div.textContent = ghe.soGhe || ghe.tenGhe || '(?)';

  const maGhe = normalizeId(ghe.maGhe ?? ghe.maGheId ?? ghe.id);
  if (maGhe == null) return;

  div.setAttribute('data-seat', String(maGhe));
  grid.appendChild(div);
  seatEls.set(maGhe, div);

  applySeatState({
    maSuat: normalizeId(suatId),
    maGhe: maGhe,
    trangThai: (ghe.trangThai ?? ghe.TrangThai ?? '').trim(),
    holderUserId: ghe.holderUserId ?? ghe.HolderUserId ?? null
  });
}

/* =================== SIGNALR (snapshot + realtime) =================== */
async function connectSeatHub(maSuat) {
  if (seatHub) {
    try { if (currentSuatId) await seatHub.invoke("LeaveShowtime", parseInt(currentSuatId,10)); } catch {}
    try { await seatHub.stop(); } catch {}
  }
  currentSuatId = String(maSuat);

  seatHub = new signalR.HubConnectionBuilder()
    .withUrl(`${BASE_URL.replace(/\/+$/,'')}/seatHub`)
    .withAutomaticReconnect()
    .build();

  seatHub.on("SeatsSnapshot", (list) => {
    const selSuat = String(document.getElementById('suatChieu').value||"");
    if (String(maSuat) !== selSuat) return;

    const grid = document.getElementById('seatGrid');
    if (!grid) return;

    grid.innerHTML = '';
    seatEls.clear();
    list.forEach(ghe => renderSeat(grid, ghe, maSuat));
  });

  seatHub.on("SeatUpdated", (p) => {
    const payload = {
      maSuat:     normalizeId(p.maSuat ?? p.MaSuat),
      maGhe:      normalizeId(p.maGhe ?? p.MaGhe),
      trangThai: (p.trangThai ?? p.TrangThai ?? '').trim(),
      holderUserId: p.holderUserId ?? p.HolderUserId ?? null
    };
    applySeatState(payload);
  });

  seatHub.onreconnected(async () => {
    try {
      await seatHub.invoke("JoinShowtime", parseInt(currentSuatId,10));
      if (seatHub.invoke) { try { await seatHub.invoke("RequestSnapshot", parseInt(currentSuatId,10)); } catch {} }
    } catch {}
  });

  await seatHub.start();
  await seatHub.invoke("JoinShowtime", parseInt(maSuat, 10));
}

/* =================== LOAD & RENDER GH·∫æ =================== */
function loadSeats(){
  currentUserId = getUserIdFromToken(token());
  const suatId  = String(document.getElementById('suatChieu').value);
  const maPhong = suatChieuMap[String(suatId)];
  const grid    = document.getElementById('seatGrid');

  const myToken = ++viewToken;

  seatPrices = {};
  renderSeatSummary();

  grid.innerHTML = '<div class="loading">ƒêang t·∫£i gh·∫ø...</div>';
  if (!maPhong){
    grid.innerHTML = '<div class="loading">Kh√¥ng t√¨m th·∫•y ph√≤ng t·ª´ su·∫•t chi·∫øu.</div>';
    return;
  }

  connectSeatHub(suatId).catch(err=>console.error("SeatHub error:", err));

  if (httpAbort) { try { httpAbort.abort(); } catch {} }
  httpAbort = new AbortController();

  const url = `${BASE_URL}/api/ghe/get-trang-thai?maPhong=${maPhong}&maSuat=${suatId}&_=${Date.now()}`;
  getJson(url, { headers: authHeaders(), signal: httpAbort.signal })
    .then(res=>{
      if (viewToken !== myToken) return;
      if (!grid.querySelector('.loading')) return;

      grid.innerHTML='';
      seatEls.clear();
      if(!res.status || !Array.isArray(res.data) || !res.data.length){
        grid.innerHTML='<p style="color:#ff6b6b;text-align:center;padding:40px;">‚ùå Kh√¥ng c√≥ gh·∫ø kh·∫£ d·ª•ng.</p>';
        return;
      }
      res.data.forEach(ghe=>renderSeat(grid,ghe,suatId));
    })
    .catch(err=>{
      if (err?.name === 'AbortError') return;
      console.error('L·ªói khi l·∫•y gh·∫ø:',err);
      if (viewToken === myToken && grid.querySelector('.loading')) {
        grid.innerHTML='<p style="color:#ff6b6b;text-align:center;padding:40px;">‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß.</p>';
      }
    })
    .finally(()=>{ httpAbort = null; });
}

/* ================== HOLD / RELEASE SEAT ================== */
async function toggleSeat(div, maGhe, maSuat){
  if (!token()) { alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p."); return; }
  const seatId = normalizeId(maGhe);
  const suatId = normalizeId(maSuat);
  if (seatId == null || suatId == null) return;

  div.classList.add('pending');
  try {
    if (div.classList.contains('selected')) {
      await postJson(`${BASE_URL}/api/ve/release`, { maGhe:seatId, maSuat:suatId }, { headers: authHeaders() });
      selectedSeatIds.delete(seatId);
      delete selectedVeIds[seatId];
      delete seatPrices[seatId];
      renderSeatSummary();
      markFree(div);
      div.onclick = () => toggleSeat(div, seatId, suatId);
      return;
    }

    const resp = await postJson(`${BASE_URL}/api/ve/hold`, { maGhe:seatId, maSuat:suatId }, { headers: authHeaders() });
    const ve = resp.data || {};
    selectedSeatIds.add(seatId);
    if (ve.maVe != null) selectedVeIds[seatId] = ve.maVe;

    if (ve.giaVe != null) {
      seatPrices[seatId] = parseInt(ve.giaVe, 10);
    } else {
      try{
        const gia = await getJson(`${BASE_URL}/api/ve/tinh-gia-ve?maGhe=${seatId}&maSuat=${suatId}`, { headers: authHeaders() });
        if (gia?.data?.giaCuoiCung != null) seatPrices[seatId] = parseInt(gia.data.giaCuoiCung, 10);
      }catch(e){
        console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c gi√° gh·∫ø, s·∫Ω ƒë·ªÉ 0 t·∫°m:", e);
      }
    }

    markSelected(div);
    div.onclick = () => toggleSeat(div, seatId, suatId);
    renderSeatSummary();
  } catch (e) {
    markBooked(div);
    console.error("Hold seat l·ªói:", e);
    alert(e.message || "Gh·∫ø ƒëang ƒë∆∞·ª£c gi·ªØ.");
  } finally {
    div.classList.remove('pending');
  }
}

/* =================== SUMMARY & TOTAL =================== */
function renderSeatSummary(){
  const info=document.getElementById("seatPriceInfo");
  info.innerHTML=[...selectedSeatIds].map(id=>`ü™ë ${id}: ${numberVN(seatPrices[id]||0)}ƒë`).join("<br>")||"";
  updateTotalPrice();
}
function updateTotalPrice(){
  const bapSel=document.getElementById("bapNuoc");
  currentBapPrice=parseInt(bapSel.selectedOptions[0]?.dataset.price||0);
  const seatSum=Object.values(seatPrices).reduce((t,p)=>t+(parseInt(p||0,10)||0),0);
  document.getElementById("totalPrice").textContent=numberVN(seatSum+currentBapPrice)+"ƒë";
}
function getSelectedSeatsArray() { return [...selectedSeatIds].map(id => id); }
function calcSeatSum() { return Object.values(seatPrices).reduce((t,p)=>t + (parseInt(p||0,10)||0), 0); }

/* ====== HO√Å ƒê∆†N & THANH TO√ÅN ====== */
async function createInvoiceOnServer({ maSuat, seatIds, bapNuocId, soLuongBapNuoc }) {
  const body = {
    maSuat: normalizeId(maSuat),
    seatIds: seatIds.map(normalizeId).filter(x=>x!=null),
    bapNuocId: bapNuocId ?? null,
    soLuongBapNuoc: soLuongBapNuoc ?? (bapNuocId ? 1 : 0),
    ghiChu: "ƒê·∫∑t v√© qua website",
    clientToken: uuid()
  };
  const res = await postJson(`${BASE_URL}/api/hoadon/create`, body, { headers: authHeaders() });
  if (!res?.data?.amount) {
    const bapSel = document.getElementById("bapNuoc");
    const bapPrice = parseInt(bapSel.selectedOptions[0]?.dataset.price || 0);
    const amount = calcSeatSum() + (bapSel.value ? bapPrice : 0);
    res.data = { ...(res.data||{}), amount };
  }
  return res.data; 
}
async function createMomoPayment({ orderId, amount, orderInfo, fullName }) {
  const body = {
    orderId: String(orderId),
    amount,
    orderInfo: orderInfo || `Thanh to√°n v√© phim`,
    fullName:  fullName  || "Kh√°ch h√†ng"
  };
  const res = await postJson(`${BASE_URL}/api/momopayment/create`, body, { headers: authHeaders() });
  const url = res?.payUrl || res?.shortLink || res?.deeplink;
  if (!url) throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c payUrl t·ª´ MoMo.");
  return url;
}

/* =================== BOOK (Hƒê -> MoMo) =================== */
async function bookTicket(){
  if (bookingInFlight) return;
  bookingInFlight = true;

  if (!token()) { alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ƒë·∫∑t v√©."); bookingInFlight=false; return; }

  const suatEl = document.getElementById("suatChieu");
  const maSuat = String(suatEl?.value||"");
  const seatIds = getSelectedSeatsArray();

  if (!maSuat) { alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn su·∫•t chi·∫øu."); bookingInFlight=false; return; }
  if (!seatIds.length) { alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 gh·∫ø."); bookingInFlight=false; return; }

  const bapSel = document.getElementById("bapNuoc");
  const bapNuocId = bapSel?.value ? parseInt(bapSel.value,10) : null;

  try {
    setBtnState("creatingInvoice");

    // 1) T·∫°o h√≥a ƒë∆°n ·ªü BE
    const invoice = await createInvoiceOnServer({
      maSuat,
      seatIds,
      bapNuocId,
      soLuongBapNuoc: 1
    });
    const maHd = invoice?.maHd || invoice?.MaHd || invoice?.orderId;
    if (!maHd) throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c m√£ h√≥a ƒë∆°n (maHd).");

    // 2) T·∫°o thanh to√°n MoMo
    setBtnState("creatingPayment");
    const orderInfo = invoice?.orderInfo || `Thanh to√°n v√© phim - Hƒê ${maHd}`;
    const fullName  = invoice?.fullName  || "Kh√°ch h√†ng";
    const amount    = parseInt(invoice.amount || 0, 10) || 0;
    if (!amount || amount <= 0) throw new Error("S·ªë ti·ªÅn thanh to√°n kh√¥ng h·ª£p l·ªá.");

    const payUrl = await createMomoPayment({
      orderId: String(maHd),
      amount,
      orderInfo,
      fullName
    });

    // 3) Redirect sang MoMo
    setBtnState("redirecting");
    location.href = payUrl;

  } catch (err) {
    console.error("ƒê·∫∑t v√© l·ªói:", err);
    alert(err?.message || "C√≥ l·ªói khi ƒë·∫∑t v√©. Vui l√≤ng th·ª≠ l·∫°i.");
    setBtnState("error");
    bookingInFlight = false;
  }
}

/* =================== INIT =================== */
document.addEventListener("DOMContentLoaded", () => {
  // Nh·ªõ g·ª° onclick inline trong HTML
  const bookBtn = document.querySelector(".btn-book");
  if (bookBtn && !bookBtn.dataset.bound) {
    bookBtn.addEventListener("click", bookTicket, { passive: true });
    bookBtn.dataset.bound = "1";
    setBtnState("idle");
  }
});
</script>
</body>
</html>
