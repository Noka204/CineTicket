<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ƒê·∫∑t V√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../../assets/css/Phim.css" />
  <style>
    body {
      background-color: #0e0e1b;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background-color: #1a1a2e;
      border-radius: 10px;
    }
    .movie-info {
      margin-bottom: 30px;
    }
    .showtime-select {
      margin-bottom: 20px;
    }
    .seat {
      display: inline-block;
      width: 30px;
      height: 30px;
      margin: 5px;
      background-color: #444;
      border-radius: 5px;
      text-align: center;
      line-height: 30px;
      cursor: pointer;
    }
    .seat.selected {
      background-color: #ff0055;
    }
    .seat.booked {
      background-color: #666;
      cursor: not-allowed;
    }
    .btn-book {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #ff0055;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéü ƒê·∫∑t V√© Xem Phim</h1>
    <div class="movie-info" id="movieInfo">ƒêang t·∫£i th√¥ng tin phim...</div>

    <div class="showtime-select">
      <label for="suatChieu">Ch·ªçn su·∫•t chi·∫øu:</label>
      <select id="suatChieu"></select>
    </div>

    <div class="seat-grid" id="seatGrid">Ch·ªçn su·∫•t ƒë·ªÉ hi·ªÉn th·ªã gh·∫ø...</div>

    <button class="btn-book" onclick="bookTicket()">ƒê·∫∑t v√©</button>
  </div>

  <script>
    const phimId = new URLSearchParams(window.location.search).get("phimId");
    let selectedSeatId = null;

    // Load th√¥ng tin phim
    fetch(`https://localhost:7058/api/phim/get/${phimId}`)
      .then(res => res.json())
      .then(data => {
        if (data.status) {
          const phim = data.data;
          document.getElementById("movieInfo").innerHTML = `
            <h2>${phim.tenPhim}</h2>
            <p><strong>Th·ªÉ lo·∫°i:</strong> ${phim.tenLoaiPhim}</p>
            <p><strong>Th·ªùi l∆∞·ª£ng:</strong> ${phim.thoiLuong} ph√∫t</p>
            <img src="${phim.poster || '../../assets/images/default-poster.jpg'}" width="200" />
          `;
        }
      });

    // Load danh s√°ch su·∫•t chi·∫øu theo phim
    fetch(`http://localhost:7058/api/suatchieu/get/${phimId}`)
      .then(res => res.json())
      .then(data => {
        if (data.status) {
          const select = document.getElementById("suatChieu");
          data.data.forEach(suat => {
            const opt = document.createElement("option");
            opt.value = suat.maSuat;
            opt.textContent = `${suat.ngayChieu} - ${suat.gioChieu}`;
            select.appendChild(opt);
          });

          select.addEventListener("change", loadSeats);
          select.dispatchEvent(new Event("change")); // load seats for first option
        }
      });

    // Load danh s√°ch gh·∫ø theo su·∫•t
    function loadSeats() {
      const suatId = document.getElementById("suatChieu").value;
      selectedSeatId = null;
      fetch(`https://localhost:7058/api/ghe/by-suat/${suatId}`)
        .then(res => res.json())
        .then(data => {
          const seatGrid = document.getElementById("seatGrid");
          seatGrid.innerHTML = "";
          if (data.status) {
            data.data.forEach(ghe => {
              const div = document.createElement("div");
              div.className = "seat" + (ghe.trangThai === "ƒê√£ ƒë·∫∑t" ? " booked" : "");
              div.textContent = ghe.tenGhe;
              if (ghe.trangThai !== "ƒê√£ ƒë·∫∑t") {
                div.onclick = () => {
                  document.querySelectorAll(".seat").forEach(s => s.classList.remove("selected"));
                  div.classList.add("selected");
                  selectedSeatId = ghe.maGhe;
                };
              }
              seatGrid.appendChild(div);
            });
          }
        });
    }

    // G·ª≠i y√™u c·∫ßu ƒë·∫∑t v√©
    function bookTicket() {
      const suatId = document.getElementById("suatChieu").value;
      if (!selectedSeatId) {
        alert("Vui l√≤ng ch·ªçn gh·∫ø.");
        return;
      }

      const token = localStorage.getItem("token");
      if (!token) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi ƒë·∫∑t v√©.");
        return;
      }

      fetch("https://localhost:7058/api/ve/dat-ve", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          maGhe: selectedSeatId,
          maSuat: suatId,
          giaVe: 70000 
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status) {
          alert("ƒê·∫∑t v√© th√†nh c√¥ng!");
          window.location.href = "../../index.html";
        } else {
          alert("L·ªói: " + data.message);
        }
      })
      .catch(err => {
        console.error(err);
        alert("L·ªói k·∫øt n·ªëi m√°y ch·ªß.");
      });
    }
  </script>
</body>
</html>
