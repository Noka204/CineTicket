<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title data-i18n="Seat_Page_Title">CineTicket ‚Ä¢ B∆∞·ªõc 2: Ch·ªçn gh·∫ø</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- CSS chung -->
    <link rel="stylesheet" href="../../assets/css/Phim.css" />

    <style>
      /* ========= FIX HEADER xung ƒë·ªôt ========= */
      :root {
        --header-h: 72px;
      }

      .site-header {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.9);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      /* Header d√πng .nav.container trong header.html -> √©p v·ªÅ full-width, tri·ªát ti√™u margin c·ªßa .container trang */
      .site-header .nav.container {
        margin: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
        padding-inline: clamp(14px, 4vw, 28px) !important;
        height: var(--header-h);
        min-height: var(--header-h);
      }
      /* N·∫øu sau n√†y header ƒë·ªïi sang .nav.shell th√¨ v·∫´n ƒë·∫πp */
      .site-header .nav.shell {
        display: flex;
        align-items: center;
        justify-content: space-between;
        column-gap: 24px;
        height: var(--header-h);
        min-height: var(--header-h);
        max-width: 100%;
        width: 100%;
        padding-inline: clamp(14px, 4vw, 28px);
      }
      #header-spacer {
        height: 0 !important;
      }
      .site-header .nav-links {
        overflow: visible !important;
      }

      /* ========= TRANG CH·ªåN GH·∫æ ‚Äî SCOPED ========= */
      .seats-page .container {
        max-width: 1100px;
        margin: 24px auto 42px;
        padding: 0 18px;
      }
      .seats-page .card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 16px;
        backdrop-filter: blur(12px);
      }
      .seats-page .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 16px;
      }
      .seats-page .header-row h2 {
        margin: 0;
        font-size: 1.8rem;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* Tokens ri√™ng trang */
      .seats-page {
        --buy: #22e3a2;
        --buy-2: #12c48b;
        --border: rgba(255, 255, 255, 0.12);
        --seat-size: clamp(34px, 4.2vw, 52px);
        --seat-gap: 8px;
      }

      .seats-page .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #1a2336;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
        transition: 0.15s;
      }
      .seats-page .btn:hover {
        background: #24304b;
        transform: translateY(-1px);
        border-color: #2e3f60;
      }
      .seats-page .btn.primary {
        border: none;
        background: var(--buy);
        color: #0b1b14;
        font-weight: 700;
      }
      .seats-page .btn.primary:hover {
        background: var(--buy-2);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }
      .seats-page .btn[disabled] {
        opacity: 0.6;
        pointer-events: none;
      }
      .seats-page .note {
        color: #cbd5e1;
      }
      .seats-page .loading {
        opacity: 0.85;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 120px;
      }

      .seats-page .screen {
        height: 10px;
        width: 60%;
        margin: 10px auto 14px;
        border-radius: 999px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.25),
          rgba(255, 255, 255, 0.6),
          rgba(255, 255, 255, 0.25)
        );
        box-shadow: 0 0 24px rgba(255, 255, 255, 0.22);
      }

      .seats-page .seat-grid {
        display: grid;
        grid-template-columns: repeat(10, var(--seat-size));
        gap: var(--seat-gap);
        justify-content: center;
        width: 100%;
      }
      .seats-page .seat {
        width: var(--seat-size);
        height: var(--seat-size);
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #1a2336;
        color: #e8e8e8;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        cursor: pointer;
        transition: 0.15s;
        font-size: 12px;
      }
      .seats-page .seat:hover {
        transform: translateY(-1px);
        border-color: #12c48b;
        background: #12c48b;
        color: #0b1b14;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
      }
      .seats-page .seat.selected {
        background: #22e3a2;
        color: #0b1b14;
        border-color: #0aa176;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
      }
      .seats-page .seat.booked {
        background: #101828;
        color: #9aa3ad;
        border-color: rgba(255, 255, 255, 0.08);
        cursor: not-allowed;
        filter: grayscale(0.2) brightness(0.9);
      }
      .seats-page .seat.pending {
        pointer-events: none;
        opacity: 0.8;
      }
      .seats-page .seat.invalid {
        animation: shake 0.28s ease-in-out 1;
        border-color: #ff6b6b;
        box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.35);
      }
      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-3px);
        }
        50% {
          transform: translateX(3px);
        }
        75% {
          transform: translateX(-2px);
        }
        100% {
          transform: translateX(0);
        }
      }

      .seats-page .legend {
        display: flex;
        gap: 14px;
        align-items: center;
        font-size: 13px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }
      .seats-page .legend .dot {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1px solid var(--border);
      }
      .seats-page .legend .free {
        background: #1a2336;
      }
      .seats-page .legend .sel {
        background: #22e3a2;
      }
      .seats-page .legend .book {
        background: #101828;
      }

      .seats-page .summary-grid {
        display: grid;
        grid-template-columns: 1fr 260px;
        gap: 18px;
        align-items: start;
      }
      @media (max-width: 900px) {
        .seats-page .summary-grid {
          grid-template-columns: 1fr;
        }
      }
      .seats-page .sum-poster {
        display: grid;
        grid-template-columns: 110px 1fr;
        gap: 14px;
        align-items: start;
      }
      .seats-page .poster {
        width: 110px;
        height: 150px;
        border-radius: 12px;
        background: #0b0b12 center/cover no-repeat;
        border: 1px solid var(--border);
      }
      .seats-page .sum-title {
        font-weight: 800;
      }
      .seats-page .sum-right {
        display: grid;
        gap: 12px;
        justify-items: end;
      }
      .seats-page .sum-total {
        font-size: 1.1rem;
        font-weight: 800;
      }

      /* Modal b√°m ƒë·ªânh (n·∫øu d√πng l·∫°i modal chung) */
      .seats-page .modal {
        position: fixed;
        inset: 0;
        z-index: 2000;
        background: rgba(0, 0, 0, 0.82);
        backdrop-filter: blur(6px);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 16px 12px;
        overflow: hidden;
      }
      .seats-page .modal-content {
        position: relative;
        width: min(1000px, 92vw);
        margin-top: calc(var(--header-h, 64px) + 8px);
        max-height: calc(100vh - var(--header-h, 64px) - 32px);
        overflow: auto;
        background: linear-gradient(135deg, #101a2e, #0f1930);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        overscroll-behavior: contain;
      }
      .seats-page .modal-content .modal-header {
        position: sticky;
        top: 0;
        z-index: 4;
        padding: 12px 20px 10px;
        margin: 0 0 12px 0;
        background: linear-gradient(
          180deg,
          rgba(16, 23, 36, 0.96),
          rgba(16, 23, 36, 0.88)
        );
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .seats-page .modal-close {
        position: absolute;
        top: 10px;
        right: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        font-size: 18px;
        font-weight: 800;
        color: #fff;
        background: rgba(16, 23, 36, 0.88);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        cursor: pointer;
      }
      .seats-page .modal-close:hover {
        background: rgba(18, 26, 44, 0.95);
      }
      .seats-page .modal-content::-webkit-scrollbar {
        width: 10px;
      }
      .seats-page .modal-content::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.14);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
      }
      .seats-page .modal-content::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.24);
      }
    </style>
  </head>

  <body>
    <!-- Placeholder an to√†n cho phim.js c≈© (·∫©n) -->
    <div style="display: none">
      <div class="banner-slider"></div>
      <div class="movies-grid"></div>
    </div>

    <!-- Include header chung -->
    <div id="include-header"></div>

    <!-- ======= N·ªòI DUNG TRANG CH·ªåN GH·∫æ ======= -->
    <main class="seats-page">
      <div class="container">
        <div class="header-row">
          <h2 data-i18n="Seat_Page_Title">ü™ë B∆∞·ªõc 2: Ch·ªçn gh·∫ø</h2>
        </div>

        <div class="card">
          <div class="legend" id="legend">
            <div class="dot free"></div>
            <span data-i18n="Seat_Legend_Free">Tr·ªëng</span>
            <div class="dot sel"></div>
            <span data-i18n="Seat_Legend_Selected">ƒê√£ ch·ªçn</span>
            <div class="dot book"></div>
            <span data-i18n="Seat_Legend_BookedHeld">ƒê√£ ƒë·∫∑t/gi·ªØ</span>
          </div>
          <div class="screen" id="screen" title="M√†n h√¨nh"></div>
          <div id="seatGrid" class="seat-grid">
            <div class="loading" data-i18n="Loading_Seats">ƒêang t·∫£i gh·∫ø‚Ä¶</div>
          </div>
        </div>

        <div class="card">
          <div class="summary-grid">
            <div class="sum-poster">
              <div id="moviePoster" class="poster" aria-label="poster"></div>
              <div>
                <div id="movieTitle" class="sum-title">(Phim)</div>
                <div id="movieMeta" class="note">‚Äî</div>
              </div>
            </div>
            <div class="sum-right">
              <div class="sum-total">
                <span data-i18n="Sum_Subtotal_Label">T·ªïng t·∫°m t√≠nh</span>:
                <span id="total">0ƒë</span>
              </div>
              <div>
                <a id="backBtn" class="btn" href="select-showtime.html"
                  >‚Üê <span data-i18n="Btn_Back">Quay l·∫°i</span></a
                >
                <button
                  id="nextBtn"
                  class="btn primary"
                  disabled
                  data-i18n="Btn_Next_Snacks"
                >
                  Ti·∫øp ‚Äî B·∫Øp n∆∞·ªõc
                </button>
              </div>
            </div>
          </div>
          <div id="breakdown" class="note" style="margin-top: 12px"></div>
        </div>
      </div>
    </main>

    <!-- Include footer chung -->
    <div id="include-footer"></div>

    <!-- Auth + shared page logic -->
    <script>
      window.__PAGE_ROLE__ = "select-seats";
    </script>
    <script defer src="../../assets/js/login.js"></script>
    <script defer src="../../assets/js/phim.js"></script>

    <!-- SCRIPT CH√çNH TRANG (module ƒë·ªÉ tr√°nh ƒë·ª•ng global) -->
    <script type="module">
      /* ============ CONFIG & HELPERS ============ */
      const BASE_URL = "https://localhost:7058";
      const API_MOVIE_BY_ID = (id) =>
        `${BASE_URL}/api/phim/get/${id}?_=${Date.now()}`;
      const API_HELD_BY_ME = (suatId) =>
        `${BASE_URL}/api/ve/held-by-me?maSuat=${suatId}&_=${Date.now()}`;

      const $ = (s, r = document) => r.querySelector(s);
      const numberVN = (n) => {
        try {
          return Number(n).toLocaleString("vi-VN");
        } catch {
          return n;
        }
      };
      const normalizeId = (x) => {
        const n = parseInt(x, 10);
        return Number.isFinite(n) ? n : null;
      };
      const token = () => localStorage.getItem("token");
      const authHeaders = () =>
        token() ? { Authorization: "Bearer " + token() } : {};
      const absUrl = (u) => {
        if (!u) return "";
        if (/^https?:\/\//i.test(u)) return u;
        u = String(u).replace(/^\/?wwwroot\//i, "");
        if (!/^\/?Images\//i.test(u)) u = "Images/" + u.replace(/^\/+/, "");
        return `${BASE_URL.replace(/\/+$/, "")}/${u.replace(/^\/+/, "")}`;
      };

      /* ============ I18N (SERVER-DRIVEN ONLY) ============ */
      const CULT = { vi: "vi", en: "en", fr: "fr" };
      let curAlias = localStorage.getItem("lang") || "vi";
      const I18N_CACHE = {};
      async function i18nLoad(alias) {
        const a = CULT[alias] ? alias : "vi";
        if (I18N_CACHE[a]) return I18N_CACHE[a];
        try {
          const url = new URL(`${BASE_URL}/api/i18n`);
          url.searchParams.set("lang", a);
          url.searchParams.set("_", Date.now());
          const res = await fetch(url, {
            credentials: "include",
            cache: "no-store",
          });
          const pack = res.ok ? await res.json() : {};
          I18N_CACHE[a] = pack || {};
        } catch {
          I18N_CACHE[a] = {};
        }
        return I18N_CACHE[a];
      }
      function t(key) {
        const pack = I18N_CACHE[curAlias] || {};
        const v = pack[key];
        return typeof v === "string" ? v : key;
      }
      function tt(key, params = {}) {
        const raw = t(key) || key;
        return raw.replace(/\{(\w+)\}/g, (_, k) =>
          params[k] != null ? String(params[k]) : `{${k}}`
        );
      }
      function applyI18nToDom(root = document) {
        root.querySelectorAll("[data-i18n]").forEach((el) => {
          el.textContent = t(el.getAttribute("data-i18n"));
        });
        const titleEl = document.querySelector("title[data-i18n]");
        if (titleEl) document.title = t(titleEl.getAttribute("data-i18n"));
        document.documentElement.lang = curAlias;
      }
      // ƒê·ªïi ng√¥n ng·ªØ qua data-set-lang (t√¥n tr·ªçng header JS chung)
      document.addEventListener("click", (e) => {
        const langLink = e.target.closest("[data-set-lang]");
        if (!langLink) return;
        e.preventDefault();
        const alias = langLink.getAttribute("data-set-lang");
        curAlias = CULT[alias] ? alias : "vi";
        localStorage.setItem("lang", curAlias);
        fetch(
          `${BASE_URL}/api/ping?lang=${encodeURIComponent(
            curAlias
          )}&_=${Date.now()}`,
          { credentials: "include" }
        ).catch(() => {});
        i18nLoad(curAlias).then(() => applyI18nToDom(document));
      });

      /* ============ BOOKING STATE & LOGIC ============ */
      let currentUserIdRaw = null,
        currentSuatId = null,
        currentPhongId = null;
      let currentRapId = null,
        currentRapName = null,
        currentPhongName = null;
      let seatHub = null,
        viewToken = 0,
        httpAbort = null;

      const seatEls = new Map(),
        seatMeta = new Map(),
        selectedSeatIds = new Set();
      const selectedVeIds = {},
        seatPrices = {},
        heldByMe = new Set();

      const LS_KEY = "BOOKING_FLOW";
      const getFlow = () => {
        try {
          return JSON.parse(localStorage.getItem(LS_KEY) || "{}");
        } catch {
          return {};
        }
      };
      const setFlow = (p) => {
        const cur = getFlow();
        localStorage.setItem(LS_KEY, JSON.stringify({ ...cur, ...(p || {}) }));
      };
      const clearFlow = () => {
        try {
          localStorage.removeItem(LS_KEY);
        } catch {}
      };

      function shouldClearOnHref(href) {
        if (!href) return false;
        const u = href.toLowerCase();
        return (
          u.endsWith("/phim/index.html") ||
          u.endsWith("../phim/index.html") ||
          u.endsWith("../../phim/index.html")
        );
      }
      function bindClearOnIndexLinks(scope = document) {
        scope.querySelectorAll("a[href]").forEach((a) => {
          const href = a.getAttribute("href") || "";
          if (shouldClearOnHref(href))
            a.addEventListener(
              "click",
              () => {
                clearFlow();
              },
              { capture: true }
            );
        });
      }

      function getUserIdFromToken(tk) {
        try {
          const parts = (tk || "").split(".");
          if (parts.length < 2) return null;
          const b = parts[1].replace(/-/g, "+").replace(/_/g, "/");
          const json = decodeURIComponent(
            atob(b)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          const p = JSON.parse(json);
          return (
            p[
              "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"
            ] ||
            p["UserId"] ||
            p["sub"] ||
            p["name"] ||
            null
          );
        } catch {
          return null;
        }
      }
      const getHolderRaw = (o) =>
        o?.holderUserId ??
        o?.HolderUserId ??
        o?.nguoiGiuId ??
        o?.NguoiGiuId ??
        o?.NguoiGiuID ??
        o?.userHoldId ??
        null;

      function parseSeatLabel(t) {
        if (!t) return { row: "", num: -1 };
        const s = String(t),
          row = (s.match(/[A-Za-z]+/)?.[0] || "").toUpperCase();
        const num = parseInt(s.match(/\d+/)?.[0] || "-1", 10);
        return { row, num: Number.isFinite(num) ? num : -1 };
      }
      function markBooked(el) {
        el.classList.remove("selected");
        el.classList.add("booked");
        el.style.pointerEvents = "none";
      }
      function markSelected(el) {
        el.classList.remove("booked");
        el.classList.add("selected");
        el.style.pointerEvents = "auto";
      }
      function markFree(el) {
        el.classList.remove("booked", "selected", "pending");
        el.style.pointerEvents = "auto";
      }
      function updateNextButton() {
        const btn = $("#nextBtn");
        if (btn) btn.disabled = selectedSeatIds.size === 0;
      }

      function normDate(d) {
        try {
          const x = new Date(d);
          if (!isNaN(x)) {
            const y = x.getFullYear(),
              m = String(x.getMonth() + 1).padStart(2, "0"),
              dd = String(x.getDate()).padStart(2, "0");
            return `${y}-${m}-${dd}`;
          }
        } catch (_) {}
        return String(d || "");
      }
      function normTime(t) {
        const m = String(t || "").match(/^(\d{1,2}):(\d{2})/);
        return m ? `${m[1].padStart(2, "0")}:${m[2]}` : String(t || "");
      }

      /* Optional SignalR (n·∫øu backend b·∫≠t) */
      async function ensureSignalR() {
        if (window.signalR) return;
        await new Promise((res, rej) => {
          const s = document.createElement("script");
          s.src =
            "https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.5/dist/browser/signalr.min.js";
          s.onload = res;
          s.onerror = () => rej(new Error("Kh√¥ng load ƒë∆∞·ª£c SignalR client"));
          document.head.appendChild(s);
        });
      }
      async function connectSeatHub(maSuat) {
        try {
          await ensureSignalR();
        } catch (e) {
          console.warn("SignalR kh√¥ng kh·∫£ d·ª•ng:", e);
          return;
        }
        if (seatHub) {
          try {
            await seatHub.stop();
          } catch {}
          seatHub = null;
        }
        seatHub = new signalR.HubConnectionBuilder()
          .withUrl(`${BASE_URL.replace(/\/+$/, "")}/seatHub`, {
            accessTokenFactory: () => token() || "",
          })
          .withAutomaticReconnect()
          .build();

        seatHub.on("SeatsSnapshot", async (list) => {
          if (String(maSuat) !== String(currentSuatId)) return;
          const grid = $("#seatGrid");
          if (!grid) return;
          grid.innerHTML = "";
          seatEls.clear();
          seatMeta.clear();
          (list || []).forEach((g) => renderSeat(grid, g, maSuat));
          await hydrateHeldByMe(maSuat);
        });
        seatHub.on("SeatUpdated", (p) => {
          applySeatState({
            maSuat: normalizeId(p.maSuat ?? p.MaSuat),
            maGhe: normalizeId(p.maGhe ?? p.MaGhe),
            trangThai: (p.trangThai ?? p.TrangThai ?? "").trim(),
            holderUserId: getHolderRaw(p),
          });
        });
        seatHub.onreconnected(async () => {
          try {
            if (currentSuatId)
              await seatHub.invoke("JoinShowtime", parseInt(currentSuatId, 10));
            try {
              await seatHub.invoke(
                "RequestSnapshot",
                parseInt(currentSuatId, 10)
              );
            } catch {}
          } catch {}
        });
        try {
          await seatHub.start();
          await seatHub.invoke("JoinShowtime", parseInt(maSuat, 10));
          try {
            await seatHub.invoke("RequestSnapshot", parseInt(maSuat, 10));
          } catch {}
        } catch (e) {
          console.warn("SeatHub start l·ªói:", e);
        }
      }

      function applySeatState({ maSuat, maGhe, trangThai, holderUserId }) {
        const id = normalizeId(maGhe);
        if (id == null) return;
        if (String(maSuat) !== String(currentSuatId || "")) return;
        const el = seatEls.get(id);
        if (!el) return;

        const tstate = (trangThai || "").trim();
        const holderRaw = getHolderRaw({ holderUserId });
        const isMine =
          heldByMe.has(id) ||
          (holderRaw &&
            currentUserIdRaw &&
            String(holderRaw) === String(currentUserIdRaw));

        el.classList.remove("booked", "selected", "pending");
        el.style.pointerEvents = "auto";
        el.dataset.state = tstate || "Trong";
        el.dataset.holderRaw = holderRaw ? String(holderRaw) : "";
        el.dataset.suat = String(maSuat);

        if (tstate === "" || tstate === "Trong") {
          if (heldByMe.has(id)) {
            markSelected(el);
            selectedSeatIds.add(id);
          } else {
            selectedSeatIds.delete(id);
            delete selectedVeIds[id];
            delete seatPrices[id];
            markFree(el);
          }
          el.onclick = () => toggleSeat(el, id, normalizeId(maSuat));
          renderSeatSummary();
          return;
        }
        if (tstate === "TamGiu") {
          if (isMine) {
            markSelected(el);
            selectedSeatIds.add(id);
            el.onclick = () => toggleSeat(el, id, normalizeId(maSuat));
            renderSeatSummary();
          } else {
            markBooked(el);
            el.onclick = null;
          }
          return;
        }
        if (tstate === "DaDat") {
          markBooked(el);
          el.onclick = null;
          selectedSeatIds.delete(id);
          delete selectedVeIds[id];
          delete seatPrices[id];
          renderSeatSummary();
        }
      }

      function renderSeat(grid, ghe, suatId) {
        const div = document.createElement("div");
        div.className = "seat";
        div.textContent = ghe.soGhe || ghe.tenGhe || "(?)";
        const maGhe = normalizeId(ghe.maGhe ?? ghe.maGheId ?? ghe.id);
        if (maGhe == null) return;
        div.setAttribute("data-id", String(maGhe));
        div.dataset.suat = String(suatId);
        grid.appendChild(div);
        seatEls.set(maGhe, div);
        seatMeta.set(maGhe, parseSeatLabel(ghe.soGhe || ghe.tenGhe || ""));
        applySeatState({
          maSuat: suatId,
          maGhe,
          trangThai: (ghe.trangThai ?? ghe.TrangThai ?? "").trim(),
          holderUserId: getHolderRaw(ghe),
        });
        div.onclick = () => toggleSeat(div, maGhe, normalizeId(suatId));
      }

      function validateNoLonelySeatOnClient(trySeatId, suatIdOverride) {
        const currentSuat = String(suatIdOverride ?? currentSuatId ?? "");
        const t = seatMeta.get(trySeatId);
        if (!t || !t.row || !Number.isInteger(t.num) || t.num <= 0) return true;

        const rowItems = [];
        for (const [id, m] of seatMeta.entries()) {
          if (!m || m.row !== t.row || !Number.isInteger(m.num) || m.num <= 0)
            continue;
          const el = seatEls.get(id);
          if (!el) continue;
          const sameSuat =
            !el.dataset?.suat || String(el.dataset.suat) === currentSuat;
          if (sameSuat) rowItems.push({ id, n: m.num, el });
        }
        if (!rowItems.length) return true;
        rowItems.sort((a, b) => a.n - b.n);
        const byN = new Map(rowItems.map((x) => [x.n, x]));
        const minN = rowItems[0].n,
          maxN = rowItems[rowItems.length - 1].n;

        const isHard = (n) => {
          const it = byN.get(n);
          return it
            ? it.el.classList.contains("booked") ||
                it.el.dataset.state === "TamGiu"
            : false;
        };
        const isSoftNow = (n) => {
          const it = byN.get(n);
          return it ? selectedSeatIds.has(it.id) : false;
        };
        const isAnyNow = (n) => isHard(n) || isSoftNow(n);
        const isFreeNow = (n) => byN.has(n) && !isAnyNow(n);

        let L = t.num,
          R = t.num;
        while (isFreeNow(L - 1)) L--;
        while (isFreeNow(R + 1)) R++;

        // c·ª•m 2 gh·∫ø gi·ªØa hai gh·∫ø ƒë√£ chi·∫øm ‚Üí h·ª£p l·ªá
        if (
          R - L + 1 === 2 &&
          byN.has(L - 1) &&
          isAnyNow(L - 1) &&
          byN.has(R + 1) &&
          isAnyNow(R + 1)
        )
          return true;

        const isSoftAfter = (n) => {
          const it = byN.get(n);
          if (!it) return false;
          const now = selectedSeatIds.has(it.id);
          return it.id === trySeatId ? !now : now;
        };
        const isAnyAfter = (n) => isHard(n) || isSoftAfter(n);
        const isFreeAfter = (n) => byN.has(n) && !isAnyAfter(n);
        const allAnyFromTo = (a, b) => {
          if (a > b) [a, b] = [b, a];
          for (let k = a; k <= b; k++) {
            if (!byN.has(k)) continue;
            if (!isAnyAfter(k)) return false;
          }
          return true;
        };

        for (const { n } of rowItems) {
          if (!isFreeAfter(n)) continue;
          const hasLeft = byN.has(n - 1),
            hasRight = byN.has(n + 1);
          const leftAny = hasLeft && isAnyAfter(n - 1),
            rightAny = hasRight && isAnyAfter(n + 1);
          if (hasLeft && hasRight && leftAny && rightAny)
            throw new Error(
              tt("Msg_NoLonelySeat_Specific", { seat: `${t.row}${n}` })
            );
          if (!hasLeft && rightAny) {
            const allInsideAny = allAnyFromTo(n + 1, maxN);
            if (!allInsideAny && !(byN.has(n + 2) && isHard(n + 2)))
              throw new Error(
                tt("Msg_NoLonelySeat_Specific", { seat: `${t.row}${n}` })
              );
          }
          if (!hasRight && leftAny) {
            const allInsideAny = allAnyFromTo(minN, n - 1);
            if (!allInsideAny && !(byN.has(n - 2) && isHard(n - 2)))
              throw new Error(
                tt("Msg_NoLonelySeat_Specific", { seat: `${t.row}${n}` })
              );
          }
        }
        return true;
      }

      async function postJson(url, body, opt = {}) {
        const r = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...(opt.headers || {}),
          },
          body: body == null ? null : JSON.stringify(body),
          signal: opt.signal,
        });
        let d = null;
        try {
          d = await r.json();
        } catch {}
        if (!r.ok || d?.status === false)
          throw new Error(d?.message || `HTTP ${r.status}`);
        return d ?? { status: true };
      }
      async function getJson(url, opt = {}) {
        const r = await fetch(url, opt);
        let d = null;
        try {
          d = await r.json();
        } catch {}
        if (!r.ok || d?.status === false)
          throw new Error(d?.message || `HTTP ${r.status}`);
        return d;
      }

      async function toggleSeat(div, maGhe, maSuat) {
        if (!token()) {
          alert("‚ö†Ô∏è " + t("Msg_LoginRequired"));
          return;
        }
        const seatId = normalizeId(maGhe),
          suatId = normalizeId(maSuat);
        if (seatId == null || suatId == null) return;

        const isSelected = div.classList.contains("selected");
        if (!isSelected && selectedSeatIds.size >= 8) {
          alert("‚ö†Ô∏è " + tt("Msg_MaxSeatsReached", { max: 8 }));
          return;
        }

        if (!isSelected) {
          try {
            validateNoLonelySeatOnClient(seatId, suatId);
          } catch (err) {
            div.classList.add("invalid");
            setTimeout(() => div.classList.remove("invalid"), 600);
            alert(err?.message || t("Msg_NoLonelySeat_Generic"));
            return;
          }
        }

        div.classList.add("pending");
        try {
          if (isSelected) {
            await postJson(
              `${BASE_URL}/api/ve/release`,
              { maGhe: seatId, maSuat: suatId },
              { headers: authHeaders() }
            );
            selectedSeatIds.delete(seatId);
            heldByMe.delete(seatId);
            delete selectedVeIds[seatId];
            delete seatPrices[seatId];
            markFree(div);
            div.onclick = () => toggleSeat(div, seatId, suatId);
            renderSeatSummary();
            return;
          }
          const resp = await postJson(
            `${BASE_URL}/api/ve/hold`,
            { maGhe: seatId, maSuat: suatId },
            { headers: authHeaders() }
          );
          const ve = resp?.data || {};
          selectedSeatIds.add(seatId);
          heldByMe.add(seatId);
          if (ve.maVe != null) selectedVeIds[seatId] = ve.maVe;
          if (ve.giaVe != null) seatPrices[seatId] = parseInt(ve.giaVe, 10);
          else {
            try {
              const gia = await getJson(
                `${BASE_URL}/api/ve/tinh-gia-ve?maGhe=${seatId}&maSuat=${suatId}&_=${Date.now()}`,
                { headers: authHeaders() }
              );
              if (gia?.data?.giaCuoiCung != null)
                seatPrices[seatId] = parseInt(gia.data.giaCuoiCung, 10);
            } catch {
              seatPrices[seatId] = seatPrices[seatId] || 0;
            }
          }
          markSelected(div);
          div.dataset.holderRaw = String(currentUserIdRaw || "");
          div.onclick = () => toggleSeat(div, seatId, suatId);
          renderSeatSummary();
        } catch (e) {
          console.error("Hold seat l·ªói:", e);
          const msg = e?.message ? String(e.message) : "";
          const isRule = /l[e√™] gh[e·∫ø]|lonely\s*seat|quy t[ƒÉa]c/i.test(msg);
          const isTaken = /gh[e·∫ø].*(gi[u·ªØ]|ƒë[aƒÉ]t)|reserved|occupied/i.test(
            msg
          );
          if (isRule) {
            markFree(div);
            alert(msg || t("Msg_NoLonelySeat_Generic"));
          } else if (isTaken) {
            markBooked(div);
            alert(msg || t("Msg_SeatTaken"));
          } else {
            alert(msg || t("Msg_HoldFailed_Generic"));
          }
        } finally {
          div.classList.remove("pending");
        }
      }

      function calcSeatSum() {
        return Object.values(seatPrices).reduce(
          (t, p) => t + (parseInt(p || 0, 10) || 0),
          0
        );
      }
      function renderSeatSummary() {
        const bd = $("#breakdown");
        if (bd) {
          bd.innerHTML = [...selectedSeatIds]
            .map((id) => {
              const label = seatEls.get(id)?.textContent?.trim() || `#${id}`;
              const priceText = `${numberVN(seatPrices[id] || 0)}ƒë`;
              return `ü™ë ${tt("Seat_ItemBreakdown_Format", {
                label,
                price: priceText,
              })}`;
            })
            .join("<br>");
        }
        const total = $("#total");
        if (total) total.textContent = numberVN(calcSeatSum()) + "ƒë";
        updateNextButton();
        persistProgress(); // v·∫´n l∆∞u ti·∫øn ƒë·ªô trong khi ch·ªçn
      }

      // ‚úÖ H√ÄM FLUSH CHU·∫®N: CH·ªàNH L∆ØU ƒê√öNG D·ªÆ LI·ªÜU KHI NH·∫§N "TI·∫æP ‚Äî B·∫ÆP N∆Ø·ªöC"
      function flushSeatsToLocalStorageForCombo() {
        const seatIds = [...selectedSeatIds];
        const seatLabels = seatIds.map(
          (id) => seatEls.get(id)?.textContent?.trim() || `#${id}`
        );
        const seatVeIdsCopy = { ...selectedVeIds };
        const seatPricesCopy = { ...seatPrices };
        const seatTotal = calcSeatSum();
        const flow = getFlow();
        setFlow({
          // kh√≥a ch√≠nh cho b∆∞·ªõc combo
          seatIds,
          seatLabels,
          seatVeIds: seatVeIdsCopy,
          seatPrices: seatPricesCopy,
          seatTotal,
          seatCount: seatIds.length,
          // gi·ªØ meta suat/phim (n·∫øu c√≥)
          suatId: flow?.suatId ?? currentSuatId ?? null,
          phimId: flow?.phimId ?? flow?.movie?.id ?? null,
          // t·ªïng t·∫°m t√≠nh ƒëem sang trang combo
          tempTotal: seatTotal,
        });
      }

      function persistProgress() {
        // l∆∞u m·ªÅm khi ch·ªçn ƒë·ªÉ back/refresh kh√¥ng m·∫•t, nh∆∞ng v·∫´n flush l·∫°i m·ªôt l·∫ßn n·ªØa khi nh·∫•n Next
        const seatIds = [...selectedSeatIds];
        const seatCodes = seatIds.map(
          (id) => seatEls.get(id)?.textContent?.trim() || `#${id}`
        );
        const subtotal = calcSeatSum();
        setFlow({
          seatIds: seatIds,
          seatLabels: seatCodes,
          seatVeIds: selectedVeIds,
          seatPrices: seatPrices,
          seatTotal: subtotal,
          seatCount: seatIds.length,
          holderUserId: currentUserIdRaw || null,
        });
      }

      async function loadSeatsForRoom(maSuat, maPhong) {
        const grid = $("#seatGrid");
        if (!grid) return;
        grid.innerHTML = `<div class="loading">${t("Loading_Seats")}</div>`;
        currentSuatId = String(maSuat);
        currentPhongId = Number(maPhong);
        seatEls.clear();
        seatMeta.clear();
        selectedSeatIds.clear();
        heldByMe.clear();
        Object.keys(selectedVeIds).forEach((k) => delete selectedVeIds[k]);
        Object.keys(seatPrices).forEach((k) => delete seatPrices[k]);
        renderSeatSummary();

        connectSeatHub(maSuat).catch((err) =>
          console.error("SeatHub error:", err)
        );

        if (httpAbort) {
          try {
            httpAbort.abort();
          } catch {}
        }
        httpAbort = new AbortController();
        const myToken = ++viewToken;

        const url = `${BASE_URL}/api/ghe/get-trang-thai?maPhong=${maPhong}&maSuat=${maSuat}&_=${Date.now()}`;
        getJson(url, { headers: authHeaders(), signal: httpAbort.signal })
          .then(async (res) => {
            if (viewToken !== myToken) return;
            grid.innerHTML = "";
            seatEls.clear();
            seatMeta.clear();
            const list = Array.isArray(res?.data)
              ? res.data
              : Array.isArray(res)
              ? res
              : [];
            if (!list.length) {
              grid.innerHTML = `<p style="color:#ff6b6b;text-align:center;padding:40px;">‚ùå ${t(
                "Seat_Error_NoSeats"
              )}</p>`;
              return;
            }
            list.forEach((ghe) => renderSeat(grid, ghe, maSuat));
            await hydrateHeldByMe(maSuat);
          })
          .catch((err) => {
            if (err?.name === "AbortError") return;
            console.error("L·ªói khi l·∫•y gh·∫ø:", err);
            grid.innerHTML = `<p style="color:#ff6b6b;text-align:center;padding:40px;">‚ùå ${t(
              "Seat_Error_Server"
            )}</p>`;
          })
          .finally(() => {
            httpAbort = null;
          });
      }

      async function loadMovieSummary(phimId, suatObj) {
        try {
          const res = await getJson(API_MOVIE_BY_ID(phimId));
          const movie = res?.data || res || {};
          const posterRaw = movie?.poster || movie?.anh || movie?.banner || "";
          const posterUrl =
            absUrl(posterRaw) || "../../assets/images/default-poster.jpg";
          const title = movie?.tenPhim || "(Phim)";
          const roomName = suatObj?.tenPhong || suatObj?.TenPhong || "";
          const rapName = suatObj?.tenRap || suatObj?.TenRap || "";
          const gioRaw = suatObj?.gioChieu || suatObj?.GioChieu || "";
          const ngayRaw = suatObj?.ngayChieu || suatObj?.NgayChieu || "";
          const ngayChieu = normDate(ngayRaw),
            gioChieu = normTime(gioRaw);

          $("#moviePoster").style.backgroundImage = `url('${posterUrl}')`;
          $("#movieTitle").textContent = title;
          $("#movieMeta").textContent =
            `${rapName ? rapName : ""}${
              roomName ? (rapName ? " ‚Ä¢ " : "") + "Ph√≤ng " + roomName : ""
            }` +
            `${ngayChieu || gioChieu ? " ‚Ä¢ " : ""}${ngayChieu || ""}${
              gioChieu ? " " + gioChieu : ""
            }`;

          setFlow({
            movie: {
              id: movie?.maPhim ?? movie?.id ?? phimId ?? null,
              tenPhim: title,
              posterUrl,
              rapTen: rapName || null,
              phongTen: roomName || null,
              rapId: currentRapId ?? null,
              phongId: currentPhongId ?? null,
              ngayChieu,
              gioChieu,
            },
          });
        } catch (e) {
          console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c phim:", e);
          document.querySelector(
            "#moviePoster"
          ).style.backgroundImage = `url('../../assets/images/default-poster.jpg')`;
        }
      }

      async function hydrateHeldByMe(suatId) {
        if (!token() || !currentUserIdRaw) return;
        try {
          const res = await getJson(API_HELD_BY_ME(suatId), {
            headers: authHeaders(),
          });
          const list = Array.isArray(res?.data)
            ? res.data
            : Array.isArray(res)
            ? res
            : [];
          for (const it of list) {
            const id = normalizeId(it.maGhe ?? it.MaGhe);
            if (id == null) continue;
            const el = seatEls.get(id);
            if (!el) continue;
            heldByMe.add(id);
            el.dataset.state = "TamGiu";
            el.dataset.holderRaw = String(currentUserIdRaw);
            markSelected(el);
            selectedSeatIds.add(id);
            if (seatPrices[id] == null) {
              try {
                const gia = await getJson(
                  `${BASE_URL}/api/ve/tinh-gia-ve?maGhe=${id}&maSuat=${suatId}&_=${Date.now()}`,
                  { headers: authHeaders() }
                );
                const p = gia?.data?.giaCuoiCung;
                if (p != null) seatPrices[id] = parseInt(p, 10);
              } catch {}
            }
          }
          renderSeatSummary();
        } catch (e) {
          console.warn("hydrateHeldByMe error:", e);
        }
      }

      /* ============ INCLUDE HEADER/FOOTER & INIT ============ */
      async function includeHTML(id, file) {
        try {
          const res = await fetch(file, { cache: "no-store" });
          const html = await res.text();
          const host = document.getElementById(id);
          if (host) {
            host.innerHTML = html;
            applyI18nToDom(host);
          }
          if (id === "include-header") {
            window.dispatchEvent(new CustomEvent("header:loaded"));
          }
        } catch (e) {
          console.error("includeHTML error:", e);
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await i18nLoad(curAlias);
        applyI18nToDom(document);
        await includeHTML("include-header", "../../part/header.html");
        await includeHTML("include-footer", "../../part/footer.html");

        currentUserIdRaw = getUserIdFromToken(token());

        const qs = new URLSearchParams(location.search);
        const urlPhimId = normalizeId(qs.get("phimId"));
        const urlSuatId = normalizeId(qs.get("suatId"));
        const flow = getFlow();
        const phimId = urlPhimId ?? normalizeId(flow.phimId);
        const suatId = urlSuatId ?? normalizeId(flow.suatId);

        if (!phimId || !suatId) {
          alert(t("Msg_MissingShowtime"));
          location.href = "select-showtime.html";
          return;
        }

        // L·∫•y su·∫•t chi·∫øu ƒë·ªÉ suy ra r·∫°p/ph√≤ng
        let list = [];
        try {
          const suatRes = await getJson(
            `${BASE_URL}/api/suatchieu/get-by-phim/${phimId}?_=${Date.now()}`
          );
          list = Array.isArray(suatRes?.data)
            ? suatRes.data
            : Array.isArray(suatRes)
            ? suatRes
            : [];
        } catch (e) {
          console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c suatchieu, ti·∫øp t·ª•c:", e);
        }

        const found = list.find(
          (x) => normalizeId(x.maSuat ?? x.MaSuat) === suatId
        );
        if (!found) {
          alert(t("Msg_ShowtimeNotFound"));
          location.href = "select-showtime.html";
          return;
        }

        currentRapId = normalizeId(found.maRap ?? found.MaRap);
        currentRapName = found.tenRap ?? found.TenRap ?? null;
        currentPhongId = normalizeId(found.maPhong ?? found.MaPhong);
        currentPhongName = found.tenPhong ?? found.TenPhong ?? null;

        setFlow({
          phimId,
          suatId,
          rapId: currentRapId,
          rapName: currentRapName,
          roomId: currentPhongId,
          roomName: currentPhongName,
        });

        const initNgay = found?.ngayChieu || found?.NgayChieu || "";
        const initGio = found?.gioChieu || found?.GioChieu || "";
        setFlow({
          movie: {
            ...(getFlow().movie || {}),
            id: phimId,
            rapTen: currentRapName || null,
            phongTen: currentPhongName || null,
            rapId: currentRapId ?? null,
            phongId: currentPhongId ?? null,
            ngayChieu: normDate(initNgay),
            gioChieu: normTime(initGio),
          },
        });

        loadMovieSummary(phimId, found).catch(() => {});
        await loadSeatsForRoom(suatId, currentPhongId);

        // NEXT ‚Üí flush chu·∫©n v√†o LocalStorage r·ªìi sang trang combo
        const nextBtn = $("#nextBtn");
        if (nextBtn) {
          nextBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (selectedSeatIds.size === 0) return;
            // Ghi chu·∫©n v√†o localStorage ngay th·ªùi ƒëi·ªÉm nh·∫•n Next
            flushSeatsToLocalStorageForCombo();
            // ƒêi·ªÅu h∆∞·ªõng
            location.href = "select-combo.html";
          });
        }

        // v·ªÅ Home th√¨ clear flow
        const homeBtn = document.getElementById("homeBtn");
        if (homeBtn) {
          homeBtn.addEventListener(
            "click",
            () => {
              clearFlow();
            },
            { capture: true }
          );
        }
        bindClearOnIndexLinks(document);
        setTimeout(() => bindClearOnIndexLinks(document), 300);
      });
    </script>
  </body>
</html>
