<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title data-i18n="Checkout_Page_Title">CineTicket ‚Ä¢ Thanh to√°n</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="../../assets/css/Phim.css" />

    <style>
      :root {
        --header-h: 72px;
        --buy: #22e3a2;
        --buy-2: #12c48b;
        --border: rgba(255, 255, 255, 0.12);
      }
      html {
        scroll-padding-top: var(--header-h);
      }
      .site-header {
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.9);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .site-header .nav.container {
        margin: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
        padding-inline: clamp(14px, 4vw, 28px) !important;
        height: var(--header-h);
        min-height: var(--header-h);
      }
      .site-header .nav.shell {
        display: flex;
        align-items: center;
        justify-content: space-between;
        column-gap: 24px;
        height: var(--header-h);
        min-height: var(--header-h);
        width: 100%;
        padding-inline: clamp(14px, 4vw, 28px);
      }
      #header-spacer {
        height: 0 !important;
      }
      .site-header .nav-links {
        overflow: visible !important;
      }

      .container {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 18px;
      }
      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 16px;
      }
      .header-row h2 {
        margin: 0;
        font-size: 1.8rem;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        backdrop-filter: blur(12px);
        margin-bottom: 12px;
      }
      .movie-info {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 16px;
        padding: 16px;
        margin-bottom: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
      }
      .movie-poster {
        width: 120px;
        height: 160px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid var(--border);
      }
      .movie-details h3 {
        margin: 0 0 12px 0;
        font-size: 1.4em;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .movie-meta {
        color: #cbd5e1;
        font-size: 0.92em;
        line-height: 1.6;
      }
      .movie-meta p {
        margin: 4px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .divider {
        height: 1px;
        background: var(--border);
        margin: 16px 0;
      }
      .summary-item {
        border-bottom: 1px dashed var(--border);
        padding: 12px 0;
      }
      .summary-item:last-child {
        border: none;
      }
      .item-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 12px;
      }
      .total-row {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--buy);
        margin-top: 16px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        background: var(--buy);
        color: #0b1b14;
        font-weight: 700;
        cursor: pointer;
        transition: 0.15s;
      }
      .btn:hover {
        background: var(--buy-2);
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }
      .btn[disabled] {
        opacity: 0.6;
        pointer-events: none;
      }
      .btn.is-loading {
        position: relative;
      }
      .btn.is-loading::after {
        content: "";
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid rgba(0, 0, 0, 0.25);
        border-top-color: #0b1b14;
        margin-left: 8px;
        display: inline-block;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .pay-methods {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }
      .pm {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }
      .pm input {
        accent-color: var(--buy);
      }

      /* ===== Coupon UI ===== */
      .coupon-row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .coupon-input {
        flex: 1;
        min-width: 240px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.03);
        color: #e2e8f0;
      }
      .coupon-apply {
        padding: 10px 16px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        cursor: pointer;
      }
      .coupon-note {
        color: #a7f3d0;
        font-size: 0.9em;
        margin-top: 8px;
      }
      .coupon-error {
        color: #fecaca;
        font-size: 0.9em;
        margin-top: 8px;
      }
      .coupon-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(34, 227, 162, 0.15);
        border: 1px solid rgba(34, 227, 162, 0.35);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.9em;
      }
      .coupon-remove {
        cursor: pointer;
        opacity: 0.8;
      }
      .coupon-remove:hover {
        opacity: 1;
        text-decoration: underline;
      }
      .price-strike {
        text-decoration: line-through;
        opacity: 0.7;
      }
    </style>
  </head>

  <body>
    <div id="include-header"></div>
    <div id="header-spacer"></div>

    <div class="container">
      <div class="header-row">
        <h2 id="checkout-heading" data-i18n="Checkout_Heading">
          üí≥ Thanh to√°n
        </h2>
      </div>

      <div class="card">
        <div id="orderSummary"><!-- JS render --></div>
      </div>

      <!-- M√É KHUY·∫æN M√ÉI -->
      <div class="card" id="couponCard">
        <h3 style="margin-top: 0" data-i18n="Checkout_Coupon_Heading">
          M√£ khuy·∫øn m√£i
        </h3>
        <div class="coupon-row">
          <input
            id="couponInput"
            class="coupon-input"
            placeholder="Nh·∫≠p m√£..."
          />
          <button id="couponBtn" class="coupon-apply" type="button">
            √Åp m√£
          </button>
          <span id="couponChip" class="coupon-chip" style="display: none">
            <span id="couponCodeText"></span>
            <span class="coupon-remove" id="couponRemove">g·ª°</span>
          </span>
        </div>
        <div id="couponMsg" class="coupon-note" style="display: none"></div>
        <div id="couponErr" class="coupon-error" style="display: none"></div>
      </div>

      <!-- C·ªîNG THANH TO√ÅN -->
      <div class="card">
        <h3
          id="pm-heading"
          style="margin-top: 0"
          data-i18n="Checkout_Methods_Heading"
        >
          Ph∆∞∆°ng th·ª©c thanh to√°n
        </h3>
        <div class="pay-methods">
          <label class="pm"
            ><input type="radio" name="pm" value="momo" checked /><span
              >MoMo</span
            ></label
          >
          <label class="pm"
            ><input type="radio" name="pm" value="vnpay" /><span
              >VNPAY</span
            ></label
          >
        </div>
      </div>

      <div class="card" style="text-align: right">
        <button class="btn btn-book">üéü Thanh to√°n ngay</button>
      </div>
    </div>

    <div id="include-footer"></div>

    <script defer src="../../assets/js/login.js"></script>
    <script>
      // =================== CONFIG ===================
      const BASE_URL = "https://localhost:7058";
      const LS_KEY = "BOOKING_FLOW";
      const $ = (s, r = document) => r.querySelector(s);
      const numberVN = (n) => {
        try {
          return Number(n).toLocaleString("vi-VN");
        } catch {
          return n;
        }
      };
      const token = () => localStorage.getItem("token");
      const authHeaders = () =>
        token() ? { Authorization: "Bearer " + token() } : {};

      // =================== I18N ===================
      const CULT = { vi: "vi", en: "en", fr: "fr" };
      function pickInitialLang() {
        const q = new URLSearchParams(location.search).get("lang");
        const s = localStorage.getItem("lang") || localStorage.getItem("CULT");
        return CULT[q] ? q : CULT[s] ? s : "vi";
      }
      let curAlias = pickInitialLang();
      const I18N_CACHE = {};
      const LOCAL_FALLBACKS = {
        vi: {
          Checkout_Methods_Heading: "Ph∆∞∆°ng th·ª©c thanh to√°n",
          Checkout_PayWith_MoMo: "Thanh to√°n MoMo",
          Checkout_PayWith_Vnpay: "Thanh to√°n VNPAY",
          Checkout_Coupon_Heading: "M√£ khuy·∫øn m√£i",
          Coupon_Applied: "ƒê√£ √°p d·ª•ng m√£ {code}. Gi·∫£m {off}ƒë.",
          Coupon_Removed: "ƒê√£ g·ª° m√£ khuy·∫øn m√£i.",
          Coupon_Invalid: "M√£ kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ d√πng.",
          Coupon_TotalAfter: "T·ªïng sau gi·∫£m",
          Coupon_Discount: "Gi·∫£m gi√°",
          Coupon_Valid_Preview: "M√£ h·ª£p l·ªá: {code}. D·ª± ki·∫øn gi·∫£m {off}ƒë.",
          Checkout_SelectedTickets_Heading: "V√© ƒë√£ ch·ªçn",
          Checkout_Combo_Heading: "Combo",
          Checkout_TotalToPay_Label: "T·ªïng thanh to√°n",
          BN_Summary_None: "Kh√¥ng ch·ªçn combo",
          Label_Cinema: "R·∫°p",
          Label_Room: "Ph√≤ng",
          Label_Showtime: "Su·∫•t chi·∫øu",
          Loading_Processing: "ƒêang x·ª≠ l√Ω‚Ä¶",
          Btn_Retry: "Th·ª≠ l·∫°i",
          Auth_Login_Required: "Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi thanh to√°n.",
          Error_Missing_Session: "Thi·∫øu th√¥ng tin su·∫•t chi·∫øu.",
          Error_Missing_ShowtimeInfo: "Thi·∫øu th√¥ng tin su·∫•t chi·∫øu.",
          Msg_MustSelectSeatFirst: "B·∫°n ch∆∞a ch·ªçn gh·∫ø.",
          Error_NoInvoiceId: "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c m√£ h√≥a ƒë∆°n.",
          Error_InvalidAmount: "S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá.",
          Error_Booking_Generic: "Kh√¥ng th·ªÉ ƒë·∫∑t v√©.",
        },
        en: {
          Checkout_Methods_Heading: "Payment methods",
          Checkout_PayWith_MoMo: "Pay with MoMo",
          Checkout_PayWith_Vnpay: "Pay with VNPAY",
          Checkout_Coupon_Heading: "Promo code",
          Coupon_Applied: "Applied {code}. Discount {off}ƒë.",
          Coupon_Removed: "Promo removed.",
          Coupon_Invalid: "Code invalid or already used.",
          Coupon_TotalAfter: "Total after discount",
          Coupon_Discount: "Discount",
          Coupon_Valid_Preview:
            "Valid code: {code}. Estimated discount {off}ƒë.",
          Checkout_SelectedTickets_Heading: "Selected tickets",
          Checkout_Combo_Heading: "Combo",
          Checkout_TotalToPay_Label: "Total to pay",
          BN_Summary_None: "No combos",
          Label_Cinema: "Cinema",
          Label_Room: "Room",
          Label_Showtime: "Showtime",
          Loading_Processing: "Processing‚Ä¶",
          Btn_Retry: "Retry",
          Auth_Login_Required: "Please log in to pay.",
          Error_Missing_Session: "Missing session.",
          Error_Missing_ShowtimeInfo: "Missing showtime info.",
          Msg_MustSelectSeatFirst: "Select seats first.",
          Error_NoInvoiceId: "No invoice id.",
          Error_InvalidAmount: "Invalid amount.",
          Error_Booking_Generic: "Booking failed.",
        },
        fr: {
          Checkout_Methods_Heading: "Moyens de paiement",
          Checkout_PayWith_MoMo: "Payer avec MoMo",
          Checkout_PayWith_Vnpay: "Payer avec VNPAY",
          Checkout_Coupon_Heading: "Code promo",
          Coupon_Applied: "Code {code} appliqu√©. Remise {off}ƒë.",
          Coupon_Removed: "Code promo supprim√©.",
          Coupon_Invalid: "Code invalide ou d√©j√† utilis√©.",
          Coupon_TotalAfter: "Total apr√®s remise",
          Coupon_Discount: "Remise",
          Coupon_Valid_Preview: "Code valide : {code}. Remise estim√©e {off}ƒë.",
          Checkout_SelectedTickets_Heading: "Billets choisis",
          Checkout_Combo_Heading: "Combo",
          Checkout_TotalToPay_Label: "Total √† payer",
          BN_Summary_None: "Aucun combo",
          Label_Cinema: "Cin√©ma",
          Label_Room: "Salle",
          Label_Showtime: "S√©ance",
          Loading_Processing: "Traitement‚Ä¶",
          Btn_Retry: "R√©essayer",
          Auth_Login_Required: "Veuillez vous connecter.",
          Error_Missing_Session: "S√©ance manquante.",
          Error_Missing_ShowtimeInfo: "Infos s√©ance manquantes.",
          Msg_MustSelectSeatFirst: "S√©lectionnez les si√®ges.",
          Error_NoInvoiceId: "Pas d'ID facture.",
          Error_InvalidAmount: "Montant invalide.",
          Error_Booking_Generic: "√âchec de r√©servation.",
        },
      };
      async function i18nLoad(alias) {
        const a = CULT[alias] ? alias : "vi";
        if (I18N_CACHE[a]) return I18N_CACHE[a];
        try {
          const url = new URL(`${BASE_URL}/api/i18n`);
          url.searchParams.set("lang", a);
          url.searchParams.set("_", Date.now());
          const res = await fetch(url, {
            credentials: "include",
            cache: "no-store",
            headers: { "Accept-Language": a },
          });
          const dict = res.ok ? await res.json() : {};
          I18N_CACHE[a] = dict && typeof dict === "object" ? dict : {};
        } catch {
          I18N_CACHE[a] = {};
        }
        return I18N_CACHE[a];
      }
      function t(key, vars) {
        let s = (I18N_CACHE[curAlias] || {})[key];
        if (typeof s !== "string") {
          s = (LOCAL_FALLBACKS[curAlias] || {})[key];
          if (typeof s !== "string") s = key;
        }
        if (vars && typeof vars === "object")
          for (const [k, v] of Object.entries(vars))
            s = s.replaceAll(`{${k}}`, v);
        return s;
      }
      function applyI18nToDom(root = document) {
        root.querySelectorAll("[data-i18n]").forEach((el) => {
          const k = el.getAttribute("data-i18n");
          if (k) el.textContent = t(k);
        });
        const titleEl = document.querySelector("title[data-i18n]");
        if (titleEl) document.title = t(titleEl.getAttribute("data-i18n"));
        document.documentElement.lang = curAlias;
      }
      async function setLang(alias) {
        curAlias = CULT[alias] ? alias : "vi";
        localStorage.setItem("lang", curAlias);
        localStorage.setItem("CULT", curAlias);
        try {
          await fetch(
            `${BASE_URL}/api/ping?lang=${encodeURIComponent(
              curAlias
            )}&t=${Date.now()}`,
            { credentials: "include", cache: "no-store" }
          );
        } catch {}
        await i18nLoad(curAlias);
        applyI18nToDom(document);
        renderOrderSummary(getFlow());
        const u = new URL(location.href);
        u.searchParams.set("lang", curAlias);
        history.replaceState({}, "", u.toString());
        const btn = document.querySelector(".btn-book");
        if (btn && !btn.classList.contains("is-loading"))
          btn.textContent = labelByGateway(currentGateway());
      }
      document.addEventListener("click", (e) => {
        const langLink = e.target.closest("[data-set-lang]");
        if (!langLink) return;
        e.preventDefault();
        setLang(langLink.getAttribute("data-set-lang"));
      });

      // =================== include header/footer ===================
      async function includeHTML(id, file) {
        try {
          const html = await fetch(`${file}?t=${Date.now()}`, {
            cache: "no-store",
          }).then((r) => r.text());
          const host = document.getElementById(id);
          if (host) host.innerHTML = html;
          applyI18nToDom(host || document);
          if (
            id === "include-header" &&
            typeof updateAuthButtons === "function"
          )
            setTimeout(updateAuthButtons, 80);
        } catch (e) {
          console.error("includeHTML error:", e);
        }
      }

      // =================== FLOW STORAGE ===================
      const getFlow = () => {
        try {
          return JSON.parse(localStorage.getItem(LS_KEY) || "{}");
        } catch {
          return {};
        }
      };
      const setFlow = (p) => {
        const cur = getFlow();
        localStorage.setItem(LS_KEY, JSON.stringify({ ...cur, ...(p || {}) }));
      };

      // =================== TOTALS ===================
      function ensureTotals(flow) {
        const seatsSubtotal = Number(flow?.seatTotal ?? 0);
        const comboTotal = Number(flow?.comboTotal ?? 0);
        const tempTotal = Number(flow?.tempTotal ?? seatsSubtotal + comboTotal);
        return { seatsSubtotal, comboTotal, tempTotal };
      }

      // =================== N√öT: STATES ===================
      function btnLabelFor(state) {
        const m = {
          creatingInvoice: (I18N_CACHE[curAlias] || {})[
            "Loading_CreatingInvoice"
          ],
          creatingPayment: (I18N_CACHE[curAlias] || {})[
            "Loading_CreatingPayment"
          ],
          redirecting: (I18N_CACHE[curAlias] || {})["Loading_Redirecting"],
        };
        if (state === "error") return t("Btn_Retry");
        if (state === "idle" || state === "ready")
          return labelByGateway(currentGateway());
        return m[state] || t("Loading_Processing");
      }
      function setBtnState(state) {
        const btn = document.querySelector(".btn-book");
        if (!btn) return;
        const waiting =
          state === "creatingInvoice" ||
          state === "creatingPayment" ||
          state === "redirecting";
        btn.textContent = btnLabelFor(state);
        btn.disabled = waiting;
        btn.classList.toggle("is-loading", waiting);
      }

      // =================== COUPON HELPERS ===================
      function currentBaseTotal(flow) {
        const { tempTotal } = ensureTotals(flow);
        return Math.max(0, Number(tempTotal || 0));
      }

      async function validateCouponOnServer(code, amount) {
        const res = await fetch(`${BASE_URL}/api/khuyenmai/apply`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify({
            code: String(code || "").trim(),
            amount: Math.round(Number(amount || 0)),
          }),
        });
        let data = null;
        try {
          data = await res.json();
        } catch {}
        if (!res.ok || data?.status === false)
          throw new Error(data?.message || t("Coupon_Invalid"));
        const d = data?.data ?? data;
        const discount = Number(d.giam ?? d.discount ?? 0);
        const final = Number(
          d.tongSauGiam ?? d.finalAmount ?? amount - discount
        );
        return {
          code: (d.code || code || "").toString().trim(),
          loaiGiam: d.loaiGiam || d.kind || null,
          mucGiam: Number(d.mucGiam ?? d.value ?? 0),
          discount,
          final,
          khuyenMaiId: d.khuyenMaiId ?? null,
          khuyenMaiCodeId: d.khuyenMaiCodeId ?? null,
          note: d.note || "",
        };
      }

      function showCouponState(okMsg, errMsg) {
        const msgEl = $("#couponMsg"),
          errEl = $("#couponErr");
        if (okMsg) {
          msgEl.textContent = okMsg;
          msgEl.style.display = "block";
        } else {
          msgEl.style.display = "none";
          msgEl.textContent = "";
        }
        if (errMsg) {
          errEl.textContent = errMsg;
          errEl.style.display = "block";
        } else {
          errEl.style.display = "none";
          errEl.textContent = "";
        }
      }

      // --- t√≠nh gi·∫£m local ph·ª•c v·ª• preview ---
      function computeDiscount(kind, value, amount) {
        const k = String(kind || "").toLowerCase();
        const v = Number(value || 0);
        const base = Math.max(0, Number(amount || 0));
        if (k === "percent") {
          const d = Math.round(base * (v / 100));
          return Math.max(0, Math.min(d, base));
        }
        return Math.max(0, Math.min(v, base));
      }

      // --- Preview m√£ b·∫±ng GET /khuyenmai/validate (kh√¥ng ghi v√†o flow) ---
      let _lastPreviewReqId = 0;
      async function previewCoupon(code) {
        code = (code || "").trim();
        if (!code) {
          showCouponState(null, null);
          return;
        }
        const reqId = ++_lastPreviewReqId;

        try {
          const url = new URL(`${BASE_URL}/api/khuyenmai/validate`);
          url.searchParams.set("code", code);
          const res = await fetch(url.toString(), {
            headers: { ...authHeaders() },
            cache: "no-store",
            credentials: "include",
          });
          let j = null;
          try {
            j = await res.json();
          } catch {}

          if (reqId !== _lastPreviewReqId) return;

          if (!res.ok || !j || j.status === false || !j.data) {
            showCouponState(null, t("Coupon_Invalid"));
            return;
          }

          const d = j.data; // { loaiGiam, mucGiam, code, ... }
          const base = currentBaseTotal(getFlow());
          const discount = computeDiscount(d.loaiGiam, d.mucGiam, base);

          showCouponState(
            t("Coupon_Valid_Preview", {
              code: d.code || code,
              off: numberVN(discount),
            }),
            null
          );
        } catch {
          if (reqId !== _lastPreviewReqId) return;
          showCouponState(null, t("Coupon_Invalid"));
        }
      }

      let applyingCoupon = false;
      async function onApplyCoupon() {
        if (applyingCoupon) return;
        const code = ($("#couponInput")?.value || "").trim();
        if (!code) {
          showCouponState(null, t("Coupon_Invalid"));
          return;
        }
        applyingCoupon = true;
        const btn = $("#couponBtn");
        if (btn) {
          btn.disabled = true;
          btn.textContent = "ƒêang √°p‚Ä¶";
        }
        try {
          const flow = getFlow();
          const base = currentBaseTotal(flow);
          const applied = await validateCouponOnServer(code, base);
          setFlow({ coupon: applied });
          $("#couponCodeText").textContent = applied.code;
          $("#couponChip").style.display = "inline-flex";
          showCouponState(
            t("Coupon_Applied", {
              code: applied.code,
              off: numberVN(applied.discount),
            }),
            null
          );
          renderOrderSummary(getFlow());
        } catch (e) {
          showCouponState(null, e?.message || t("Coupon_Invalid"));
        } finally {
          applyingCoupon = false;
          if (btn) {
            btn.disabled = false;
            btn.textContent = "√Åp m√£";
          }
        }
      }

      function onRemoveCoupon() {
        const f = getFlow();
        delete f.coupon;
        localStorage.setItem(LS_KEY, JSON.stringify(f));
        $("#couponChip").style.display = "none";
        showCouponState(t("Coupon_Removed"), null);
        renderOrderSummary(getFlow());
      }

      // =================== RENDER SUMMARY ===================
      function renderOrderSummary(flow) {
        const movie = flow?.movie || {};
        const { seatsSubtotal, comboTotal, tempTotal } = ensureTotals(flow);

        const poster =
          movie.posterUrl || "../../assets/images/default-poster.jpg";
        const tenPhim = movie.tenPhim || "(?)";
        const rap = movie.rapTen || flow?.rapName || "";
        const phong = movie.phongTen || flow?.roomName || "";
        const ngay = movie.ngayChieu || "";
        const gio = movie.gioChieu || "";
        const seatLabels = Array.isArray(flow?.seatLabels)
          ? flow.seatLabels.join(", ")
          : "‚Äî";

        const comboItems = Array.isArray(flow?.comboItems)
          ? flow.comboItems
          : [];
        const comboRows = comboItems.length
          ? comboItems
              .map(
                (it) => `
              <div class="item-row">
                <div>${it.tenBn || "Combo #" + it.maBn} √ó ${it.qty | 0}</div>
                <div>${numberVN(
                  (it.qty | 0) * (parseInt(it.gia || 0, 10) || 0)
                )}ƒë</div>
              </div>`
              )
              .join("")
          : `<div class="item-row"><div>${t(
              "BN_Summary_None"
            )}</div><div>0ƒë</div></div>`;

        const coupon = flow?.coupon;
        const baseTotal = Number(tempTotal || 0);
        const discount = Math.min(Number(coupon?.discount || 0), baseTotal);
        const finalPay =
          discount > 0
            ? Math.max(0, Number(coupon?.final ?? baseTotal - discount))
            : baseTotal;

        if (coupon?.code) {
          $("#couponCodeText").textContent = coupon.code;
          $("#couponChip").style.display = "inline-flex";
        }

        $("#orderSummary").innerHTML = `
          <div class="movie-info">
            <img class="movie-poster" src="${poster}" alt="${tenPhim}">
            <div class="movie-details">
              <h3>${tenPhim}</h3>
              <div class="movie-meta">
                <p>üé≠ ${t("Label_Cinema")}: ${rap || "‚Äî"}</p>
                <p>üèõ ${t("Label_Room")}: ${phong || "‚Äî"}</p>
                <p>üé¨ ${t("Label_Showtime")}: ${ngay || ""} ${gio || ""}</p>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="summary-item">
            <h3>${t("Checkout_SelectedTickets_Heading")}</h3>
            <div class="item-row"><div>${seatLabels}</div><div>${numberVN(
          seatsSubtotal
        )}ƒë</div></div>
          </div>

          <div class="summary-item">
            <h3>${t("Checkout_Combo_Heading")}</h3>
            ${comboRows}
          </div>

          <div class="total-row">
            ${
              discount > 0
                ? `
                <div class="item-row"><div>${t(
                  "Checkout_TotalToPay_Label"
                )}:</div><div class="price-strike">${numberVN(
                    baseTotal
                  )}ƒë</div></div>
                <div class="item-row"><div>${t("Coupon_Discount")} (${
                    coupon.code
                  }):</div><div>-${numberVN(discount)}ƒë</div></div>
                <div class="item-row"><div>${t(
                  "Coupon_TotalAfter"
                )}:</div><div>${numberVN(finalPay)}ƒë</div></div>
              `
                : `<div class="item-row"><div>${t(
                    "Checkout_TotalToPay_Label"
                  )}:</div><div>${numberVN(baseTotal)}ƒë</div></div>`
            }
          </div>
        `;
      }

      // =================== INVOICE (Backend) ===================
      async function createInvoiceOnServer(flow) {
        const maSuat = flow?.suatId;
        const seatIds = Array.isArray(flow?.seatIds)
          ? flow.seatIds.map(Number)
          : [];
        const seatVeIds = flow?.seatVeIds || {}; // { maGhe: maVe }
        if (!maSuat) throw new Error(t("Error_Missing_Session"));
        if (!seatIds.length) throw new Error(t("Msg_MustSelectSeatFirst"));

        const veLines = [];
        for (const seatId of seatIds) {
          const veId = seatVeIds?.[seatId];
          if (veId != null) veLines.push({ maVe: Number(veId), soLuong: 1 });
        }
        const useVePath =
          veLines.length > 0 && veLines.length === seatIds.length;

        const bnLines = [];
        const comboItems = Array.isArray(flow?.comboItems)
          ? flow.comboItems
          : [];
        for (const item of comboItems) {
          const maBn = Number(item.maBn);
          const soLuong = Number(item.qty || 0);
          if (maBn && soLuong > 0) bnLines.push({ maBn, soLuong });
        }

        let bapNuocId = null,
          soLuongBapNuoc = 0;
        if (bnLines.length === 1) {
          bapNuocId = bnLines[0].maBn;
          soLuongBapNuoc = bnLines[0].soLuong;
        }

        const body = {
          maSuat: Number(maSuat),
          seatIds: useVePath ? [] : seatIds,
          bapNuocId,
          soLuongBapNuoc,
          chiTietHoaDons: [...veLines, ...bnLines],
          ghiChu: "ƒê·∫∑t v√© qua website",
          hinhThucThanhToan: "Momo",
          // truy·ªÅn coupon code ƒë·ªÉ BE √°p d·ª•ng khi t·∫°o h√≥a ƒë∆°n
          couponCode: flow?.coupon?.code || undefined,
        };

        const res = await fetch(`${BASE_URL}/api/hoadon/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(body),
        });
        let data = null;
        try {
          data = await res.json();
        } catch {}
        if (!res.ok || data?.status === false)
          throw new Error(data?.message || `HTTP ${res.status}`);
        const d = data?.data ?? data;

        return {
          maHd: d.maHd ?? d.MaHd ?? d.id ?? d.orderId,
          amount: Math.round(Number(d.tongTien ?? d.amount ?? 0)),
          orderInfo:
            d.orderInfo ||
            t("Payment_OrderInfo_Tpl", { orderId: d.maHd ?? d.id ?? "" }),
          fullName: d.tenKhachHang || d.fullName || t("User_Default_FullName"),
        };
      }

      // =================== PAYMENT ===================
      async function createMomoPayment({
        orderId,
        amount,
        orderInfo,
        fullName,
      }) {
        const body = {
          orderId: String(orderId),
          amount: Math.round(Number(amount || 0)),
          orderInfo: orderInfo || t("Payment_OrderInfo_Tpl", { orderId }),
          fullName: fullName || t("User_Default_FullName"),
        };
        const res = await fetch(`${BASE_URL}/api/momopayment/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(body),
        });
        let data = null;
        try {
          data = await res.json();
        } catch {}
        if (!res.ok || data?.status === false)
          throw new Error(data?.message || `HTTP ${res.status}`);
        const url = data?.payUrl || data?.shortLink || data?.deeplink;
        if (!url) throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c payUrl t·ª´ MoMo.");
        return url;
      }
      async function createVnpayPayment({ amount, orderInfo }) {
        const locale = curAlias === "en" ? "en" : "vn";
        const body = {
          amount: Math.round(Number(amount || 0)),
          orderDescription:
            orderInfo || t("Payment_OrderInfo_Tpl", { orderId: "" }),
          orderType: "other",
          locale,
        };
        const res = await fetch(`${BASE_URL}/api/payments/vnpay/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...authHeaders() },
          body: JSON.stringify(body),
        });
        let data = null;
        try {
          data = await res.json();
        } catch {}
        if (!res.ok || !data || !data.url)
          throw new Error(
            (data && (data.message || data.error)) || `HTTP ${res.status}`
          );
        return data.url;
      }

      // =================== Gateway choose ===================
      function currentGateway() {
        const el = document.querySelector('input[name="pm"]:checked');
        return el ? el.value : "momo";
      }
      function labelByGateway(gw) {
        return gw === "vnpay"
          ? t("Checkout_PayWith_Vnpay")
          : t("Checkout_PayWith_MoMo");
      }
      document.addEventListener("change", (e) => {
        if (!e.target.matches('input[name="pm"]')) return;
        const btn = document.querySelector(".btn-book");
        if (btn && !btn.classList.contains("is-loading"))
          btn.textContent = labelByGateway(currentGateway());
      });

      // =================== BOOK (Hƒê -> Gateway) ===================
      let bookingInFlight = false;
      async function bookTicket() {
        if (bookingInFlight) return;
        bookingInFlight = true;
        try {
          if (!token()) throw new Error(t("Auth_Login_Required"));
          const flow = getFlow();
          if (!flow?.suatId) throw new Error(t("Error_Missing_Session"));
          if (!Array.isArray(flow?.seatIds) || !flow.seatIds.length)
            throw new Error(t("Msg_MustSelectSeatFirst"));

          const { seatsSubtotal, comboTotal } = ensureTotals(flow);
          if (!flow?.tempTotal)
            setFlow({ tempTotal: seatsSubtotal + comboTotal });

          setBtnState("creatingInvoice");
          const invoice = await createInvoiceOnServer(getFlow());
          if (!invoice?.maHd) throw new Error(t("Error_NoInvoiceId"));
          if (!invoice?.amount || invoice.amount <= 0)
            throw new Error(t("Error_InvalidAmount"));

          const gw = currentGateway();
          setBtnState("creatingPayment");
          let payUrl = "";
          if (gw === "vnpay") {
            payUrl = await createVnpayPayment({
              amount: invoice.amount,
              orderInfo:
                invoice.orderInfo ||
                t("Payment_OrderInfo_Tpl", { orderId: invoice.maHd }),
            });
          } else {
            payUrl = await createMomoPayment({
              orderId: String(invoice.maHd),
              amount: invoice.amount,
              orderInfo:
                invoice.orderInfo ||
                t("Payment_OrderInfo_Tpl", { orderId: invoice.maHd }),
              fullName: invoice.fullName,
            });
          }
          setBtnState("redirecting");
          location.href = payUrl;
        } catch (err) {
          alert(err?.message || t("Error_Booking_Generic"));
          setBtnState("error");
        } finally {
          bookingInFlight = false;
        }
      }

      // =================== CLEAR FLOW khi click nav ===================
      function bindHeaderNavFlowClear() {
        const host = document.getElementById("include-header");
        if (!host) return;
        host.addEventListener(
          "click",
          (e) => {
            const el = e.target.closest("a,button");
            if (!el) return;
            if (el.matches(".dropdown-toggle,[data-set-lang]")) return;
            if (!el.closest(".site-header")) return;
            if (e.ctrlKey || e.metaKey || e.shiftKey || e.button === 1) return;
            try {
              localStorage.removeItem(LS_KEY);
            } catch {}
          },
          true
        );
      }

      // =================== BOOT ===================
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await i18nLoad(curAlias);
        } catch (e) {
          console.error("i18n load failed", e);
        }
        applyI18nToDom(document);

        await includeHTML("include-header", "../../part/header.html");
        await includeHTML("include-footer", "../../part/footer.html");
        bindHeaderNavFlowClear();

        const flow = getFlow();
        if (!flow?.suatId) {
          alert(t("Error_Missing_ShowtimeInfo"));
          location.href = "select-showtime.html";
          return;
        }
        if (!Array.isArray(flow?.seatIds) || !flow.seatIds.length) {
          alert(t("Msg_MustSelectSeatFirst"));
          location.href = "select-seats.html";
          return;
        }

        // coupon events
        const btnApply = $("#couponBtn");
        if (btnApply) btnApply.addEventListener("click", onApplyCoupon);
        const input = $("#couponInput");
        if (input)
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") onApplyCoupon();
          });
        const rm = $("#couponRemove");
        if (rm) rm.addEventListener("click", onRemoveCoupon);

        // auto-preview khi g√µ + blur
        if (input) {
          let debounceId;
          input.addEventListener("input", () => {
            clearTimeout(debounceId);
            const val = input.value.trim();
            debounceId = setTimeout(() => previewCoupon(val), 350);
          });
          input.addEventListener("blur", () => {
            previewCoupon(input.value.trim());
          });
        }

        renderOrderSummary(flow);

        const bookBtn = document.querySelector(".btn-book");
        if (bookBtn && !bookBtn.dataset.bound) {
          bookBtn.addEventListener("click", () => {
            if (!bookBtn.disabled) bookTicket();
          });
          bookBtn.dataset.bound = "1";
        }
        setBtnState("idle");
        const btn = document.querySelector(".btn-book");
        if (btn) btn.textContent = labelByGateway(currentGateway());
      });
    </script>
  </body>
</html>
