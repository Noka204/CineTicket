<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-i18n="Login_Page_Title">CineTicket • Đăng nhập</title>

    <!-- CSS chung toàn site (header/footer, tokens) -->
    <link rel="stylesheet" href="../../assets/css/Phim.css" />
    <!-- CSS riêng cho login nếu bạn tách file -->
    <link rel="stylesheet" href="../../assets/css/login.css" />

    <style>
      :root {
        --header-h: 72px;
        --accent: #34d399;
        --accent-2: #10b981;
        --text: #e5e7eb;
        --muted: #a8b3cf;
        --bg: #0b1224;
        --card: #131b2e;
        --border: rgba(255, 255, 255, 0.12);
        --ring: rgba(52, 211, 153, 0.2);
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: Segoe UI, Tahoma, Arial, sans-serif;
        color: var(--text);
        background: radial-gradient(
            1000px 500px at 10% -10%,
            rgba(52, 211, 153, 0.1),
            transparent 60%
          ),
          radial-gradient(
            800px 500px at 90% 110%,
            rgba(16, 185, 129, 0.08),
            transparent 60%
          ),
          #0f172a;
      }
      a {
        color: var(--accent);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      #include-header {
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      #include-footer {
        margin-top: 40px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
      }
      .auth-wrap {
        min-height: calc(100vh - var(--header-h, 72px));
        display: grid;
        place-items: center;
        padding: 24px 12px;
      }
      .auth-grid {
        width: 100%;
        display: grid;
        grid-template-columns: minmax(380px, 560px);
        justify-content: center;
        gap: 36px;
      }
      @media (min-width: 1024px) {
        .auth-grid {
          grid-template-columns: minmax(420px, 560px) 520px;
        }
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(19, 27, 46, 0.88),
          rgba(12, 18, 36, 0.88)
        );
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 28px 24px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
      }
      .card h1 {
        margin: 0 0 8px 0;
        font-size: 1.8rem;
        letter-spacing: 0.2px;
      }
      .muted {
        color: var(--muted);
        font-size: 0.98rem;
        margin-bottom: 18px;
      }

      form {
        display: grid;
        gap: 14px;
      }
      .field {
        display: grid;
        gap: 6px;
      }
      .field label {
        font-weight: 600;
        font-size: 0.95rem;
      }
      .input {
        position: relative;
      }
      .input input {
        width: 100%;
        height: 46px;
        padding: 0 44px 0 12px;
        border-radius: 12px;
        color: var(--text);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        outline: none;
        transition: box-shadow 0.2s, border-color 0.2s, background-color 0.2s;
      }
      .input input::placeholder {
        color: rgba(255, 255, 255, 0.45);
      }
      .input input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px var(--ring);
        background-color: rgba(255, 255, 255, 0.08);
      }

      /* Nút icon con mắt */
      .icon-btn {
        position: absolute;
        right: 6px;
        top: 6px;
        height: 34px;
        width: 38px;
        display: grid;
        place-items: center;
        color: var(--text);
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 8px;
        cursor: pointer;
      }
      .icon-btn svg {
        width: 18px;
        height: 18px;
        display: block;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin: 6px 0 16px 0;
      }
      .row .left {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 14px;
        gap: 8px;
        height: 46px;
        font-weight: 700;
        letter-spacing: 0.2px;
        color: #071b12;
        background: linear-gradient(180deg, var(--accent), var(--accent-2));
        border: 1px solid var(--accent-2);
        border-radius: 12px;
        cursor: pointer;
        transition: filter 0.15s, transform 0.02s;
      }
      .btn:hover {
        filter: brightness(1.05);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-outline {
        color: var(--text);
        background: transparent;
        border: 1px solid var(--border);
      }
      .btn-ghost {
        color: var(--text);
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }
      .actions .btn {
        flex: 1;
      }

      .alert {
        display: none;
        margin-top: 12px;
        padding: 12px;
        border-radius: 12px;
        font-size: 0.96rem;
      }
      .alert.error {
        background: #3b0f16;
        color: #ffd0d5;
        border: 1px solid #8a2531;
      }
      .alert.success {
        background: #082e24;
        color: #b6ffe7;
        border: 1px solid #0f5d49;
      }

      #loginAside {
        display: none;
        padding: 24px;
        border-radius: 16px;
        background: linear-gradient(
          180deg,
          rgba(52, 211, 153, 0.1),
          rgba(16, 185, 129, 0.06)
        );
        border: 1px solid rgba(52, 211, 153, 0.2);
      }
      #loginAside h2 {
        margin: 0 0 12px 0;
      }
      #loginAside p {
        margin: 0 0 10px 0;
        color: var(--muted);
      }
      @media (min-width: 1024px) {
        #loginAside {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <div id="include-header"></div>

    <main class="container">
      <div class="auth-wrap">
        <div class="auth-grid">
          <!-- FORM -->
          <section class="card" aria-label="Đăng nhập">
            <h1 data-i18n="Login_Title">Đăng nhập</h1>
            <p class="muted" data-i18n="Login_Subtitle">
              Vui lòng nhập thông tin để tiếp tục
            </p>

            <form id="loginForm" novalidate>
              <div class="field">
                <label for="username" data-i18n="Login_Username_Label"
                  >Tên đăng nhập</label
                >
                <div class="input">
                  <input
                    id="username"
                    name="username"
                    type="text"
                    inputmode="text"
                    placeholder="vd: nhatminh"
                    autocomplete="username"
                    required
                    minlength="4"
                    maxlength="50"
                  />
                </div>
              </div>

              <div class="field">
                <label for="password" data-i18n="Login_Password_Label"
                  >Mật khẩu</label
                >
                <div class="input">
                  <input
                    id="password"
                    name="password"
                    type="password"
                    placeholder="********"
                    autocomplete="current-password"
                    required
                    minlength="6"
                    maxlength="100"
                  />
                  <!-- Nút icon con mắt -->
                  <button
                    type="button"
                    id="togglePw"
                    class="icon-btn"
                    aria-pressed="false"
                  >
                    <span class="sr-only">Hiện/ẩn mật khẩu</span>
                    <svg
                      id="iconPw"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <!-- mặc định: eye -->
                      <path
                        d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"
                      ></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="row">
                <label class="left">
                  <input type="checkbox" id="remember" />
                  <span data-i18n="Login_RememberMe">Ghi nhớ tôi</span>
                </label>
                <a href="forgot-password.html" data-i18n="Login_Forgot"
                  >Quên mật khẩu?</a
                >
              </div>

              <button
                id="submitBtn"
                type="submit"
                class="btn"
                data-i18n="Login_Submit"
              >
                Đăng nhập
              </button>
              <div id="message" class="alert" role="alert"></div>

              <div class="actions">
                <a
                  class="btn btn-outline"
                  href="register.html"
                  data-i18n="Login_Register"
                  >Tạo tài khoản</a
                >
                <a
                  class="btn btn-ghost"
                  href="../Phim/index.html"
                  data-i18n="Login_BackHome"
                  >Về trang phim</a
                >
              </div>
            </form>
          </section>

          <!-- ASIDE (hiển thị khi màn hình rộng) -->
          <aside class="card" id="loginAside">
            <h2 data-i18n="Login_Aside_Title">Trải nghiệm CineTicket</h2>
            <p>
              CineTicket là nền tảng đặt vé xem phim trực tuyến tiện lợi, cho
              phép người dùng chọn ghế theo thời gian thực, thanh toán nhanh qua
              MoMo hoặc VNPAY, lưu lịch sử giao dịch và nhận hóa đơn qua email.
            </p>
          </aside>
        </div>
      </div>
    </main>

    <div id="include-footer"></div>

    <script>
      "use strict";

      /* ================= ENV & I18N ================= */
      const BASE_URL = "https://localhost:7058";
      const CULT = { vi: "vi-VN", en: "en-US", fr: "fr-FR" };
      let curAlias = localStorage.getItem("lang") || "vi";
      const I18N_CACHE = {};

      async function i18nLoad(alias) {
        const a = CULT[alias] ? alias : "vi";
        if (I18N_CACHE[a]) return I18N_CACHE[a];
        try {
          const url = new URL(BASE_URL + "/api/i18n");
          url.searchParams.set("lang", a);
          url.searchParams.set("_", Date.now());
          const res = await fetch(url, {
            credentials: "include",
            cache: "no-store",
          });
          if (!res.ok) throw 0;
          const dict = await res.json();
          I18N_CACHE[a] =
            dict && typeof dict === "object" && !Array.isArray(dict)
              ? dict
              : {};
        } catch {
          I18N_CACHE[a] = {};
        }
        return I18N_CACHE[a];
      }
      function t(key) {
        const pack = I18N_CACHE[curAlias] || {};
        const v = pack[key];
        return typeof v === "string" ? v : null;
      }
      function applyI18nToDom(root = document) {
        root.querySelectorAll("[data-i18n]").forEach((el) => {
          const k = el.getAttribute("data-i18n");
          const v = t(k);
          if (v != null) el.textContent = v;
        });
        const titleEl = document.querySelector("title[data-i18n]");
        if (titleEl) {
          const tv = t(titleEl.getAttribute("data-i18n"));
          if (tv != null) document.title = tv;
        }
        document.documentElement.lang = curAlias;
      }
      async function setLang(alias) {
        curAlias = CULT[alias] ? alias : "vi";
        localStorage.setItem("lang", curAlias);
        fetch(
          `${BASE_URL}/api/ping?lang=${encodeURIComponent(
            curAlias
          )}&_=${Date.now()}`,
          { credentials: "include", cache: "no-store" }
        ).catch(() => {});
        await i18nLoad(curAlias);
        applyI18nToDom(document);
      }

      /* ================= Include header/footer ================= */
      async function includeHTML(id, file) {
        try {
          const html = await fetch(file, { cache: "no-store" }).then((r) =>
            r.text()
          );
          const el = document.getElementById(id);
          if (el) el.innerHTML = html;
          applyI18nToDom(el || document);
          try {
            typeof updateAuthButtons === "function" && updateAuthButtons();
          } catch {}
        } catch (e) {
          console.error(e);
        }
      }

      /* ================= Helpers ================= */
      const $ = (s, r = document) => r.querySelector(s);
      function getQuery(k) {
        return new URLSearchParams(location.search).get(k);
      }
      function showMsg(type, text) {
        const box = $("#message");
        if (!box) return;
        box.className = "alert " + (type === "error" ? "error" : "success");
        box.textContent = text || "";
        box.style.display = text ? "block" : "none";
      }
      function validateUsername(u) {
        if (!u || u.length < 4 || u.length > 50) return false;
        return /^[A-Za-z0-9._@-]+$/.test(u);
      }
      function validatePassword(p) {
        return !!p && p.length >= 6 && p.length <= 100;
      }

      function base64UrlToUint8Array(base64Url) {
        const pad = "=".repeat((4 - (base64Url.length % 4)) % 4);
        const b64 = (base64Url + pad).replace(/-/g, "+").replace(/_/g, "/");
        const raw = atob(b64);
        const out = new Uint8Array(raw.length);
        for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
        return out;
      }
      function decodeJwt(token) {
        try {
          const payload = token.split(".")[1] || "";
          const bytes = base64UrlToUint8Array(payload);
          const json = new TextDecoder("utf-8").decode(bytes);
          return JSON.parse(json);
        } catch {
          return null;
        }
      }

      // Đổi icon eye/eye-off
      function setEyeIcon(svgEl, visible) {
        if (!svgEl) return;
        svgEl.innerHTML = visible
          ? // eye-off (đang hiển thị mật khẩu)
            '<path d="M3 3l18 18"></path><path d="M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42"></path><path d="M16.5 16.5C14.9 17.5 13.1 18 12 18 5 18 1 12 1 12a21.8 21.8 0 0 1 5.06-5.64"></path><path d="M9.88 4.24A10.9 10.9 0 0 1 12 4c7 0 11 8 11 8a21.7 21.7 0 0 1-3.17 3.73"></path>'
          : // eye (đang ẩn mật khẩu)
            '<path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"></path><circle cx="12" cy="12" r="3"></circle>';
      }

      /* ================= DOM Ready ================= */
      document.addEventListener("DOMContentLoaded", async () => {
        // Loại bỏ ký tự vô hình nếu có
        try {
          document.body.innerHTML = document.body.innerHTML.replace(
            /[\u200B-\u200D\uFEFF]/g,
            ""
          );
        } catch {}

        await i18nLoad(curAlias);
        applyI18nToDom(document);
        includeHTML("include-header", "../../part/header.html");
        includeHTML("include-footer", "../../part/footer.html");

        // Prefill username nếu đã nhớ
        const remembered = localStorage.getItem("remember_user") || "";
        if (remembered) {
          const u = $("#username"),
            r = $("#remember");
          if (u) u.value = remembered;
          if (r) r.checked = true;
        }

        // Toggle password với icon mắt
        const pwBtn = $("#togglePw");
        const pwSvg = $("#iconPw");
        const pwInp = $("#password");
        setEyeIcon(pwSvg, false); // mặc định: eye (ẩn mật khẩu)
        pwBtn.addEventListener("click", () => {
          const willShow = pwInp.type === "password"; // nếu đang ẩn -> sẽ hiện
          pwInp.type = willShow ? "text" : "password";
          pwBtn.setAttribute("aria-pressed", String(willShow));
          setEyeIcon(pwSvg, willShow);
          pwInp.focus();
        });

        // Submit
        const form = $("#loginForm");
        const btn = $("#submitBtn");
        let inflight = false;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          if (inflight) return;

          const username = ($("#username").value || "").trim();
          const password = $("#password").value || "";
          const remember = $("#remember").checked;

          if (!validateUsername(username)) {
            showMsg(
              "error",
              "Tên đăng nhập không hợp lệ. Dùng 4–50 ký tự: chữ, số, ., _, @, -"
            );
            return;
          }
          if (!validatePassword(password)) {
            showMsg("error", "Mật khẩu phải từ 6–100 ký tự.");
            return;
          }

          inflight = true;
          btn.disabled = true;
          const oldText = btn.textContent;
          btn.textContent = "Đang đăng nhập...";
          showMsg("success", "");

          try {
            const res = await fetch(`${BASE_URL}/api/Account/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userName: username, password }),
              cache: "no-store",
            });

            let result = null;
            try {
              result = await res.json();
            } catch {}

            if (!res.ok || !result || result.status === false) {
              const msg =
                (result && (result.message || result.error)) ||
                "Không thể đăng nhập. Vui lòng thử lại.";
              showMsg("error", msg);
            } else {
              const token = result.token || result.accessToken || "";
              if (!token) {
                showMsg("error", "Máy chủ không trả về token hợp lệ.");
              } else {
                // nhớ username
                if (remember) localStorage.setItem("remember_user", username);
                else localStorage.removeItem("remember_user");

                // lưu token
                try {
                  if (remember) localStorage.setItem("token", token);
                  else {
                    sessionStorage.setItem("token", token);
                    localStorage.removeItem("token");
                  }
                } catch {}

                // decode claims (nếu cần)
                const claims = decodeJwt(token) || {};
                try {
                  localStorage.setItem("claims", JSON.stringify(claims));
                } catch {}

                // cập nhật header nếu có
                try {
                  typeof updateAuthButtons === "function" &&
                    updateAuthButtons();
                } catch {}

                showMsg("success", "Đăng nhập thành công.");
                const returnUrl = getQuery("returnUrl");
                const target = returnUrl
                  ? decodeURIComponent(returnUrl)
                  : "../Phim/index.html";
                setTimeout(() => {
                  location.href = target;
                }, 400);
                return;
              }
            }
          } catch (err) {
            console.error(err);
            showMsg("error", "Lỗi mạng hoặc máy chủ không phản hồi.");
          } finally {
            inflight = false;
            btn.disabled = false;
            btn.textContent = oldText;
          }
        });
      });
    </script>
  </body>
</html>
